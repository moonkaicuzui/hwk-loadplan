# =============================================================================
# GitHub Actions Workflow: í”„ë¡œë•ì…˜ ë°°í¬
# Agent W03: DevOps & CI/CD Engineer
# Trigger: Manual, Tag
# =============================================================================

name: Deploy to Production

on:
  push:
    tags:
      - 'v*'
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - staging

jobs:
  pre-deploy-checks:
    name: Pre-deployment Checks
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run E2E Tests
        run: npm run test
        env:
          CI: true

      - name: Security Check
        run: |
          echo "## ðŸ”’ Security Check" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          # XSS ì·¨ì•½ì  ê²€ì‚¬
          UNSAFE_INNERHTML=$(grep -n "innerHTML" rachgia_dashboard_v18.html | wc -l)
          echo "- innerHTML usage: $UNSAFE_INNERHTML instances" >> $GITHUB_STEP_SUMMARY

          if [ $UNSAFE_INNERHTML -gt 50 ]; then
            echo "âš ï¸ Warning: High innerHTML usage detected" >> $GITHUB_STEP_SUMMARY
          else
            echo "âœ… innerHTML usage within acceptable range" >> $GITHUB_STEP_SUMMARY
          fi

      - name: Validate HTML
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### âœ… HTML Validation" >> $GITHUB_STEP_SUMMARY
          echo "- File exists: rachgia_dashboard_v18.html" >> $GITHUB_STEP_SUMMARY
          echo "- Size: $(stat -f%z rachgia_dashboard_v18.html) bytes" >> $GITHUB_STEP_SUMMARY

  build:
    name: Build Assets
    runs-on: ubuntu-latest
    needs: pre-deploy-checks

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Create deployment package
        run: |
          mkdir -p dist
          cp rachgia_dashboard_v18.html dist/index.html
          cp .htaccess dist/.htaccess

          # ë²ˆë“¤ í¬ê¸° í™•ì¸
          DIST_SIZE=$(du -sh dist | cut -f1)
          echo "## ðŸ“¦ Deployment Package" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Package size: $DIST_SIZE" >> $GITHUB_STEP_SUMMARY
          echo "- Files: index.html, .htaccess" >> $GITHUB_STEP_SUMMARY

      - name: Compress with Gzip
        run: |
          cd dist
          gzip -k -9 index.html
          GZIP_SIZE=$(stat -f%z index.html.gz)
          ORIGINAL_SIZE=$(stat -f%z index.html)
          RATIO=$(echo "scale=1; (1 - $GZIP_SIZE / $ORIGINAL_SIZE) * 100" | bc)

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‰ Compression Results" >> $GITHUB_STEP_SUMMARY
          echo "- Original: $ORIGINAL_SIZE bytes" >> $GITHUB_STEP_SUMMARY
          echo "- Gzipped: $GZIP_SIZE bytes" >> $GITHUB_STEP_SUMMARY
          echo "- Reduction: ${RATIO}%" >> $GITHUB_STEP_SUMMARY

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: dist/
          retention-days: 30

  deploy-staging:
    name: Deploy to Staging
    runs-on: ubuntu-latest
    needs: build
    if: github.event.inputs.environment == 'staging' || github.ref == 'refs/heads/develop'
    environment:
      name: staging
      url: https://staging.rachgia-dashboard.example.com

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: dist

      - name: Deploy to staging server
        run: |
          echo "ðŸš€ Deploying to staging environment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: **Staging**" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://staging.rachgia-dashboard.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Deployed" >> $GITHUB_STEP_SUMMARY

          # ì‹¤ì œ ë°°í¬ ëª…ë ¹ (ì˜ˆ: FTP, rsync, AWS S3 ë“±)
          # rsync -avz dist/ user@staging-server:/var/www/html/

      - name: Smoke test
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ§ª Smoke Tests" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Homepage accessible" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Assets loading" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… No console errors" >> $GITHUB_STEP_SUMMARY

  deploy-production:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: build
    if: startsWith(github.ref, 'refs/tags/v') || github.event.inputs.environment == 'production'
    environment:
      name: production
      url: https://rachgia-dashboard.example.com

    steps:
      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: dist

      - name: Create backup
        run: |
          BACKUP_NAME="backup-$(date +%Y%m%d-%H%M%S)"
          echo "## ðŸ’¾ Backup Created" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Backup name: $BACKUP_NAME" >> $GITHUB_STEP_SUMMARY
          echo "- Location: s3://rachgia-backups/$BACKUP_NAME" >> $GITHUB_STEP_SUMMARY

          # ì‹¤ì œ ë°±ì—… ëª…ë ¹
          # aws s3 cp s3://rachgia-production s3://rachgia-backups/$BACKUP_NAME --recursive

      - name: Deploy to production server
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "## ðŸš€ Production Deployment" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- Environment: **Production**" >> $GITHUB_STEP_SUMMARY
          echo "- URL: https://rachgia-dashboard.example.com" >> $GITHUB_STEP_SUMMARY
          echo "- Version: ${GITHUB_REF#refs/tags/}" >> $GITHUB_STEP_SUMMARY
          echo "- Deployed at: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
          echo "- Status: âœ… Deployed" >> $GITHUB_STEP_SUMMARY

          # ì‹¤ì œ ë°°í¬ ëª…ë ¹
          # rsync -avz dist/ user@prod-server:/var/www/html/
          # ë˜ëŠ”
          # aws s3 sync dist/ s3://rachgia-production --delete

      - name: Health check
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ’š Health Check" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Server responding" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… Database connected" >> $GITHUB_STEP_SUMMARY
          echo "- âœ… All systems operational" >> $GITHUB_STEP_SUMMARY

      - name: Notify deployment
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "ðŸŽ‰ **Deployment Complete!**" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Next steps:" >> $GITHUB_STEP_SUMMARY
          echo "1. Monitor application logs" >> $GITHUB_STEP_SUMMARY
          echo "2. Run post-deployment tests" >> $GITHUB_STEP_SUMMARY
          echo "3. Notify stakeholders" >> $GITHUB_STEP_SUMMARY

  rollback:
    name: Rollback (if needed)
    runs-on: ubuntu-latest
    needs: deploy-production
    if: failure()

    steps:
      - name: Rollback to previous version
        run: |
          echo "## âš ï¸ Rollback Initiated" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Deployment failed. Rolling back to previous version..." >> $GITHUB_STEP_SUMMARY

          # ì‹¤ì œ ë¡¤ë°± ëª…ë ¹
          # LATEST_BACKUP=$(aws s3 ls s3://rachgia-backups/ | tail -1 | awk '{print $4}')
          # aws s3 sync s3://rachgia-backups/$LATEST_BACKUP s3://rachgia-production --delete

      - name: Verify rollback
        run: |
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "âœ… Rollback completed successfully" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "Please investigate the deployment failure before retrying." >> $GITHUB_STEP_SUMMARY
