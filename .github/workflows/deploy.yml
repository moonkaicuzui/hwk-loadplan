# =============================================================================
# GitHub Actions Workflow: Google Drive â†’ ìžë™ ë¹Œë“œ â†’ Firebase ë°°í¬
# Rachgia Dashboard v19 - ì™„ì „ ìžë™í™” íŒŒì´í”„ë¼ì¸
# =============================================================================

name: Auto Build & Deploy

on:
  # ë§¤ì‹œê°„ ìžë™ ì‹¤í–‰
  schedule:
    - cron: '0 * * * *'

  # ìˆ˜ë™ ì‹¤í–‰
  workflow_dispatch:

env:
  NODE_VERSION: '18'
  PYTHON_VERSION: '3.11'

jobs:
  # ==========================================================================
  # 1ë‹¨ê³„: Google Driveì—ì„œ ë°ì´í„° ë‹¤ìš´ë¡œë“œ
  # ==========================================================================
  download-and-build:
    name: ðŸ“¥ Download & Build
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install dependencies
        run: |
          pip install google-auth google-auth-oauthlib google-api-python-client openpyxl pandas

      - name: Download Excel files from Google Drive
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python scripts/download_from_drive.py

      - name: Check data files
        id: check
        run: |
          if [ -d "data" ] && [ "$(ls -A data/*.xlsx 2>/dev/null)" ]; then
            echo "has_data=true" >> $GITHUB_OUTPUT
            ls -la data/
          else
            echo "has_data=false" >> $GITHUB_OUTPUT
            echo "âŒ ë°ì´í„° íŒŒì¼ ì—†ìŒ"
            exit 1
          fi

      - name: Embed data into HTML
        run: |
          python scripts/embed_data.py

          echo "## ðŸ“Š ë¹Œë“œ ê²°ê³¼" >> $GITHUB_STEP_SUMMARY
          DATA_COUNT=$(grep -o '"order_no"' rachgia_dashboard_v19.html | wc -l)
          echo "- ë ˆì½”ë“œ: **${DATA_COUNT}ê°œ**" >> $GITHUB_STEP_SUMMARY

      - name: Generate consolidated Excel & upload to Drive
        env:
          GOOGLE_SERVICE_ACCOUNT_KEY: ${{ secrets.GOOGLE_SERVICE_ACCOUNT_KEY }}
          GOOGLE_DRIVE_FOLDER_ID: ${{ secrets.GOOGLE_DRIVE_FOLDER_ID }}
        run: |
          python scripts/generate_consolidated.py

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      - name: Install npm dependencies
        run: npm ci

      - name: Create deployment package
        run: |
          mkdir -p dist
          cp rachgia_dashboard_v19.html dist/index.html
          cp manifest.json dist/
          cp sw.js dist/
          cp -r locales dist/
          cp -r icons dist/ 2>/dev/null || true
          cp -r src dist/ 2>/dev/null || true

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: deployment-package
          path: dist/
          retention-days: 7

  # ==========================================================================
  # 2ë‹¨ê³„: Firebase ë°°í¬
  # ==========================================================================
  deploy:
    name: ðŸš€ Deploy to Firebase
    runs-on: ubuntu-latest
    needs: download-and-build

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Download build artifacts
        uses: actions/download-artifact@v4
        with:
          name: deployment-package
          path: dist/

      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: qip-loadplan

      - name: Summary
        run: |
          echo "## ðŸŽ‰ ë°°í¬ ì™„ë£Œ!" >> $GITHUB_STEP_SUMMARY
          echo "- **URL**: https://qip-loadplan.web.app" >> $GITHUB_STEP_SUMMARY
          echo "- **ì‹œê°„**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> $GITHUB_STEP_SUMMARY
