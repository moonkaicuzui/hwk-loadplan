<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Content-Security-Policy" content="default-src 'self'; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://cdn.tailwindcss.com https://cdn.jsdelivr.net; style-src 'self' 'unsafe-inline' https://cdn.tailwindcss.com; img-src 'self' data: blob:; font-src 'self' data:;">
    <title>Rachgia Factory í†µí•© ìƒì‚°ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ v9</title>
    <meta name="description" content="Rachgia Factory A, B, C, D ê³µì¥ì˜ ìƒì‚° í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•˜ëŠ” í†µí•© ëŒ€ì‹œë³´ë“œ. BAL ë°ì´í„° ë¶„ì„, KPI ì¶”ì , ì§€ì—°/ê²½ê³  ê´€ë¦¬.">

    <!-- External Libraries -->
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        // Chart.js ë‹¤í¬ëª¨ë“œ ê¸°ë³¸ ì„¤ì •
        Chart.defaults.color = getComputedStyle(document.documentElement).getPropertyValue('--text-primary').trim() || '#1f2937';
        Chart.defaults.borderColor = getComputedStyle(document.documentElement).getPropertyValue('--border-color').trim() || '#e5e7eb';
    </script>
    <style>
        :root {
            --bg-primary: #f8fafc;
            --bg-secondary: #ffffff;
            --bg-card: #ffffff;
            --text-primary: #1f2937;
            --text-secondary: #6b7280;
            --border-color: #e5e7eb;
        }
        .dark {
            --bg-primary: #111827;
            --bg-secondary: #1f2937;
            --bg-card: #374151;
            --text-primary: #f9fafb;
            --text-secondary: #9ca3af;
            --border-color: #4b5563;
        }
        body { background: var(--bg-primary); color: var(--text-primary); transition: all 0.3s; }
        .bg-card { background: var(--bg-card); }
        .text-secondary { color: var(--text-secondary); }
        .border-theme { border-color: var(--border-color); }

        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .delay-highlight { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); animation: pulse-red 2s infinite; }
        .dark .delay-highlight { background: linear-gradient(135deg, #7f1d1d 0%, #991b1b 100%); }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.85; } }
        .warning-highlight { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .dark .warning-highlight { background: linear-gradient(135deg, #78350f 0%, #92400e 100%); }

        /* ì„ ì  ì™„ë£Œ PO ìŠ¤íƒ€ì¼ */
        .shipped-highlight {
            background: linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%);
            position: relative;
        }
        .dark .shipped-highlight {
            background: linear-gradient(135deg, #064e3b 0%, #065f46 100%);
        }
        .shipped-highlight td { color: #047857 !important; }
        .dark .shipped-highlight td { color: #6ee7b7 !important; }
        .shipped-badge {
            display: inline-flex;
            align-items: center;
            gap: 2px;
            padding: 2px 6px;
            background: #059669;
            color: white;
            border-radius: 9999px;
            font-size: 0.65rem;
            font-weight: 600;
        }
        .dark .shipped-badge { background: #10b981; }

        table th { position: sticky; top: 0; background: var(--bg-secondary); z-index: 10; }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: rgba(59, 130, 246, 0.1) !important; }
        .modal-overlay { background: rgba(0,0,0,0.6); backdrop-filter: blur(4px); }
        .progress-bar { height: 24px; border-radius: 12px; background: #e5e7eb; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .dark .progress-bar { background: #4b5563; }
        .progress-bar:hover { transform: scaleY(1.1); }
        .progress-fill { height: 100%; border-radius: 12px; transition: width 0.5s ease; }

        .filter-chip { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; margin: 2px; cursor: pointer; transition: all 0.2s; }
        .filter-chip.active { background-color: #3b82f6; color: white; }
        .filter-chip:not(.active) { background-color: #e5e7eb; color: #374151; }
        .dark .filter-chip:not(.active) { background-color: #4b5563; color: #e5e7eb; }

        .chart-container { position: relative; height: 300px; }

        /* Sortable headers - ì ‘ê·¼ì„± ê°œì„  */
        .sort-header { cursor: pointer; user-select: none; position: relative; }
        .sort-header:focus { outline: 2px solid #3b82f6; outline-offset: 2px; }

        /* Focus-visible for keyboard navigation */
        :focus-visible { outline: 2px solid #3b82f6; outline-offset: 2px; }
        button:focus:not(:focus-visible) { outline: none; }

        /* Screen reader only utility */
        .sr-only { position: absolute; width: 1px; height: 1px; padding: 0; margin: -1px; overflow: hidden; clip: rect(0, 0, 0, 0); white-space: nowrap; border: 0; }
        .sort-header:hover { background: rgba(59, 130, 246, 0.1); }
        .sort-header::after { content: 'â‡…'; margin-left: 4px; opacity: 0.3; font-size: 10px; }
        .sort-header.asc::after { content: 'â†‘'; opacity: 1; }
        .sort-header.desc::after { content: 'â†“'; opacity: 1; }

        .funnel-step { position: relative; text-align: center; padding: 8px; margin: 2px; border-radius: 4px; transition: all 0.2s; cursor: pointer; }
        .funnel-step:hover { transform: scale(1.02); }
        .bottleneck { animation: bottleneck-pulse 1.5s infinite; border: 2px solid #ef4444 !important; }
        @keyframes bottleneck-pulse { 0%, 100% { box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.4); } 50% { box-shadow: 0 0 0 8px rgba(239, 68, 68, 0); } }

        .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .calendar-day { width: 40px; height: 40px; display: flex; flex-direction: column; align-items: center; justify-content: center; border-radius: 8px; cursor: pointer; transition: all 0.2s; }
        .calendar-day:hover { background: rgba(59, 130, 246, 0.2); }
        .calendar-day.today { border: 2px solid #3b82f6; }
        .calendar-day.delayed { background: #fecaca; }
        .dark .calendar-day.delayed { background: #7f1d1d; }
        .calendar-day.warning { background: #fef3c7; }
        .dark .calendar-day.warning { background: #78350f; }

        .exec-kpi { font-size: 2.5rem; font-weight: 700; }

        /* Process timeline visual */
        .process-timeline { display: flex; align-items: center; gap: 4px; flex-wrap: wrap; }
        .process-step { display: flex; flex-direction: column; align-items: center; padding: 8px 12px; border-radius: 8px; min-width: 70px; }
        .process-step.completed { background: #dcfce7; border: 2px solid #22c55e; }
        .process-step.in-progress { background: #fef3c7; border: 2px solid #f59e0b; }
        .process-step.pending { background: #f3f4f6; border: 2px solid #d1d5db; }
        .dark .process-step.completed { background: #166534; border-color: #22c55e; }
        .dark .process-step.in-progress { background: #854d0e; border-color: #f59e0b; }
        .dark .process-step.pending { background: #374151; border-color: #6b7280; }
        .process-arrow { font-size: 20px; color: #9ca3af; }

        /* Date mode toggle */
        .date-mode-toggle { display: flex; border-radius: 8px; overflow: hidden; border: 2px solid #3b82f6; }
        .date-mode-btn { padding: 8px 16px; font-weight: 600; cursor: pointer; transition: all 0.2s; }
        .date-mode-btn.active { background: #3b82f6; color: white; }
        .date-mode-btn:not(.active) { background: transparent; color: #3b82f6; }
        .date-mode-btn:not(.active):hover { background: rgba(59, 130, 246, 0.1); }

        /* Heatmap styles */
        .heatmap-cell { padding: 4px 8px; text-align: center; font-size: 11px; min-width: 50px; }

        @media (max-width: 768px) { .chart-container { height: 250px; } }
        @media print { .no-print { display: none !important; } body { font-size: 12px; } }

        .kbd { display: inline-block; padding: 2px 6px; font-size: 11px; background: #e5e7eb; border-radius: 4px; font-family: monospace; }
        .dark .kbd { background: #4b5563; }

        /* Watched PO Styles */
        .watched-po-card {
            background: linear-gradient(135deg, #f0f9ff 0%, #e0f2fe 100%);
            border: 2px solid #0ea5e9;
            border-radius: 12px;
            padding: 16px;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        .dark .watched-po-card {
            background: linear-gradient(135deg, #0c4a6e 0%, #075985 100%);
        }
        .watched-po-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(14, 165, 233, 0.3);
        }
        .watched-po-card.alert {
            background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%);
            border-color: #f59e0b;
            animation: alert-pulse 2s infinite;
        }
        .dark .watched-po-card.alert {
            background: linear-gradient(135deg, #78350f 0%, #92400e 100%);
        }
        @keyframes alert-pulse {
            0%, 100% { box-shadow: 0 0 0 0 rgba(245, 158, 11, 0.4); }
            50% { box-shadow: 0 0 0 10px rgba(245, 158, 11, 0); }
        }
        .watched-po-progress {
            display: flex;
            gap: 4px;
            margin-top: 12px;
        }
        .watched-po-stage {
            flex: 1;
            height: 8px;
            border-radius: 4px;
            background: #e5e7eb;
            overflow: hidden;
        }
        .dark .watched-po-stage { background: #4b5563; }
        .watched-po-stage.completed { background: #22c55e; }
        .watched-po-stage.partial { background: linear-gradient(90deg, #22c55e 50%, #e5e7eb 50%); }
        .dark .watched-po-stage.partial { background: linear-gradient(90deg, #22c55e 50%, #4b5563 50%); }
        .po-register-btn {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 8px 16px;
            background: linear-gradient(135deg, #0ea5e9 0%, #0284c7 100%);
            color: white;
            border-radius: 8px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            border: none;
        }
        .po-register-btn:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 15px rgba(14, 165, 233, 0.4);
        }
        .po-remove-btn {
            position: absolute;
            top: 8px;
            right: 8px;
            width: 24px;
            height: 24px;
            border-radius: 50%;
            background: rgba(239, 68, 68, 0.1);
            color: #ef4444;
            border: none;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 14px;
            transition: all 0.2s;
        }
        .po-remove-btn:hover {
            background: #ef4444;
            color: white;
        }
        .first-input-badge {
            display: inline-flex;
            align-items: center;
            gap: 4px;
            padding: 4px 10px;
            background: #f59e0b;
            color: white;
            border-radius: 9999px;
            font-size: 11px;
            font-weight: 600;
            animation: badge-glow 1.5s infinite;
        }
        @keyframes badge-glow {
            0%, 100% { box-shadow: 0 0 5px rgba(245, 158, 11, 0.5); }
            50% { box-shadow: 0 0 15px rgba(245, 158, 11, 0.8); }
        }

        /* Sidebar Navigation */
        .sidebar-nav {
            position: fixed;
            left: 0;
            top: 0;
            height: 100vh;
            width: 260px;
            background: var(--bg-secondary);
            border-right: 1px solid var(--border-color);
            z-index: 1000;
            transform: translateX(-100%);
            transition: transform 0.3s ease;
            overflow-y: auto;
            padding-top: 60px;
            box-shadow: 4px 0 20px rgba(0,0,0,0.15);
        }
        .sidebar-nav.open { transform: translateX(0); }
        .sidebar-nav::-webkit-scrollbar { width: 4px; }
        .sidebar-nav::-webkit-scrollbar-thumb { background: #9ca3af; border-radius: 2px; }

        /* Sidebar Overlay */
        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            z-index: 999;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0.3s ease;
        }
        .sidebar-overlay.active {
            opacity: 1;
            visibility: visible;
        }

        .sidebar-toggle {
            position: fixed;
            left: 12px;
            top: 12px;
            z-index: 1001;
            width: 44px;
            height: 44px;
            border-radius: 10px;
            background: var(--bg-card);
            border: 1px solid var(--border-color);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 2px 12px rgba(0,0,0,0.15);
            font-size: 18px;
        }
        .sidebar-toggle:hover {
            background: #3b82f6;
            color: white;
            transform: scale(1.05);
        }
        .sidebar-toggle.active {
            left: 272px;
            background: #3b82f6;
            color: white;
        }

        .nav-section { padding: 12px 16px; }
        .nav-section-title {
            font-size: 11px;
            font-weight: 700;
            text-transform: uppercase;
            color: var(--text-secondary);
            letter-spacing: 0.5px;
            margin-bottom: 8px;
            padding-left: 4px;
        }
        .nav-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 14px;
            border-radius: 8px;
            cursor: pointer;
            transition: all 0.15s;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 2px;
        }
        .nav-item:hover {
            background: rgba(59, 130, 246, 0.1);
            transform: translateX(4px);
        }
        .nav-item.active {
            background: #3b82f6;
            color: white;
            box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3);
        }
        .nav-item .nav-icon { font-size: 16px; width: 24px; text-align: center; }

        /* Main Content - Push layout for desktop */
        .main-content {
            transition: margin-left 0.3s ease, transform 0.3s ease;
            min-height: 100vh;
        }
        .main-content.sidebar-open {
            margin-left: 260px;
        }

        /* Mobile: Overlay mode instead of push */
        @media (max-width: 1024px) {
            .sidebar-nav { width: 280px; }
            .sidebar-toggle.active { left: 292px; }
            .main-content.sidebar-open { margin-left: 0; }
        }

        @media (max-width: 768px) {
            .sidebar-nav { width: 85vw; max-width: 320px; }
            .sidebar-toggle.active { left: calc(85vw + 12px); max-left: 332px; }
            .sidebar-toggle {
                left: 8px;
                top: 8px;
                width: 40px;
                height: 40px;
            }
        }

        /* Skip Link for Accessibility */
        .skip-link {
            position: absolute;
            top: -40px;
            left: 0;
            background: #2563eb;
            color: white;
            padding: 8px 16px;
            z-index: 10000;
            text-decoration: none;
            font-weight: 600;
            border-radius: 0 0 4px 0;
            transition: top 0.2s;
        }
        .skip-link:focus {
            top: 0;
        }

        /* Reduced Motion Preference */
        @media (prefers-reduced-motion: reduce) {
            *, *::before, *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }
    </style>
</head>
<body class="min-h-screen">
    <!-- Skip Link for Keyboard Users -->
    <a href="#main-content" class="skip-link">ë³¸ë¬¸ìœ¼ë¡œ ê±´ë„ˆë›°ê¸°</a>

    <!-- Fallback for JavaScript Disabled -->
    <noscript>
        <div style="background: #fef3cd; color: #856404; padding: 16px; text-align: center; border-bottom: 1px solid #ffc107;">
            ì´ ëŒ€ì‹œë³´ë“œëŠ” JavaScriptê°€ í•„ìš”í•©ë‹ˆë‹¤. ë¸Œë¼ìš°ì € ì„¤ì •ì—ì„œ JavaScriptë¥¼ í™œì„±í™”í•´ ì£¼ì„¸ìš”.
        </div>
    </noscript>

    <!-- Sidebar Navigation Toggle -->
    <button type="button" id="sidebarToggle" class="sidebar-toggle no-print" aria-label="ì‚¬ì´ë“œë°” í† ê¸€" aria-expanded="false" aria-controls="sidebarNav" title="ë©”ë‰´ (M)">
        <span id="toggleIcon" aria-hidden="true">â˜°</span>
    </button>

    <!-- Sidebar Overlay -->
    <div id="sidebarOverlay" class="sidebar-overlay no-print"></div>

    <!-- Sidebar Navigation -->
    <nav id="sidebarNav" class="sidebar-nav no-print" role="navigation" aria-label="ëŒ€ì‹œë³´ë“œ ë„¤ë¹„ê²Œì´ì…˜">
        <div class="px-4 pb-4 border-b border-theme">
            <div class="text-lg font-bold"><span aria-hidden="true">ğŸ­ </span>Dashboard</div>
            <div class="text-xs text-secondary">ì„¹ì…˜ ë°”ë¡œê°€ê¸°</div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">ê´€ì‹¬ PO</div>
            <div class="nav-item" data-target="section-watched-po" id="navWatchedPo" role="button" tabindex="0" aria-label="ê´€ì‹¬ PO í˜„í™© ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">â­</span>ê´€ì‹¬ PO í˜„í™©
                <span id="watchedPoCount" class="ml-auto text-xs bg-blue-500 text-white px-2 py-0.5 rounded-full">0</span>
            </div>
            <div class="nav-item" onclick="openPoRegisterModal()" role="button" tabindex="0" aria-label="ê´€ì‹¬ PO ë“±ë¡ ëª¨ë‹¬ ì—´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')openPoRegisterModal()">
                <span class="nav-icon" aria-hidden="true">â•</span>PO ë“±ë¡í•˜ê¸°
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">ìš”ì•½</div>
            <div class="nav-item" data-target="section-summary" role="button" tabindex="0" aria-label="ì›”ìš” ì˜¤ë” í˜„í™© ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ“‹</span>ì›”ìš” ì˜¤ë” í˜„í™©
            </div>
            <div class="nav-item" data-target="section-executive" role="button" tabindex="0" aria-label="Executive Summary ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ¯</span>Executive Summary
            </div>
            <div class="nav-item" data-target="section-insights" role="button" tabindex="0" aria-label="ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸ ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ“Š</span>ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸
            </div>
            <div class="nav-item" data-target="section-alerts" role="button" tabindex="0" aria-label="ì•Œë¦¼ í˜„í™© ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸš¨</span>ì•Œë¦¼ í˜„í™©
            </div>
            <div class="nav-item" data-target="section-recommendations" role="button" tabindex="0" aria-label="ë‹´ë‹¹ì ê¶Œê³ ì‚¬í•­ ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ’¡</span>ë‹´ë‹¹ì ê¶Œê³ ì‚¬í•­
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">í˜„í™©</div>
            <div class="nav-item" data-target="section-kpi" role="button" tabindex="0" aria-label="KPI ìš”ì•½ ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ“ˆ</span>KPI ìš”ì•½
            </div>
            <div class="nav-item" data-target="section-process" role="button" tabindex="0" aria-label="ê³µì •ë³„ í˜„í™© ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">âš™ï¸</span>ê³µì •ë³„ í˜„í™©
            </div>
            <div class="nav-item" data-target="section-factory" role="button" tabindex="0" aria-label="ê³µì¥ë³„ ì™„ë£Œìœ¨ ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ­</span>ê³µì¥ë³„ ì™„ë£Œìœ¨
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">ì¼ì •/ë²¤ë”</div>
            <div class="nav-item" data-target="section-calendar" role="button" tabindex="0" aria-label="ì˜ˆì • ìº˜ë¦°ë” ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ“…</span>ì˜ˆì • ìº˜ë¦°ë”
            </div>
            <div class="nav-item" data-target="section-vendor" role="button" tabindex="0" aria-label="ì•„ì›ƒì†” ë²¤ë” ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ‘Ÿ</span>ì•„ì›ƒì†” ë²¤ë”
            </div>
            <div class="nav-item" data-target="section-destination" role="button" tabindex="0" aria-label="ì¤‘ìš” í–‰ì„ ì§€ ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ¯</span>ì¤‘ìš” í–‰ì„ ì§€
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-section-title">í•„í„°/ë¶„ì„</div>
            <div class="nav-item" data-target="section-filter" role="button" tabindex="0" aria-label="í•„í„° ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ”</span>í•„í„°
            </div>
            <div class="nav-item" data-target="section-tabs" role="button" tabindex="0" aria-label="ìƒì„¸ ë¶„ì„ íƒ­ ì„¹ì…˜ìœ¼ë¡œ ì´ë™">
                <span class="nav-icon" aria-hidden="true">ğŸ“Š</span>ìƒì„¸ ë¶„ì„ íƒ­
            </div>
        </div>

        <div class="nav-section border-t border-theme mt-2 pt-2">
            <div class="nav-section-title">ë‹¨ì¶•í‚¤</div>
            <div class="text-xs text-secondary space-y-1 px-2">
                <div><span class="kbd">M</span> ë©”ë‰´ í† ê¸€</div>
                <div><span class="kbd">S</span> ê²€ìƒ‰</div>
                <div><span class="kbd">F</span> í•„í„°</div>
                <div><span class="kbd">D</span> ìƒì„¸ íƒ­</div>
            </div>
        </div>
    </nav>

    <!-- Login Overlay - z-60ìœ¼ë¡œ uploadOverlay ìœ„ì— í‘œì‹œ -->
    <div id="loginOverlay" class="fixed inset-0 bg-gradient-to-br from-slate-900 via-gray-900 to-zinc-900 z-[60] flex items-center justify-center">
        <div class="max-w-md w-full mx-4">
            <div class="text-center mb-8">
                <div class="text-6xl mb-4" aria-hidden="true">ğŸ”</div>
                <h1 class="text-3xl font-bold text-white mb-2">Rachgia Dashboard</h1>
                <p class="text-gray-400">Authorized Access Only</p>
            </div>

            <form id="loginForm" class="bg-white/10 backdrop-blur-lg rounded-2xl p-8">
                <div class="mb-6">
                    <label for="username" class="block text-sm font-medium text-gray-300 mb-2">ì‚¬ìš©ì ID</label>
                    <input type="text" id="username" name="username" required aria-required="true" autocomplete="username" aria-describedby="loginError"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ì•„ì´ë”” ì…ë ¥">
                </div>

                <div class="mb-6">
                    <label for="password" class="block text-sm font-medium text-gray-300 mb-2">ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="password" name="password" required aria-required="true" autocomplete="current-password" aria-describedby="loginError"
                        class="w-full px-4 py-3 bg-white/10 border border-white/20 rounded-xl text-white placeholder-gray-400 focus:outline-none focus:ring-2 focus:ring-blue-500 focus:border-transparent"
                        placeholder="ë¹„ë°€ë²ˆí˜¸ ì…ë ¥">
                </div>

                <div id="loginError" class="hidden mb-4 p-3 bg-red-500/20 border border-red-500/50 rounded-lg text-red-300 text-sm text-center" role="alert" aria-live="assertive">
                    ì•„ì´ë”” ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤.
                </div>

                <button type="submit" class="w-full bg-blue-600 hover:bg-blue-700 text-white font-semibold py-3 rounded-xl transition-colors" aria-label="ë¡œê·¸ì¸">
                    ë¡œê·¸ì¸
                </button>

                <p class="mt-4 text-center text-gray-500 text-xs">
                    Â© 2024 Rachgia Factory. All rights reserved.
                </p>
            </form>
        </div>
    </div>

    <!-- File Upload Overlay -->
    <div id="uploadOverlay" class="fixed inset-0 bg-gradient-to-br from-blue-900 via-indigo-900 to-purple-900 z-50 flex items-center justify-center hidden">
        <div class="max-w-2xl w-full mx-4">
            <div class="text-center mb-8">
                <h1 class="text-4xl font-bold text-white mb-2"><span aria-hidden="true">ğŸ“Š </span>Rachgia Dashboard</h1>
                <p class="text-blue-200">Factory Production Management System v9</p>
            </div>

            <!-- Upload Area -->
            <div id="dropZone" class="bg-white/10 backdrop-blur-lg border-2 border-dashed border-white/30 rounded-2xl p-12 text-center cursor-pointer hover:bg-white/20 hover:border-white/50 transition-all duration-300 focus:outline-none focus:ring-2 focus:ring-blue-400 focus:ring-offset-2 focus:ring-offset-sky-600" role="button" tabindex="0" aria-label="íŒŒì¼ ì—…ë¡œë“œ ì˜ì—­" aria-describedby="dropZoneInstructions" onkeydown="if(event.key==='Enter'||event.key===' '){event.preventDefault();document.getElementById('fileInput').click();}">
                <div id="uploadContent">
                    <div class="text-6xl mb-4" aria-hidden="true">ğŸ“</div>
                    <h2 class="text-2xl font-bold text-white mb-2">BAL ì—‘ì…€ íŒŒì¼ ì—…ë¡œë“œ</h2>
                    <p id="dropZoneInstructions" class="text-blue-200 mb-6">íŒŒì¼ì„ ë“œë˜ê·¸í•˜ê±°ë‚˜ í´ë¦­ ë˜ëŠ” Enter í‚¤ë¥¼ ëˆŒëŸ¬ ì„ íƒí•˜ì„¸ìš”</p>
                    <input type="file" id="fileInput" accept=".xlsx,.xls" multiple class="hidden" aria-label="BAL Excel íŒŒì¼ ì„ íƒ" aria-describedby="dropZoneFormats">
                    <button type="button" onclick="document.getElementById('fileInput').click()" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold px-8 py-3 rounded-xl transition-colors" aria-label="BAL Excel íŒŒì¼ ì„ íƒ">
                        ğŸ“‚ íŒŒì¼ ì„ íƒ (ë‹¤ì¤‘ ì„ íƒ ê°€ëŠ¥)
                    </button>
                    <p id="dropZoneFormats" class="text-blue-300/70 text-sm mt-4">ì§€ì› í˜•ì‹: .xlsx, .xls (BAL íŒŒì¼) - ì—¬ëŸ¬ íŒŒì¼ ë™ì‹œ ì—…ë¡œë“œ ê°€ëŠ¥</p>
                    <div id="fileList" class="mt-4 text-left max-h-32 overflow-y-auto hidden"></div>
                </div>

                <!-- Loading State -->
                <div id="uploadLoading" class="hidden" role="status" aria-busy="true" aria-live="polite" aria-label="íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ ì¤‘">
                    <div class="loading-spinner mx-auto mb-4" aria-hidden="true"></div>
                    <p class="text-white">íŒŒì¼ íŒŒì‹± ì¤‘...</p>
                </div>
            </div>

            <!-- File Format Guide -->
            <div class="mt-8 bg-white/5 rounded-xl p-4 text-sm text-blue-200">
                <h3 class="font-semibold text-white mb-2"><span aria-hidden="true">ğŸ“‹ </span>ì§€ì› íŒŒì¼ í˜•ì‹</h3>
                <ul class="space-y-1 text-xs">
                    <li>â€¢ BAL ì—‘ì…€ íŒŒì¼ (.xlsx) - ê³µì¥ë³„ ìƒì‚°í˜„í™©</li>
                    <li>â€¢ í•„ìˆ˜ ì»¬ëŸ¼: PO#, ARTICLE, QTY, CRD, SDD, ê³µì •ë³„ ì‹¤ì </li>
                </ul>
            </div>
        </div>
    </div>

    <!-- Loading Overlay (for subsequent loads) -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white dark:bg-gray-900 bg-opacity-90 z-40 hidden items-center justify-center" role="status" aria-busy="true" aria-live="polite" aria-label="ë°ì´í„° ë¡œë”© ì¤‘">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4" aria-hidden="true"></div>
            <p class="text-gray-600 dark:text-gray-300">ë°ì´í„° ì²˜ë¦¬ ì¤‘...</p>
        </div>
    </div>

    <!-- Main Content Wrapper -->
    <div id="main-content" class="main-content" role="main">
    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg no-print" role="banner" aria-label="Rachgia Factory ëŒ€ì‹œë³´ë“œ í—¤ë”">
        <div class="max-w-[2000px] mx-auto px-4 py-4">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div>
                    <h1 class="text-2xl font-bold"><span aria-hidden="true">ğŸ­ </span>Rachgia Factory í†µí•© ìƒì‚°ê´€ë¦¬ <span class="text-sm font-normal bg-white/20 px-2 py-1 rounded">v8</span></h1>
                    <p class="text-blue-100 text-sm mt-1">Factory A, B, C, D ìƒì‚° í˜„í™© ëª¨ë‹ˆí„°ë§</p>
                </div>
                <div class="flex items-center gap-3 flex-wrap">
                    <!-- Date Mode Toggle (SDD/CRD) -->
                    <div class="date-mode-toggle" role="radiogroup" aria-label="ë‚ ì§œ ê¸°ì¤€ ì„ íƒ">
                        <div class="date-mode-btn active" data-mode="sdd" onclick="setDateMode('sdd')" role="radio" aria-checked="true" tabindex="0" onkeydown="if(event.key==='Enter')setDateMode('sdd')">SDD</div>
                        <div class="date-mode-btn" data-mode="crd" onclick="setDateMode('crd')" role="radio" aria-checked="false" tabindex="0" onkeydown="if(event.key==='Enter')setDateMode('crd')">CRD</div>
                    </div>
                    <!-- Date Range Filter -->
                    <div class="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-lg">
                        <label for="dateRangeFilter" class="text-sm">ê¸°ê°„:</label>
                        <select id="dateRangeFilter" class="bg-white/20 text-white border-none rounded px-2 py-1 text-sm cursor-pointer" onchange="applyDateRangeFilter()">
                            <option value="all" style="color: #000;">ì „ì²´</option>
                            <option value="week" style="color: #000;">1ì£¼ì¼ ì´ë‚´</option>
                            <option value="month" style="color: #000;">1ë‹¬ ì´ë‚´</option>
                        </select>
                    </div>
                    <!-- Auto Refresh -->
                    <div class="flex items-center gap-2 bg-white/10 px-3 py-1 rounded-lg">
                        <label for="autoRefreshToggle" class="text-sm cursor-pointer">ìë™ ìƒˆë¡œê³ ì¹¨</label>
                        <input type="checkbox" id="autoRefreshToggle" class="w-4 h-4 cursor-pointer" checked aria-label="ìë™ ìƒˆë¡œê³ ì¹¨ í† ê¸€">
                    </div>
                    <!-- File Upload Button -->
                    <button type="button" onclick="showUploadOverlay()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-sm flex items-center gap-1" title="íŒŒì¼ ì—…ë¡œë“œ" aria-label="ìƒˆ íŒŒì¼ ì—…ë¡œë“œ" aria-haspopup="dialog">
                        <span aria-hidden="true">ğŸ“ </span><span class="hidden md:inline">íŒŒì¼ ë³€ê²½</span>
                    </button>
                    <!-- Logout Button -->
                    <button type="button" onclick="handleLogout()" class="bg-red-500/50 hover:bg-red-500/70 px-3 py-1 rounded-lg text-sm flex items-center gap-1" title="ë¡œê·¸ì•„ì›ƒ" aria-label="ë¡œê·¸ì•„ì›ƒ">
                        <span aria-hidden="true">ğŸšª </span><span class="hidden md:inline">ë¡œê·¸ì•„ì›ƒ</span>
                    </button>
                    <!-- Help Button -->
                    <button type="button" id="helpModalBtn" onclick="toggleHelpModal()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-sm" title="ë„ì›€ë§" aria-label="ë„ì›€ë§ ë³´ê¸°" aria-haspopup="dialog" aria-expanded="false" aria-controls="helpModal">
                        <span aria-hidden="true">â“</span>
                    </button>
                    <!-- Dark Mode Toggle -->
                    <button type="button" id="darkModeToggle" onclick="toggleDarkMode()" class="bg-white/20 hover:bg-white/30 px-3 py-1 rounded-lg text-sm" aria-label="ë‹¤í¬ëª¨ë“œ ì „í™˜" aria-pressed="false" title="ë‹¤í¬ëª¨ë“œ ì „í™˜">
                        <span id="darkModeIcon" aria-hidden="true">ğŸŒ™</span>
                    </button>
                    <!-- Delay Alert -->
                    <div id="delayAlert" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg animate-pulse cursor-pointer" onclick="showDelayedOrders()" role="button" tabindex="0" aria-label="ì§€ì—° ì•Œë¦¼ ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showDelayedOrders()">
                        <span aria-hidden="true">âš ï¸ </span>ì§€ì—°: <span id="delayCount">0</span>ê±´
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-100">ë§ˆì§€ë§‰ ì—…ë°ì´íŠ¸</div>
                        <div class="font-semibold text-sm" id="lastUpdateTime" aria-busy="true" aria-live="polite">ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <!-- ì›”ìš” ì˜¤ë” í˜„í™© ìš”ì•½ - ìƒë‹¨ ê³ ì • -->
    <div id="section-summary" class="sticky top-0 z-40 bg-gradient-to-r from-slate-800 to-slate-900 text-white shadow-lg no-print">
        <div class="max-w-[2000px] mx-auto px-4 py-3">
            <div class="flex items-center justify-between flex-wrap gap-4">
                <h2 class="text-lg font-bold flex items-center gap-2">
                    <span aria-hidden="true">ğŸ“‹ </span>ì›”ìš” ì˜¤ë” í˜„í™© ìš”ì•½
                    <span class="text-xs font-normal bg-white/20 px-2 py-0.5 rounded" id="summaryUpdateTime">-</span>
                </h2>
                <div class="flex flex-wrap items-center gap-6 text-sm">
                    <!-- SDD ê¸°ì¤€ -->
                    <div class="flex items-center gap-4 bg-blue-500/20 px-4 py-2 rounded-lg">
                        <span class="font-semibold text-blue-300"><span aria-hidden="true">ğŸ“… </span>SDD ê¸°ì¤€</span>
                        <div class="flex items-center gap-1">
                            <span class="text-red-400"><span aria-hidden="true">ğŸš¨ </span>ì§€ì—°:</span>
                            <span id="sddDelayCount" class="font-bold text-red-300">-</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-amber-400"><span aria-hidden="true">âš¡ </span>ê²½ê³ :</span>
                            <span id="sddWarningCount" class="font-bold text-amber-300">-</span>
                        </div>
                    </div>
                    <!-- CRD ê¸°ì¤€ -->
                    <div class="flex items-center gap-4 bg-purple-500/20 px-4 py-2 rounded-lg">
                        <span class="font-semibold text-purple-300"><span aria-hidden="true">ğŸ¯ </span>CRD ê¸°ì¤€</span>
                        <div class="flex items-center gap-1">
                            <span class="text-red-400"><span aria-hidden="true">ğŸš¨ </span>ì§€ì—°:</span>
                            <span id="crdDelayCount" class="font-bold text-red-300">-</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-amber-400"><span aria-hidden="true">âš¡ </span>ê²½ê³ :</span>
                            <span id="crdWarningCount" class="font-bold text-amber-300">-</span>
                        </div>
                    </div>
                    <!-- ìƒì‚°/ì¶œê³  í˜„í™© -->
                    <div class="flex items-center gap-4 bg-green-500/20 px-4 py-2 rounded-lg">
                        <div class="flex items-center gap-1">
                            <span class="text-green-300"><span aria-hidden="true">ğŸ‘Ÿ </span>ì œí™” ìƒì‚° ì™„ë£Œ:</span>
                            <span id="sewingCompleteCount" class="font-bold text-green-200">-</span>
                        </div>
                        <div class="flex items-center gap-1">
                            <span class="text-cyan-300"><span aria-hidden="true">ğŸ“¦ </span>ì°½ê³  ì¶œê³  ì™„ë£Œ:</span>
                            <span id="warehouseOutCount" class="font-bold text-cyan-200">-</span>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="max-w-[2000px] mx-auto px-4 py-6">
        <!-- Executive Summary -->
        <div id="section-executive" class="bg-gradient-to-r from-indigo-500 to-purple-600 rounded-xl shadow-lg p-6 mb-6 text-white">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-xl font-bold"><span aria-hidden="true">ğŸ¯ </span>Executive Summary</h2>
                <div class="text-sm opacity-80">ê¸°ì¤€: <span id="dateModeLabel">SDD</span></div>
            </div>
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-4">
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-white/80 text-sm">ì „ì²´ ì™„ë£Œìœ¨</div>
                    <div class="exec-kpi" id="execCompletionRate">-</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-white/80 text-sm">ì§€ì—° ìœ„í—˜</div>
                    <div class="exec-kpi text-red-300" id="execDelayCount">-</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-white/80 text-sm">ì˜¤ëŠ˜ ì˜ˆì •</div>
                    <div class="exec-kpi text-yellow-300" id="execTodayCount">-</div>
                    <div class="text-sm opacity-80" id="execTodayQty">-</div>
                </div>
                <div class="bg-white/10 rounded-lg p-4 text-center">
                    <div class="text-white/80 text-sm">ì°½ê³  ì¬ê³ </div>
                    <div class="exec-kpi text-blue-300" id="execInventory">-</div>
                    <div class="text-sm opacity-80" id="execInventoryOrders">-</div>
                </div>
            </div>
            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                <div class="bg-white/10 rounded-lg p-3">
                    <div class="text-sm font-medium mb-2"><span aria-hidden="true">ğŸ“Š </span>ê³µì¥ ìˆœìœ„</div>
                    <div id="execFactoryRanking" class="text-sm" aria-live="polite" aria-atomic="true"></div>
                </div>
                <div class="bg-white/10 rounded-lg p-3">
                    <div class="text-sm font-medium mb-2"><span aria-hidden="true">âš ï¸ </span>ì£¼ìš” ê²½ê³ </div>
                    <div id="execWarnings" class="text-sm" aria-live="polite" aria-atomic="true"></div>
                </div>
            </div>
        </div>

        <!-- Executive Insights - ê²½ì˜ì§„ í•µì‹¬ ì¸ì‚¬ì´íŠ¸ -->
        <div id="section-insights" class="bg-gradient-to-br from-slate-900 via-blue-900 to-indigo-900 rounded-xl shadow-lg p-6 mb-6 text-white">
            <div class="flex justify-between items-center mb-5">
                <h2 class="text-xl font-bold flex items-center gap-2">
                    <span aria-hidden="true">ğŸ“Š </span>ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸
                    <span class="text-xs bg-green-500 text-white px-2 py-0.5 rounded animate-pulse">LIVE</span>
                </h2>
                <div class="flex items-center gap-3">
                    <span class="text-sm opacity-70">ê¸°ì¤€: SDD/CRD</span>
                    <button type="button" id="insightsHelpBtn" onclick="toggleInsightsHelp()" class="text-xs bg-white/10 hover:bg-white/20 px-2 py-1 rounded transition" aria-label="ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸ ë„ì›€ë§" aria-haspopup="dialog" aria-expanded="false" aria-controls="helpModal"><span aria-hidden="true">â“ </span>ë„ì›€ë§</button>
                </div>
            </div>

            <!-- Primary KPIs Row -->
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-5">
                <!-- OTD Rate -->
                <div class="bg-white/10 rounded-xl p-4 border-l-4 border-green-400 hover:bg-white/15 transition cursor-pointer" onclick="showOTDDetail()" role="button" tabindex="0" aria-label="ì •ì‹œ ë‚©ê¸°ìœ¨ ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showOTDDetail()">
                    <div class="text-sm opacity-70 mb-1 flex items-center gap-1"><span aria-hidden="true">ğŸ¯ </span>ì •ì‹œ ë‚©ê¸°ìœ¨ (OTD)</div>
                    <div class="flex items-end gap-2">
                        <span class="text-3xl font-bold" id="kpiOtdRate">-</span>
                    </div>
                    <div class="text-xs opacity-60 mt-1">ëª©í‘œ: 95% | <span id="kpiOtdOrders">-</span></div>
                </div>

                <!-- Revenue at Risk -->
                <div class="bg-white/10 rounded-xl p-4 border-l-4 border-red-400 hover:bg-white/15 transition cursor-pointer" onclick="showRevenueRiskDetail()" role="button" tabindex="0" aria-label="ìœ„í—˜ ë§¤ì¶œì•¡ ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showRevenueRiskDetail()">
                    <div class="text-sm opacity-70 mb-1 flex items-center gap-1"><span aria-hidden="true">ğŸ’° </span>ìœ„í—˜ ë§¤ì¶œì•¡</div>
                    <div class="text-3xl font-bold text-red-300" id="kpiRevenueRisk">-</div>
                    <div class="text-xs opacity-60 mt-1" id="kpiRiskOrders">-</div>
                </div>

                <!-- AQL Pass Rate -->
                <div class="bg-white/10 rounded-xl p-4 border-l-4 border-blue-400 hover:bg-white/15 transition cursor-pointer" onclick="showAQLDetail()" role="button" tabindex="0" aria-label="í’ˆì§ˆ ê²€ì‚¬ í•©ê²©ë¥  ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showAQLDetail()">
                    <div class="text-sm opacity-70 mb-1 flex items-center gap-1"><span aria-hidden="true">âœ… </span>í’ˆì§ˆ ê²€ì‚¬ í•©ê²©ë¥ </div>
                    <div class="text-3xl font-bold" id="kpiAqlRate">-</div>
                    <div class="text-xs opacity-60 mt-1" id="kpiAqlCount">-</div>
                </div>

                <!-- Bottleneck Prediction -->
                <div class="bg-white/10 rounded-xl p-4 border-l-4 border-amber-400 hover:bg-white/15 transition cursor-pointer" onclick="showBottleneckDetail()" role="button" tabindex="0" aria-label="ì˜ˆì¸¡ ë³‘ëª© ê³µì • ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showBottleneckDetail()">
                    <div class="text-sm opacity-70 mb-1 flex items-center gap-1"><span aria-hidden="true">âš ï¸ </span>ì˜ˆì¸¡ ë³‘ëª© ê³µì •</div>
                    <div class="text-2xl font-bold text-amber-300" id="kpiBottleneckStage">-</div>
                    <div class="text-xs text-amber-400 mt-1" id="kpiBottleneckRisk">-</div>
                </div>
            </div>

            <!-- Analysis Charts Row -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <!-- Delay Severity Distribution -->
                <div class="bg-white/5 rounded-lg p-4">
                    <h4 class="text-sm font-medium mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ“‰ </span>ì§€ì—° ì‹¬ê°ë„ ë¶„í¬</h4>
                    <div class="h-32"><canvas id="delaySeverityChart" role="img" aria-label="ì§€ì—° ì‹¬ê°ë„ ë¶„í¬ ì°¨íŠ¸"></canvas></div>
                    <div class="flex justify-around text-xs mt-3 pt-2 border-t border-white/10">
                        <div class="text-center">
                            <div class="text-green-400 font-medium" id="delayMild">-</div>
                            <div class="text-green-400/70">ê²½ë¯¸(1-3ì¼)</div>
                        </div>
                        <div class="text-center">
                            <div class="text-amber-400 font-medium" id="delayModerate">-</div>
                            <div class="text-amber-400/70">ì£¼ì˜(4-7ì¼)</div>
                        </div>
                        <div class="text-center">
                            <div class="text-red-400 font-medium" id="delaySevere">-</div>
                            <div class="text-red-400/70">ì‹¬ê°(7ì¼+)</div>
                        </div>
                    </div>
                </div>

                <!-- Root Cause Analysis -->
                <div class="bg-white/5 rounded-lg p-4">
                    <h4 class="text-sm font-medium mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ” </span>ì§€ì—° ì›ì¸ ë¶„ì„</h4>
                    <div class="h-32"><canvas id="rootCauseChart" role="img" aria-label="ì§€ì—° ì›ì¸ ë¶„ì„ ì°¨íŠ¸"></canvas></div>
                    <div class="text-xs mt-3 pt-2 border-t border-white/10">
                        ì£¼ìš” ì›ì¸: <span id="primaryRootCause" class="text-red-300 font-medium">-</span>
                        <span class="opacity-60">(<span id="primaryRootCauseCount">-</span>ê±´)</span>
                    </div>
                </div>

                <!-- Vendor Performance -->
                <div class="bg-white/5 rounded-lg p-4">
                    <h4 class="text-sm font-medium mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ­ </span>ë²¤ë” ì„±ê³¼ TOP 5</h4>
                    <div id="vendorPerformanceList" class="space-y-2 text-sm"></div>
                </div>
            </div>
        </div>

        <!-- Alert Cards -->
        <div id="section-alerts" class="hidden mb-6">
            <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
                <div class="delay-highlight rounded-xl shadow-sm p-4 cursor-pointer" onclick="showDelayedOrders()" role="button" tabindex="0" aria-label="ì§€ì—° ì˜¤ë” ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showDelayedOrders()">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl" aria-hidden="true">ğŸš¨</span>
                        <div>
                            <div class="text-red-700 dark:text-red-300 text-sm font-medium">ì§€ì—° ì˜¤ë”</div>
                            <div class="text-2xl font-bold text-red-800 dark:text-red-200" id="delayedOrderCount">0ê±´</div>
                            <div class="text-xs text-red-600 dark:text-red-400" id="delayedOrderQty">0ì¡±</div>
                        </div>
                    </div>
                </div>
                <div class="warning-highlight rounded-xl shadow-sm p-4 cursor-pointer" onclick="showWarningOrders()" role="button" tabindex="0" aria-label="3ì¼ ë‚´ ì˜ˆì • ì˜¤ë” ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showWarningOrders()">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl" aria-hidden="true">âš¡</span>
                        <div>
                            <div class="text-amber-700 dark:text-amber-300 text-sm font-medium">3ì¼ ë‚´ ì˜ˆì •</div>
                            <div class="text-2xl font-bold text-amber-800 dark:text-amber-200" id="warningOrderCount">0ê±´</div>
                            <div class="text-xs text-amber-600 dark:text-amber-400" id="warningOrderQty">0ì¡±</div>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 dark:bg-blue-900/30 border-l-4 border-blue-400 rounded-xl shadow-sm p-4 cursor-pointer" onclick="showInventoryOrders()" role="button" tabindex="0" aria-label="ì°½ê³  ì¬ê³  ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showInventoryOrders()">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl" aria-hidden="true">ğŸ“¦</span>
                        <div>
                            <div class="text-blue-700 dark:text-blue-300 text-sm font-medium">ì°½ê³  ì¬ê³ </div>
                            <div class="text-2xl font-bold text-blue-800 dark:text-blue-200" id="inventoryCount">0ì¡±</div>
                            <div class="text-xs text-blue-600 dark:text-blue-400" id="inventoryOrders">0ê±´</div>
                        </div>
                    </div>
                </div>
                <div class="shipped-highlight rounded-xl shadow-sm p-4 cursor-pointer" onclick="showShippedOrders()" role="button" tabindex="0" aria-label="ì„ ì  ì™„ë£Œ ì˜¤ë” ìƒì„¸ ë³´ê¸°" aria-haspopup="dialog" onkeydown="if(event.key==='Enter')showShippedOrders()">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl" aria-hidden="true">ğŸš¢</span>
                        <div>
                            <div class="text-emerald-700 dark:text-emerald-300 text-sm font-medium">ì„ ì  ì™„ë£Œ</div>
                            <div class="text-2xl font-bold text-emerald-800 dark:text-emerald-200" id="shippedOrderCount">0ê±´</div>
                            <div class="text-xs text-emerald-600 dark:text-emerald-400" id="shippedOrderQty">0ì¡±</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ê´€ì‹¬ PO ëª¨ë‹ˆí„°ë§ ì„¹ì…˜ -->
        <div id="section-watched-po" class="bg-gradient-to-r from-sky-50 to-blue-50 dark:from-sky-900/20 dark:to-blue-900/20 rounded-xl shadow-lg p-6 mb-6 border-l-4 border-sky-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold flex items-center gap-2 text-sky-800 dark:text-sky-200">
                    <span aria-hidden="true">â­ </span>ê´€ì‹¬ PO ëª¨ë‹ˆí„°ë§
                    <span id="watchedPoAlertBadge" class="hidden first-input-badge" aria-hidden="true">ğŸ”” íˆ¬ì… ì‹œì‘!</span>
                </h2>
                <div class="flex items-center gap-3">
                    <span class="text-sm text-sky-600 dark:text-sky-400" id="watchedPoLastUpdate">-</span>
                    <button type="button" class="po-register-btn" onclick="openPoRegisterModal()" aria-label="ê´€ì‹¬ PO ë“±ë¡" aria-haspopup="dialog">
                        <span aria-hidden="true">â• </span>PO ë“±ë¡
                    </button>
                </div>
            </div>

            <div id="watchedPoEmpty" class="text-center py-8 text-gray-500">
                <div class="text-4xl mb-3" aria-hidden="true">ğŸ“‹</div>
                <div class="font-medium">ë“±ë¡ëœ ê´€ì‹¬ POê°€ ì—†ìŠµë‹ˆë‹¤</div>
                <div class="text-sm mt-1">POë¥¼ ë“±ë¡í•˜ë©´ ìƒì‚° í˜„í™©ì„ ì‹¤ì‹œê°„ìœ¼ë¡œ ëª¨ë‹ˆí„°ë§í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤</div>
                <button type="button" class="po-register-btn mt-4" onclick="openPoRegisterModal()" aria-label="ì²« ê´€ì‹¬ PO ë“±ë¡í•˜ê¸°" aria-haspopup="dialog">
                    <span aria-hidden="true">â• </span>ì²« PO ë“±ë¡í•˜ê¸°
                </button>
            </div>

            <div id="watchedPoGrid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 hidden">
                <!-- ë“±ë¡ëœ PO ì¹´ë“œë“¤ì´ ì—¬ê¸°ì— ë™ì ìœ¼ë¡œ ìƒì„±ë¨ -->
            </div>
        </div>

        <!-- ë‹´ë‹¹ì ê¶Œê³ ì‚¬í•­ (Action Recommendations) -->
        <div id="section-recommendations" class="bg-gradient-to-r from-orange-50 to-red-50 dark:from-orange-900/20 dark:to-red-900/20 rounded-xl shadow-lg p-6 mb-6 border-l-4 border-orange-500">
            <div class="flex justify-between items-center mb-4">
                <h2 class="text-lg font-bold flex items-center gap-2 text-orange-800 dark:text-orange-200">
                    <span aria-hidden="true">ğŸ“‹ </span>ë‹´ë‹¹ì ê¶Œê³ ì‚¬í•­
                    <span class="text-xs bg-orange-500 text-white px-2 py-0.5 rounded">AI ë¶„ì„</span>
                </h2>
                <div class="text-sm text-orange-600 dark:text-orange-400" id="recommendationTime">-</div>
            </div>

            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <!-- ê³„íš ë‹´ë‹¹ì ê¶Œê³  -->
                <div class="bg-white/80 dark:bg-gray-800/80 rounded-lg p-4">
                    <h3 class="font-bold text-blue-700 dark:text-blue-300 mb-3 flex items-center gap-2">
                        <span aria-hidden="true">ğŸ“… </span>ê³„íš ë‹´ë‹¹ì
                        <span class="text-xs font-normal text-gray-500">ìƒì‚°ê³„íš ìµœì í™”</span>
                    </h3>
                    <div id="planningRecommendations" class="space-y-2 text-sm" aria-busy="true" aria-live="polite">
                        <div class="text-gray-400">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                    </div>
                </div>

                <!-- í’ˆì§ˆ ë‹´ë‹¹ì ê¶Œê³  -->
                <div class="bg-white/80 dark:bg-gray-800/80 rounded-lg p-4">
                    <h3 class="font-bold text-green-700 dark:text-green-300 mb-3 flex items-center gap-2">
                        <span aria-hidden="true">âœ… </span>í’ˆì§ˆ ë‹´ë‹¹ì
                        <span class="text-xs font-normal text-gray-500">í’ˆì§ˆ ë¦¬ìŠ¤í¬ ê´€ë¦¬</span>
                    </h3>
                    <div id="qualityRecommendations" class="space-y-2 text-sm" aria-busy="true" aria-live="polite">
                        <div class="text-gray-400">ë°ì´í„° ë¡œë”© ì¤‘...</div>
                    </div>
                </div>
            </div>

            <!-- ë¦¬ìŠ¤í¬ ìŠ¤ì½”ì–´ -->
            <div class="mt-4 pt-4 border-t border-orange-200 dark:border-orange-700">
                <div class="flex items-center justify-between">
                    <div class="flex items-center gap-4">
                        <div class="text-sm text-gray-600 dark:text-gray-400">ì¢…í•© ë¦¬ìŠ¤í¬ ì ìˆ˜</div>
                        <div id="riskScore" class="text-2xl font-bold text-orange-600">-</div>
                        <div id="riskLevel" class="text-xs px-2 py-1 rounded">-</div>
                    </div>
                    <div id="riskBreakdown" class="text-xs text-gray-500 dark:text-gray-400"></div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div id="section-kpi" class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" aria-live="polite" aria-atomic="true">
            <div class="bg-card rounded-xl shadow-sm p-4 card-hover border-l-4 border-blue-500">
                <div class="text-secondary text-sm">ì´ ì˜¤ë” ê±´ìˆ˜</div>
                <div class="text-2xl font-bold" id="totalOrders">-</div>
            </div>
            <div class="bg-card rounded-xl shadow-sm p-4 card-hover border-l-4 border-indigo-500">
                <div class="text-secondary text-sm">ì´ ì£¼ë¬¸ ìˆ˜ëŸ‰</div>
                <div class="text-2xl font-bold" id="totalQty">-</div>
            </div>
            <div class="bg-card rounded-xl shadow-sm p-4 card-hover border-l-4 border-green-500">
                <div class="text-secondary text-sm">ì°½ê³ ì…ê³  ì™„ë£Œ</div>
                <div class="text-2xl font-bold text-green-600" id="totalCompleted">-</div>
            </div>
            <div class="bg-card rounded-xl shadow-sm p-4 card-hover border-l-4 border-purple-500">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-secondary text-sm">ì „ì²´ ì™„ë£Œìœ¨</div>
                        <div class="text-2xl font-bold text-purple-600" id="totalRate">-</div>
                    </div>
                    <div class="w-16 h-16"><canvas id="rateDonut" role="img" aria-label="ì „ì²´ ì™„ë£Œìœ¨ ë„ë„› ì°¨íŠ¸"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Production Flow -->
            <div id="section-process" class="lg:col-span-2 bg-card rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4"><span aria-hidden="true">âš™ï¸ </span>ê³µì •ë³„ ìƒì‚° í˜„í™© <span class="text-sm font-normal text-secondary">(<span aria-hidden="true">ğŸ”´</span> = ë³‘ëª©ê³µì •)</span></h3>
                <div id="funnelChart" class="grid grid-cols-8 gap-1 mb-4"></div>
                <div id="processProgress" class="space-y-3"></div>
            </div>
            <div id="section-factory" class="bg-card rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4"><span aria-hidden="true">ğŸ­ </span>ê³µì¥ë³„ ì™„ë£Œìœ¨</h3>
                <div id="factoryCards" class="space-y-3"></div>
                <div class="mt-4 pt-4 border-t border-theme">
                    <h4 class="text-sm font-medium text-secondary mb-2">ê³µì¥ ë¹„êµ</h4>
                    <div style="height: 200px;"><canvas id="factoryRadar" role="img" aria-label="ê³µì¥ë³„ ë¹„êµ ë ˆì´ë” ì°¨íŠ¸"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Shipping Calendar -->
        <div id="section-calendar" class="bg-card rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4"><span aria-hidden="true">ğŸ“… </span>ì˜ˆì • ìº˜ë¦°ë” <span class="text-sm font-normal text-secondary" id="calendarLabel">(SDD ê¸°ì¤€)</span></h3>
            <div class="flex justify-between items-center mb-4">
                <button type="button" onclick="prevMonth()" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200 dark:hover:bg-gray-600" aria-label="ì´ì „ ë‹¬">â—€ ì´ì „</button>
                <span id="calendarMonth" class="font-semibold text-lg"></span>
                <button type="button" onclick="nextMonth()" class="px-3 py-1 bg-gray-100 dark:bg-gray-700 rounded hover:bg-gray-200 dark:hover:bg-gray-600" aria-label="ë‹¤ìŒ ë‹¬">ë‹¤ìŒ â–¶</button>
            </div>
            <div id="shippingCalendar" class="grid grid-cols-7 gap-2"></div>
            <div class="flex gap-4 mt-4 text-sm" role="group" aria-label="ìº˜ë¦°ë” ë²”ë¡€">
                <span><span class="inline-block w-3 h-3 bg-red-300 rounded mr-1" aria-hidden="true"></span>ì§€ì—°</span>
                <span><span class="inline-block w-3 h-3 bg-amber-200 rounded mr-1" aria-hidden="true"></span>3ì¼ ì´ë‚´</span>
                <span><span class="inline-block w-3 h-3 bg-green-200 rounded mr-1" aria-hidden="true"></span>ì •ìƒ</span>
            </div>
        </div>

        <!-- Outsole Vendor Section -->
        <div id="section-vendor" class="bg-card rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4"><span aria-hidden="true">ğŸ‘Ÿ </span>ì•„ì›ƒì†” ë²¤ë”ë³„ í˜„í™©</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div><div class="chart-container"><canvas id="vendorChart" role="img" aria-label="ì•„ì›ƒì†” ë²¤ë”ë³„ í˜„í™© ì°¨íŠ¸"></canvas></div></div>
                <div>
                    <div class="overflow-x-auto max-h-[300px]">
                        <table class="w-full text-sm" id="vendorTable">
                            <caption class="sr-only">ì•„ì›ƒì†” ë²¤ë”ë³„ ì˜¤ë” í˜„í™©</caption>
                            <thead class="bg-gray-50 dark:bg-gray-700">
                                <tr>
                                    <th scope="col" class="px-3 py-2 text-left sort-header" data-sort="vendor" data-table="vendor">ì•„ì›ƒì†” ë²¤ë”</th>
                                    <th scope="col" class="px-3 py-2 text-right sort-header" data-sort="count" data-table="vendor">ì˜¤ë”</th>
                                    <th scope="col" class="px-3 py-2 text-right sort-header" data-sort="qty" data-table="vendor">ìˆ˜ëŸ‰</th>
                                    <th scope="col" class="px-3 py-2 text-right sort-header" data-sort="rate" data-table="vendor">ì™„ë£Œìœ¨</th>
                                </tr>
                            </thead>
                            <tbody id="vendorTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Important Destinations -->
        <div id="section-destination" class="bg-card rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4"><span aria-hidden="true">ğŸ¯ </span>ì¤‘ìš” í–‰ì„ ì§€</h3>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="asiaCards"></div>
        </div>

        <!-- Filters -->
        <div id="section-filter" class="bg-card rounded-xl shadow-sm p-4 mb-6 no-print" role="search" aria-label="í•„í„° ì˜µì…˜">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-medium"><span aria-hidden="true">ğŸ” </span>í•„í„° <span class="kbd ml-2" aria-hidden="true">F</span></h4>
                <button type="button" onclick="resetAllFilters()" class="text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-1 rounded-lg transition" aria-label="ëª¨ë“  í•„í„° ì´ˆê¸°í™”" title="í•„í„° ì´ˆê¸°í™” (R)">
                    â†º í•„í„° ì´ˆê¸°í™” <span class="kbd">R</span>
                </button>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex-1 min-w-[120px]">
                    <label for="monthFilter" class="block text-sm font-medium mb-1" id="monthFilterLabel">ì›” (SDD)</label>
                    <select id="monthFilter" class="w-full border border-theme rounded-lg px-3 py-2 bg-card" onchange="onMonthFilterChange()"><option value="">ì „ì²´</option></select>
                </div>
                <div class="flex-1 min-w-[280px]">
                    <label class="block text-sm font-medium mb-1" id="dateRangeLabel"><span aria-hidden="true">ğŸ“… </span>ë‚ ì§œ ë²”ìœ„ (SDD)</label>
                    <div class="flex items-center gap-2" role="group" aria-labelledby="dateRangeLabel">
                        <input type="date" id="startDateFilter" class="flex-1 border border-theme rounded-lg px-2 py-2 bg-card text-sm" onchange="onDateRangeChange()" aria-label="ì‹œì‘ ë‚ ì§œ">
                        <span class="text-secondary" aria-hidden="true">~</span>
                        <input type="date" id="endDateFilter" class="flex-1 border border-theme rounded-lg px-2 py-2 bg-card text-sm" onchange="onDateRangeChange()" aria-label="ì¢…ë£Œ ë‚ ì§œ">
                        <button type="button" onclick="clearDateRange()" class="text-sm bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-2 rounded-lg min-w-[44px] min-h-[44px] flex items-center justify-center" title="ë‚ ì§œ ì´ˆê¸°í™”" aria-label="ë‚ ì§œ ë²”ìœ„ ì´ˆê¸°í™”">âœ•</button>
                    </div>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label for="quickDateFilter" class="block text-sm font-medium mb-1">ë¹ ë¥¸ ì„ íƒ</label>
                    <select id="quickDateFilter" class="w-full border border-theme rounded-lg px-3 py-2 bg-card" aria-label="ë¹ ë¥¸ ë‚ ì§œ ì„ íƒ">
                        <option value="">ì „ì²´ ê¸°ê°„</option>
                        <option value="today">ì˜¤ëŠ˜</option>
                        <option value="week">ì´ë²ˆ ì£¼</option>
                        <option value="month">ì´ë²ˆ ë‹¬</option>
                        <option value="delayed">ì§€ì—°ë§Œ</option>
                        <option value="warning">3ì¼ ì´ë‚´</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label for="destFilter" class="block text-sm font-medium mb-1">í–‰ì„ ì§€</label>
                    <select id="destFilter" class="w-full border border-theme rounded-lg px-3 py-2 bg-card" aria-label="í–‰ì„ ì§€ í•„í„°">
                        <option value="">ì „ì²´</option>
                        <option value="asia">ì¤‘ìš” í–‰ì„ ì§€ë§Œ</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label for="vendorFilter" class="block text-sm font-medium mb-1">ì•„ì›ƒì†” ë²¤ë”</label>
                    <select id="vendorFilter" class="w-full border border-theme rounded-lg px-3 py-2 bg-card" aria-label="ì•„ì›ƒì†” ë²¤ë” í•„í„°"><option value="">ì „ì²´</option></select>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label for="statusFilter" class="block text-sm font-medium mb-1">ì™„ë£Œ ìƒíƒœ</label>
                    <select id="statusFilter" class="w-full border border-theme rounded-lg px-3 py-2 bg-card" aria-label="ì™„ë£Œ ìƒíƒœ í•„í„°">
                        <option value="">ì „ì²´</option>
                        <option value="shipped">ğŸš¢ ì„ ì  ì™„ë£Œ</option>
                        <option value="completed">ì™„ë£Œ</option>
                        <option value="partial">ì§„í–‰ ì¤‘</option>
                        <option value="pending">ë¯¸ì‹œì‘</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[180px]">
                    <label id="factoryFilterLabel" class="block text-sm font-medium mb-1">ê³µì¥</label>
                    <div id="factoryFilter" class="flex flex-wrap gap-1" role="group" aria-labelledby="factoryFilterLabel">
                        <span class="filter-chip active" data-factory="" role="button" tabindex="0" aria-pressed="true">ì „ì²´</span>
                        <span class="filter-chip" data-factory="A" role="button" tabindex="0" aria-pressed="false">A</span>
                        <span class="filter-chip" data-factory="B" role="button" tabindex="0" aria-pressed="false">B</span>
                        <span class="filter-chip" data-factory="C" role="button" tabindex="0" aria-pressed="false">C</span>
                        <span class="filter-chip" data-factory="D" role="button" tabindex="0" aria-pressed="false">D</span>
                    </div>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label for="searchInput" class="block text-sm font-medium mb-1">í†µí•© ê²€ìƒ‰ <span class="kbd" aria-hidden="true">S</span></label>
                    <input type="text" id="searchInput" placeholder="ëª¨ë¸, PO, í–‰ì„ ì§€, ë²¤ë”..." autocomplete="off" class="w-full border border-theme rounded-lg px-3 py-2 bg-card">
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div id="section-tabs" class="bg-card rounded-xl shadow-sm mb-6">
            <div class="border-b border-theme overflow-x-auto">
                <nav class="flex -mb-px min-w-max" role="tablist" aria-label="ëŒ€ì‹œë³´ë“œ íƒ­ ë„¤ë¹„ê²Œì´ì…˜">
                    <button type="button" id="monthlyTabBtn" class="tab-btn tab-active px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="monthly" role="tab" aria-selected="true" aria-controls="monthlyTab" aria-label="ì›”ë³„ í˜„í™© íƒ­" tabindex="0"><span aria-hidden="true">ğŸ“… </span>ì›”ë³„</button>
                    <button type="button" id="destinationTabBtn" class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="destination" role="tab" aria-selected="false" aria-controls="destinationTab" aria-label="í–‰ì„ ì§€ë³„ í˜„í™© íƒ­" tabindex="-1"><span aria-hidden="true">ğŸŒ </span>í–‰ì„ ì§€ë³„</button>
                    <button type="button" id="modelTabBtn" class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="model" role="tab" aria-selected="false" aria-controls="modelTab" aria-label="ëª¨ë¸ë³„ í˜„í™© íƒ­" tabindex="-1"><span aria-hidden="true">ğŸ‘Ÿ </span>ëª¨ë¸ë³„</button>
                    <button type="button" id="factoryTabBtn" class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="factory" role="tab" aria-selected="false" aria-controls="factoryTab" aria-label="ê³µì¥ë³„ í˜„í™© íƒ­" tabindex="-1"><span aria-hidden="true">ğŸ­ </span>ê³µì¥ë³„</button>
                    <button type="button" id="vendorTabBtn" class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="vendor" role="tab" aria-selected="false" aria-controls="vendorTab" aria-label="ì•„ì›ƒì†” ë²¤ë” í˜„í™© íƒ­" tabindex="-1"><span aria-hidden="true">ğŸ”§ </span>ì•„ì›ƒì†” ë²¤ë”</button>
                    <button type="button" id="heatmapTabBtn" class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="heatmap" role="tab" aria-selected="false" aria-controls="heatmapTab" aria-label="íˆíŠ¸ë§µ íƒ­" tabindex="-1"><span aria-hidden="true">ğŸ”¥ </span>íˆíŠ¸ë§µ</button>
                    <button type="button" id="dataTabBtn" class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="data" role="tab" aria-selected="false" aria-controls="dataTab" aria-label="ìƒì„¸ ë°ì´í„° íƒ­" tabindex="-1"><span aria-hidden="true">ğŸ“‹ </span>ìƒì„¸ <span class="kbd">D</span></button>
                </nav>
            </div>
            <div id="tabContents" class="p-6">
                <!-- Monthly Tab -->
                <div id="monthlyTab" class="tab-content" role="tabpanel" aria-labelledby="monthlyTabBtn">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">ì›”ë³„ ì˜¤ë” í˜„í™©</h3><div class="chart-container"><canvas id="monthlyChart" role="img" aria-label="ì›”ë³„ ì˜¤ë” í˜„í™© ì°¨íŠ¸"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ì›”ë³„ ì™„ë£Œ í˜„í™©</h3>
                            <div class="overflow-x-auto">
                                <table class="w-full text-sm" id="monthlyTable">
                                    <caption class="sr-only">ì›”ë³„ ì™„ë£Œ í˜„í™©</caption>
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th scope="col" class="px-4 py-2 text-left sort-header" data-sort="month" data-table="monthly">ì›”</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="count" data-table="monthly">ì˜¤ë”</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="qty" data-table="monthly">ì£¼ë¬¸ëŸ‰</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="completed" data-table="monthly">ì™„ë£ŒëŸ‰</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="rate" data-table="monthly">ì™„ë£Œìœ¨</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Destination Tab -->
                <div id="destinationTab" class="tab-content hidden" role="tabpanel" aria-labelledby="destinationTabBtn">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">êµ­ê°€ë³„ ìˆ˜ëŸ‰ ë¶„í¬</h3><div class="chart-container"><canvas id="destChart" role="img" aria-label="êµ­ê°€ë³„ ìˆ˜ëŸ‰ ë¶„í¬ ì°¨íŠ¸"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">í–‰ì„ ì§€ë³„ ìƒì„¸</h3>
                            <div class="overflow-x-auto max-h-[400px]">
                                <table class="w-full text-sm" id="destTable">
                                    <caption class="sr-only">í–‰ì„ ì§€ë³„ ìƒì„¸ í˜„í™©</caption>
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th scope="col" class="px-4 py-2 text-left sort-header" data-sort="dest" data-table="dest">êµ­ê°€</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="count" data-table="dest">ê±´ìˆ˜</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="qty" data-table="dest">ìˆ˜ëŸ‰</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="completed" data-table="dest">ì™„ë£Œ</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="rate" data-table="dest">ì™„ë£Œìœ¨</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Model Tab -->
                <div id="modelTab" class="tab-content hidden" role="tabpanel" aria-labelledby="modelTabBtn">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">ëª¨ë¸ë³„ ìˆ˜ëŸ‰ (Top 15)</h3><div class="chart-container" style="height:400px"><canvas id="modelChart" role="img" aria-label="ëª¨ë¸ë³„ ìˆ˜ëŸ‰ Top 15 ì°¨íŠ¸"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ëª¨ë¸ë³„ ìƒì„¸</h3>
                            <div class="overflow-x-auto max-h-[400px]">
                                <table class="w-full text-sm" id="modelTable">
                                    <caption class="sr-only">ëª¨ë¸ë³„ ìƒì„¸ í˜„í™©</caption>
                                    <thead class="bg-gray-50 dark:bg-gray-700">
                                        <tr>
                                            <th scope="col" class="px-4 py-2 text-left sort-header" data-sort="model" data-table="model">ëª¨ë¸</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="count" data-table="model">ê±´ìˆ˜</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="qty" data-table="model">ìˆ˜ëŸ‰</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="completed" data-table="model">ì™„ë£Œ</th>
                                            <th scope="col" class="px-4 py-2 text-right sort-header" data-sort="rate" data-table="model">ì™„ë£Œìœ¨</th>
                                        </tr>
                                    </thead>
                                    <tbody></tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
                <!-- Factory Tab -->
                <div id="factoryTab" class="tab-content hidden" role="tabpanel" aria-labelledby="factoryTabBtn">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">ê³µì¥ë³„ ìˆ˜ëŸ‰ ë¹„êµ</h3><div class="chart-container"><canvas id="factoryChart" role="img" aria-label="ê³µì¥ë³„ ìˆ˜ëŸ‰ ë¹„êµ ì°¨íŠ¸"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ê³µì¥ë³„ ê³µì • í˜„í™©</h3><div id="factoryProcessDetail" class="space-y-4"></div></div>
                    </div>
                </div>
                <!-- Vendor Tab (NEW) -->
                <div id="vendorTab" class="tab-content hidden" role="tabpanel" aria-labelledby="vendorTabBtn">
                    <div class="space-y-6">
                        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                            <div><h3 class="text-lg font-semibold mb-4">ì•„ì›ƒì†” ë²¤ë”ë³„ ìˆ˜ëŸ‰</h3><div class="chart-container"><canvas id="vendorDetailChart" role="img" aria-label="ì•„ì›ƒì†” ë²¤ë”ë³„ ìˆ˜ëŸ‰ ì°¨íŠ¸"></canvas></div></div>
                            <div><h3 class="text-lg font-semibold mb-4">ì•„ì›ƒì†” ë²¤ë”ë³„ ìƒì„¸</h3>
                                <div class="overflow-x-auto max-h-[300px]">
                                    <table class="w-full text-sm" id="vendorDetailTable">
                                        <thead class="bg-gray-50 dark:bg-gray-700">
                                            <tr>
                                                <th scope="col" class="px-3 py-2 text-left sort-header" data-sort="vendor" data-table="vendorDetail">ì•„ì›ƒì†” ë²¤ë”</th>
                                                <th scope="col" class="px-3 py-2 text-right sort-header" data-sort="count" data-table="vendorDetail">ì˜¤ë”</th>
                                                <th scope="col" class="px-3 py-2 text-right sort-header" data-sort="qty" data-table="vendorDetail">ìˆ˜ëŸ‰</th>
                                                <th scope="col" class="px-3 py-2 text-right sort-header" data-sort="completed" data-table="vendorDetail">ì™„ë£Œ</th>
                                                <th scope="col" class="px-3 py-2 text-right sort-header" data-sort="rate" data-table="vendorDetail">ì™„ë£Œìœ¨</th>
                                            </tr>
                                        </thead>
                                        <tbody></tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                        <div>
                            <h3 class="text-lg font-semibold mb-4"><span aria-hidden="true">ğŸ”¥ </span>ëª¨ë¸ Ã— ì•„ì›ƒì†” ë²¤ë” íˆíŠ¸ë§µ</h3>
                            <div id="modelVendorHeatmap" class="overflow-x-auto"></div>
                        </div>
                    </div>
                </div>
                <!-- Heatmap Tab -->
                <div id="heatmapTab" class="tab-content hidden" role="tabpanel" aria-labelledby="heatmapTabBtn">
                    <div class="space-y-6">
                        <div><h3 class="text-lg font-semibold mb-4">ì¤‘ìš” í–‰ì„ ì§€ Ã— ì›”ë³„ íˆíŠ¸ë§µ</h3><div id="countryMonthHeatmap" class="overflow-x-auto"></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ëª¨ë¸ Ã— í–‰ì„ ì§€ íˆíŠ¸ë§µ</h3><div id="modelDestHeatmap" class="overflow-x-auto"></div></div>
                    </div>
                </div>
                <!-- Data Tab -->
                <div id="dataTab" class="tab-content hidden" role="tabpanel" aria-labelledby="dataTabBtn">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div>
                            <h3 class="text-lg font-semibold">ìƒì„¸ ë°ì´í„° <span id="dataCount" class="text-sm font-normal text-secondary" aria-live="polite"></span></h3>
                            <div id="pagination" class="text-sm text-secondary mt-1" aria-live="polite" aria-atomic="true"></div>
                        </div>
                        <div class="flex gap-2">
                            <button type="button" onclick="prevPage()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-1 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="prevBtn" disabled aria-disabled="true" aria-label="ì´ì „ í˜ì´ì§€">â† ì´ì „</button>
                            <button type="button" onclick="nextPage()" class="bg-gray-100 dark:bg-gray-700 hover:bg-gray-200 dark:hover:bg-gray-600 px-3 py-1 rounded text-sm disabled:opacity-50 disabled:cursor-not-allowed" id="nextBtn" aria-disabled="false" aria-label="ë‹¤ìŒ í˜ì´ì§€">ë‹¤ìŒ â†’</button>
                            <button type="button" onclick="exportToExcel()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-medium" aria-label="Excel íŒŒì¼ë¡œ ë‚´ë³´ë‚´ê¸°">ğŸ“¥ Excel</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="dataTable">
                            <caption class="sr-only">ì˜¤ë” ìƒì„¸ ë°ì´í„° í…Œì´ë¸”</caption>
                            <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                                <th scope="col" class="px-2 py-2 text-left sort-header" data-sort="factory" data-table="data">ê³µì¥</th>
                                <th scope="col" class="px-2 py-2 text-left sort-header" data-sort="po" data-table="data">PO</th>
                                <th scope="col" class="px-2 py-2 text-left sort-header" data-sort="model" data-table="data">ëª¨ë¸</th>
                                <th scope="col" class="px-2 py-2 text-left sort-header" data-sort="article" data-table="data">Article</th>
                                <th scope="col" class="px-2 py-2 text-left sort-header" data-sort="destination" data-table="data">í–‰ì„ ì§€</th>
                                <th scope="col" class="px-2 py-2 text-left">ì•„ì›ƒì†” ë²¤ë”</th>
                                <th scope="col" class="px-2 py-2 text-right sort-header" data-sort="quantity" data-table="data">ìˆ˜ëŸ‰</th>
                                <th scope="col" class="px-2 py-2 text-center">ì¬ë‹¨</th>
                                <th scope="col" class="px-2 py-2 text-center">ì¬ë´‰</th>
                                <th scope="col" class="px-2 py-2 text-center">ì¡°ë¦½</th>
                                <th scope="col" class="px-2 py-2 text-center">ì…ê³ </th>
                                <th scope="col" class="px-2 py-2 text-left sort-header" data-sort="crd" data-table="data">CRD</th>
                                <th scope="col" class="px-2 py-2 text-left sort-header" data-sort="sdd" data-table="data">SDD</th>
                                <th scope="col" class="px-2 py-2 text-center">ìƒíƒœ</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Keyboard Shortcuts Help -->
        <div class="text-center text-sm text-secondary no-print" aria-hidden="true">
            <span class="kbd">S</span> ê²€ìƒ‰ | <span class="kbd">F</span> í•„í„° | <span class="kbd">R</span> ì´ˆê¸°í™” | <span class="kbd">D</span> ìƒì„¸íƒ­ | <span class="kbd">Esc</span> ëª¨ë‹¬ë‹«ê¸° | <span class="kbd">â†â†’</span> í˜ì´ì§€
        </div>
    </div>

    <!-- Modal -->
    <div id="orderDetailModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
        <div class="bg-card rounded-xl shadow-2xl w-full max-w-5xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-theme">
                <h3 class="text-lg font-semibold" id="modalTitle">ìƒì„¸ ì •ë³´</h3>
                <button type="button" onclick="closeOrderModal()" class="text-2xl hover:text-red-500" aria-label="ëª¨ë‹¬ ë‹«ê¸°">Ã—</button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);" id="modalContent"></div>
        </div>
    </div>

    <!-- Order Detail Modal (Process Visual) -->
    <div id="orderProcessModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-card rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-theme">
                <h3 class="text-lg font-semibold" id="orderProcessTitle">ì˜¤ë” ìƒì„¸</h3>
                <button type="button" onclick="closeOrderProcessModal()" class="text-2xl hover:text-red-500" aria-label="ëª¨ë‹¬ ë‹«ê¸°">Ã—</button>
            </div>
            <div class="p-6 overflow-y-auto" style="max-height: calc(90vh - 120px);" id="orderProcessContent"></div>
        </div>
    </div>

    <!-- Help Modal - ë„ì›€ë§ ëª¨ë‹¬ -->
    <div id="helpModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="helpModalTitle">
        <div class="bg-card rounded-xl shadow-2xl w-full max-w-4xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-theme bg-gradient-to-r from-blue-600 to-indigo-600 text-white">
                <h3 id="helpModalTitle" class="text-lg font-semibold">ğŸ“– ëŒ€ì‹œë³´ë“œ ë¡œì§ ì„¤ëª…ì„œ</h3>
                <button type="button" onclick="closeHelpModal()" class="text-2xl hover:text-red-300" aria-label="ë„ì›€ë§ ë‹«ê¸°">Ã—</button>
            </div>
            <div class="p-6 overflow-y-auto text-sm" style="max-height: calc(90vh - 120px);">
                <!-- í•µì‹¬ ì§€í‘œ -->
                <section class="mb-6">
                    <h4 class="text-lg font-bold text-blue-600 dark:text-blue-400 mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ“Š </span>ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸ KPI</h4>

                    <div class="space-y-4">
                        <div class="bg-green-50 dark:bg-green-900/20 p-4 rounded-lg border-l-4 border-green-500">
                            <h5 class="font-bold text-green-700 dark:text-green-400"><span aria-hidden="true">ğŸ¯ </span>ì •ì‹œ ë‚©ê¸°ìœ¨ (OTD - On-Time Delivery)</h5>
                            <p class="mt-1"><strong>ê³µì‹:</strong> (ì„ ì ì™„ë£Œ ì¤‘ SDD â‰¤ CRDì¸ ê±´ìˆ˜) / ì „ì²´ ì„ ì ì™„ë£Œ Ã— 100</p>
                            <p class="mt-1"><strong>ì˜ë¯¸:</strong> ê³ ê° ìš”ì²­ì¼(CRD) ì´ì „ì— ì¶œê³ ëœ ë¹„ìœ¨</p>
                            <p class="mt-1"><strong>ëª©í‘œ:</strong> 95% ì´ìƒ (Green), 85-95% (Yellow), 85% ë¯¸ë§Œ (Red)</p>
                        </div>

                        <div class="bg-red-50 dark:bg-red-900/20 p-4 rounded-lg border-l-4 border-red-500">
                            <h5 class="font-bold text-red-700 dark:text-red-400"><span aria-hidden="true">ğŸ’° </span>ìœ„í—˜ ë§¤ì¶œì•¡ (Revenue at Risk)</h5>
                            <p class="mt-1"><strong>ê³µì‹:</strong> ì§€ì—° ì˜¤ë” ìˆ˜ëŸ‰ Ã— $10 (í‰ê·  ë‹¨ê°€)</p>
                            <p class="mt-1"><strong>ì˜ë¯¸:</strong> ì§€ì—°ìœ¼ë¡œ ì¸í•´ ì†ì‹¤ ìœ„í—˜ì´ ìˆëŠ” ì˜ˆìƒ ë§¤ì¶œ</p>
                            <p class="mt-1"><strong>ëª©í‘œ:</strong> $0 (ëª¨ë“  ê¸ˆì•¡ì€ ìœ„í—˜ ì‹ í˜¸)</p>
                        </div>

                        <div class="bg-blue-50 dark:bg-blue-900/20 p-4 rounded-lg border-l-4 border-blue-500">
                            <h5 class="font-bold text-blue-700 dark:text-blue-400"><span aria-hidden="true">âœ… </span>í’ˆì§ˆ ê²€ì‚¬ í•©ê²©ë¥  (AQL Pass Rate)</h5>
                            <p class="mt-1"><strong>ê³µì‹:</strong> (aql=trueì¸ ê±´ìˆ˜) / AQL ë°ì´í„° ìˆëŠ” ì „ì²´ ê±´ìˆ˜ Ã— 100</p>
                            <p class="mt-1"><strong>ì˜ë¯¸:</strong> í’ˆì§ˆ ê²€ì‚¬ë¥¼ í†µê³¼í•œ ì˜¤ë” ë¹„ìœ¨</p>
                            <p class="mt-1"><strong>ëª©í‘œ:</strong> 98% ì´ìƒ (Green), 95-98% (Yellow), 95% ë¯¸ë§Œ (Red)</p>
                        </div>

                        <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg border-l-4 border-amber-500">
                            <h5 class="font-bold text-amber-700 dark:text-amber-400"><span aria-hidden="true">âš ï¸ </span>ì˜ˆì¸¡ ë³‘ëª© ê³µì •</h5>
                            <p class="mt-1"><strong>ê³µì‹:</strong> ê° ê³µì •ë³„ ì™„ë£Œìœ¨ ê³„ì‚° â†’ ìµœì € ì™„ë£Œìœ¨ ê³µì • ì‹ë³„</p>
                            <p class="mt-1"><strong>ì˜ë¯¸:</strong> ê°€ì¥ ì§€ì—°ì´ ë§ì´ ë°œìƒí•  ê²ƒìœ¼ë¡œ ì˜ˆì¸¡ë˜ëŠ” ê³µì •</p>
                            <p class="mt-1"><strong>ì¡°ì¹˜:</strong> í•´ë‹¹ ê³µì •ì— ìì› ì§‘ì¤‘ ë°°ì¹˜ í•„ìš”</p>
                        </div>
                    </div>
                </section>

                <!-- ì§€ì—° íŒì • ë¡œì§ -->
                <section class="mb-6">
                    <h4 class="text-lg font-bold text-red-600 dark:text-red-400 mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸš¨ </span>ì§€ì—° íŒì • ë¡œì§</h4>
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <pre class="text-xs overflow-x-auto">
function isDelayed(d) {
    // Code04 ìŠ¹ì¸ëœ ê²½ìš° ì§€ì—° ì•„ë‹˜
    if (d.code04) return false;

    // SDDì™€ CRD ë¹„êµ
    const sdd = parseDate(d.sddValue);  // ì˜ˆì • ì¶œê³ ì¼
    const crd = parseDate(d.crd);        // ê³ ê° ìš”ì²­ì¼

    // SDDê°€ CRDë³´ë‹¤ ëŠ¦ìœ¼ë©´ ì§€ì—°
    return sdd > crd;
}</pre>
                        <p class="mt-2 text-secondary"><strong>í•µì‹¬:</strong> SDD(Scheduled Delivery Date) > CRD(Customer Required Date)ì´ë©´ ì§€ì—°</p>
                    </div>
                </section>

                <!-- ê²½ê³  íŒì • ë¡œì§ -->
                <section class="mb-6">
                    <h4 class="text-lg font-bold text-amber-600 dark:text-amber-400 mb-3 flex items-center gap-2"><span aria-hidden="true">âš¡ </span>ê²½ê³  (3ì¼ ë‚´ ì˜ˆì •) íŒì • ë¡œì§</h4>
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <pre class="text-xs overflow-x-auto">
function isWarning(d) {
    // ì´ë¯¸ ì§€ì—°ì´ë©´ ê²½ê³  ì•„ë‹˜ (ì§€ì—°ì´ ë” ì‹¬ê°)
    if (isDelayed(d)) return false;

    const today = new Date();
    const sdd = parseDate(d.sddValue);

    // 3ì¼ ì´ë‚´ ì˜ˆì •ì´ë©´ ê²½ê³ 
    const diffDays = (sdd - today) / (1000 * 60 * 60 * 24);
    return diffDays >= 0 && diffDays <= 3;
}</pre>
                    </div>
                </section>

                <!-- ì„ ì  ì™„ë£Œ íŒì • -->
                <section class="mb-6">
                    <h4 class="text-lg font-bold text-emerald-600 dark:text-emerald-400 mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸš¢ </span>ì„ ì  ì™„ë£Œ íŒì • ë¡œì§</h4>
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <pre class="text-xs overflow-x-auto">
function isShipped(d) {
    const whOutCompleted = d.production?.wh_out?.completed || 0;
    const qty = d.quantity || 0;

    // ì°½ê³ ì¶œê³  ì™„ë£ŒëŸ‰ >= ì£¼ë¬¸ìˆ˜ëŸ‰ì´ë©´ ì„ ì  ì™„ë£Œ
    return qty > 0 && whOutCompleted >= qty;
}</pre>
                    </div>
                </section>

                <!-- ìƒì‚° ê³µì • ìˆœì„œ -->
                <section class="mb-6">
                    <h4 class="text-lg font-bold text-purple-600 dark:text-purple-400 mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ­ </span>ìƒì‚° ê³µì • ìˆœì„œ</h4>
                    <div class="bg-purple-50 dark:bg-purple-900/20 p-4 rounded-lg">
                        <div class="flex flex-wrap items-center gap-2 text-sm">
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">S_CUT (ì¬ë‹¨)</span>
                            <span aria-hidden="true">â†’</span>
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">PRE_SEW (ì„ ë´‰)</span>
                            <span aria-hidden="true">â†’</span>
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">SEW_INPUT (ì¬ë´‰íˆ¬ì…)</span>
                            <span aria-hidden="true">â†’</span>
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">SEW_BAL (ì¬ë´‰)</span>
                            <span aria-hidden="true">â†’</span>
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">OSC (ì™¸ì£¼)</span>
                            <span aria-hidden="true">â†’</span>
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">ASS (ì¡°ë¦½)</span>
                            <span aria-hidden="true">â†’</span>
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">WH_IN (ì°½ê³ ì…ê³ )</span>
                            <span aria-hidden="true">â†’</span>
                            <span class="px-3 py-1 bg-purple-100 dark:bg-purple-800 rounded">WH_OUT (ì°½ê³ ì¶œê³ )</span>
                        </div>
                    </div>
                </section>

                <!-- ë²¤ë” ì„±ê³¼ ì ìˆ˜ -->
                <section class="mb-6">
                    <h4 class="text-lg font-bold text-indigo-600 dark:text-indigo-400 mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ† </span>ë²¤ë” ì„±ê³¼ ì ìˆ˜ ê³„ì‚°</h4>
                    <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                        <pre class="text-xs overflow-x-auto">
// ë²¤ë” ì„±ê³¼ ì ìˆ˜ = (ì™„ë£Œìœ¨ Ã— 0.7) - (ì§€ì—°ìœ¨ Ã— 0.3)
function calculateVendorScore(vendor) {
    const completionRate = (completed / total) * 100;
    const delayRate = (delayed / total) * 100;
    return (completionRate * 0.7) - (delayRate * 0.3);
}

// í•´ì„:
// 80ì  ì´ìƒ: ìš°ìˆ˜ (Green)
// 50-80ì : ë³´í†µ (Yellow)
// 50ì  ë¯¸ë§Œ: ê°œì„  í•„ìš” (Red)</pre>
                    </div>
                </section>

                <!-- ì§€ì—° ì‹¬ê°ë„ ë¶„ë¥˜ -->
                <section class="mb-6">
                    <h4 class="text-lg font-bold text-gray-600 dark:text-gray-400 mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ“‰ </span>ì§€ì—° ì‹¬ê°ë„ ë¶„ë¥˜</h4>
                    <div class="grid grid-cols-3 gap-3">
                        <div class="bg-green-100 dark:bg-green-900/30 p-3 rounded text-center">
                            <div class="text-2xl mb-1" aria-hidden="true">ğŸŸ¢</div>
                            <div class="font-bold text-green-700 dark:text-green-400">ê²½ë¯¸</div>
                            <div class="text-xs">1-3ì¼ ì§€ì—°</div>
                        </div>
                        <div class="bg-amber-100 dark:bg-amber-900/30 p-3 rounded text-center">
                            <div class="text-2xl mb-1" aria-hidden="true">ğŸŸ¡</div>
                            <div class="font-bold text-amber-700 dark:text-amber-400">ì£¼ì˜</div>
                            <div class="text-xs">4-7ì¼ ì§€ì—°</div>
                        </div>
                        <div class="bg-red-100 dark:bg-red-900/30 p-3 rounded text-center">
                            <div class="text-2xl mb-1" aria-hidden="true">ğŸ”´</div>
                            <div class="font-bold text-red-700 dark:text-red-400">ì‹¬ê°</div>
                            <div class="text-xs">7ì¼+ ì§€ì—°</div>
                        </div>
                    </div>
                </section>

                <!-- ì£¼ìš” í•„ë“œ ì„¤ëª… -->
                <section>
                    <h4 class="text-lg font-bold text-gray-600 dark:text-gray-400 mb-3 flex items-center gap-2"><span aria-hidden="true">ğŸ“‹ </span>ì£¼ìš” ë°ì´í„° í•„ë“œ</h4>
                    <table class="w-full text-xs">
                        <caption class="sr-only">ë°ì´í„° í•„ë“œ ìš©ì–´ ì„¤ëª…</caption>
                        <thead class="bg-gray-100 dark:bg-gray-700">
                            <tr>
                                <th scope="col" class="p-2 text-left">í•„ë“œ</th>
                                <th scope="col" class="p-2 text-left">ì„¤ëª…</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                            <tr><td class="p-2 font-mono">SDD</td><td class="p-2">Scheduled Delivery Date - ì˜ˆì • ì¶œê³ ì¼</td></tr>
                            <tr><td class="p-2 font-mono">CRD</td><td class="p-2">Customer Required Date - ê³ ê° ìš”ì²­ì¼</td></tr>
                            <tr><td class="p-2 font-mono">Code04</td><td class="p-2">ì§€ì—° ìŠ¹ì¸ ì—¬ë¶€ (trueë©´ ì§€ì—°ìœ¼ë¡œ ë³´ì§€ ì•ŠìŒ)</td></tr>
                            <tr><td class="p-2 font-mono">AQL</td><td class="p-2">Acceptable Quality Level - í’ˆì§ˆ ê²€ì‚¬ í†µê³¼ ì—¬ë¶€</td></tr>
                            <tr><td class="p-2 font-mono">remaining</td><td class="p-2">ê° ê³µì •ë³„ ì”ëŸ‰ (quantity - completed)</td></tr>
                            <tr><td class="p-2 font-mono">outsoleVendor</td><td class="p-2">ì•„ì›ƒì†” ê³µê¸‰ ë²¤ë”</td></tr>
                        </tbody>
                    </table>
                </section>
            </div>
        </div>
    </div>

    <!-- PO ë“±ë¡ ëª¨ë‹¬ -->
    <div id="poRegisterModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="poRegisterModalTitle">
        <div class="bg-card rounded-xl shadow-2xl w-full max-w-lg max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-theme bg-gradient-to-r from-sky-500 to-blue-600 text-white">
                <h3 id="poRegisterModalTitle" class="text-lg font-semibold"><span aria-hidden="true">â­ </span>ê´€ì‹¬ PO ë“±ë¡</h3>
                <button type="button" onclick="closePoRegisterModal()" class="text-2xl hover:text-red-300" aria-label="PO ë“±ë¡ ëª¨ë‹¬ ë‹«ê¸°">Ã—</button>
            </div>
            <div class="p-6">
                <div class="mb-4">
                    <label for="poRegisterInput" class="block text-sm font-medium mb-2">PO ë²ˆí˜¸ ì…ë ¥</label>
                    <input type="text" id="poRegisterInput" required aria-required="true" autocomplete="off"
                        class="w-full px-4 py-3 border border-theme rounded-lg focus:ring-2 focus:ring-blue-500 focus:border-transparent bg-card"
                        placeholder="ì˜ˆ: 4501234567" aria-describedby="poRegisterHint">
                    <div id="poRegisterHint" class="mt-2 text-sm text-gray-500"></div>
                </div>

                <!-- PO ê²€ìƒ‰ ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸° -->
                <div id="poPreview" class="hidden mb-4 p-4 bg-gray-50 dark:bg-gray-800 rounded-lg" role="status" aria-live="polite">
                    <div class="text-sm font-medium text-green-600 dark:text-green-400 mb-2"><span aria-hidden="true">âœ… </span>PO ì°¾ìŒ</div>
                    <div id="poPreviewContent" class="text-sm space-y-1"></div>
                </div>

                <!-- PO ì°¾ì§€ ëª»í•¨ -->
                <div id="poNotFound" class="hidden mb-4 p-4 bg-red-50 dark:bg-red-900/20 rounded-lg" role="alert" aria-live="assertive">
                    <div class="text-sm font-medium text-red-600 dark:text-red-400"><span aria-hidden="true">âŒ </span>í•´ë‹¹ POë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="text-xs text-gray-500 mt-1">ì—…ë¡œë“œëœ ë°ì´í„°ì—ì„œ PO ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</div>
                </div>

                <!-- ì•Œë¦¼ ì„¤ì • -->
                <div class="mb-4 p-4 bg-amber-50 dark:bg-amber-900/20 rounded-lg">
                    <label class="flex items-center gap-3 cursor-pointer">
                        <input type="checkbox" id="poAlertCheckbox" checked class="w-5 h-5 text-blue-600 rounded" aria-label="ì²« íˆ¬ì… ì‹œì‘ ì•Œë¦¼ í™œì„±í™”">
                        <div>
                            <div class="font-medium text-amber-800 dark:text-amber-200"><span aria-hidden="true">ğŸ”” </span>ì²« íˆ¬ì… ì‹œì‘ ì•Œë¦¼</div>
                            <div class="text-xs text-amber-600 dark:text-amber-400">ì¬ë‹¨(S_CUT) ê³µì •ì´ ì‹œì‘ë˜ë©´ ì•Œë¦¼ì„ í‘œì‹œí•©ë‹ˆë‹¤</div>
                        </div>
                    </label>
                </div>

                <div class="flex gap-3">
                    <button type="button" onclick="closePoRegisterModal()" class="flex-1 px-4 py-3 border border-theme rounded-lg hover:bg-gray-100 dark:hover:bg-gray-700 transition-colors" aria-label="PO ë“±ë¡ ì·¨ì†Œ">
                        ì·¨ì†Œ
                    </button>
                    <button type="button" id="poRegisterSubmit" onclick="registerWatchedPo()" disabled
                        class="flex-1 px-4 py-3 bg-blue-600 text-white rounded-lg hover:bg-blue-700 transition-colors disabled:opacity-50 disabled:cursor-not-allowed" aria-label="ê´€ì‹¬ PO ë“±ë¡ ì™„ë£Œ">
                        ë“±ë¡í•˜ê¸°
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- PO ìƒì„¸ ëª¨ë‹¬ -->
    <div id="watchedPoDetailModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4" role="dialog" aria-modal="true" aria-labelledby="watchedPoDetailTitle">
        <div class="bg-card rounded-xl shadow-2xl w-full max-w-2xl max-h-[90vh] overflow-hidden">
            <div class="flex justify-between items-center p-4 border-b border-theme bg-gradient-to-r from-sky-500 to-blue-600 text-white">
                <h3 id="watchedPoDetailTitle" class="text-lg font-semibold"><span aria-hidden="true">â­ </span>PO ìƒì„¸ í˜„í™©</h3>
                <button type="button" onclick="closeWatchedPoDetailModal()" class="text-2xl hover:text-red-300" aria-label="PO ìƒì„¸ ëª¨ë‹¬ ë‹«ê¸°">Ã—</button>
            </div>
            <div id="watchedPoDetailContent" class="p-6 overflow-y-auto" style="max-height: calc(90vh - 70px);">
                <!-- ìƒì„¸ ë‚´ìš©ì´ ë™ì ìœ¼ë¡œ ì±„ì›Œì§ -->
            </div>
        </div>
    </div>

    <!-- ì ‘ê·¼ì„± ê°œì„ ëœ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ -->
    <div id="confirmDialog" class="fixed inset-0 modal-overlay z-[60] hidden flex items-center justify-center p-4" role="alertdialog" aria-modal="true" aria-labelledby="confirmDialogTitle" aria-describedby="confirmDialogMessage">
        <div class="bg-card rounded-xl shadow-2xl w-full max-w-sm">
            <div class="p-6">
                <h3 id="confirmDialogTitle" class="text-lg font-semibold text-center mb-4">í™•ì¸</h3>
                <p id="confirmDialogMessage" class="text-secondary text-center mb-6"></p>
                <div class="flex gap-3 justify-center">
                    <button type="button" id="confirmDialogCancel" class="px-4 py-2 bg-gray-200 dark:bg-gray-700 hover:bg-gray-300 dark:hover:bg-gray-600 rounded-lg transition" aria-label="ì·¨ì†Œ">ì·¨ì†Œ</button>
                    <button type="button" id="confirmDialogConfirm" class="px-4 py-2 bg-red-500 hover:bg-red-600 text-white rounded-lg transition" aria-label="í™•ì¸">ì‚­ì œ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Data and state
        let allData = [];
        let filteredData = [];
        let currentPage = 1;
        const PAGE_SIZE = 50;
        let currentCalendarDate = new Date();
        let charts = {};
        let dateMode = 'sdd'; // 'sdd' or 'crd'
        let dateRangeFilter = 'all'; // 'all', 'week', 'month'

        // Sidebar state
        let sidebarOpen = false;

        // Watched PO state
        let watchedPos = [];
        const WATCHED_PO_KEY = 'rachgia_watched_pos';

        // Confirm dialog state
        let confirmDialogCallback = null;

        // Load watched POs from localStorage
        function loadWatchedPos() {
            try {
                const saved = localStorage.getItem(WATCHED_PO_KEY);
                watchedPos = saved ? JSON.parse(saved) : [];
            } catch (e) {
                console.error('Failed to load watched POs:', e);
                watchedPos = [];
            }
        }

        // Save watched POs to localStorage
        function saveWatchedPos() {
            try {
                localStorage.setItem(WATCHED_PO_KEY, JSON.stringify(watchedPos));
            } catch (e) {
                console.error('Failed to save watched POs:', e);
            }
        }

        // Open PO register modal
        function openPoRegisterModal() {
            document.getElementById('poRegisterModal').classList.remove('hidden');
            document.getElementById('poRegisterInput').value = '';
            document.getElementById('poPreview').classList.add('hidden');
            document.getElementById('poNotFound').classList.add('hidden');
            document.getElementById('poRegisterSubmit').disabled = true;
            document.getElementById('poRegisterInput').focus();
        }

        // Close PO register modal
        function closePoRegisterModal() {
            document.getElementById('poRegisterModal').classList.add('hidden');
        }

        // ì ‘ê·¼ì„± ê°œì„ ëœ í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ í‘œì‹œ
        function showConfirmDialog(message, onConfirm) {
            const dialog = document.getElementById('confirmDialog');
            const messageEl = document.getElementById('confirmDialogMessage');
            const confirmBtn = document.getElementById('confirmDialogConfirm');
            const cancelBtn = document.getElementById('confirmDialogCancel');

            messageEl.textContent = message;
            confirmDialogCallback = onConfirm;
            dialog.classList.remove('hidden');

            // í¬ì»¤ìŠ¤ íŠ¸ë© ì„¤ì •
            trapFocus(dialog);
            confirmBtn.focus();

            // ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ (í•œ ë²ˆë§Œ ì‹¤í–‰)
            const handleConfirm = () => {
                hideConfirmDialog();
                if (confirmDialogCallback) confirmDialogCallback();
            };
            const handleCancel = () => {
                hideConfirmDialog();
            };
            const handleKeydown = (e) => {
                if (e.key === 'Escape') {
                    hideConfirmDialog();
                } else if (e.key === 'Enter' && document.activeElement === confirmBtn) {
                    handleConfirm();
                }
            };

            // ê¸°ì¡´ ë¦¬ìŠ¤ë„ˆ ì œê±° í›„ ìƒˆë¡œ ì¶”ê°€
            confirmBtn.onclick = handleConfirm;
            cancelBtn.onclick = handleCancel;
            dialog.onkeydown = handleKeydown;
        }

        // í™•ì¸ ë‹¤ì´ì–¼ë¡œê·¸ ìˆ¨ê¸°ê¸°
        function hideConfirmDialog() {
            const dialog = document.getElementById('confirmDialog');
            dialog.classList.add('hidden');
            confirmDialogCallback = null;
            releaseFocus();
        }

        // Search PO as user types
        function searchPoForRegister(poNumber) {
            const trimmed = poNumber.trim();
            const preview = document.getElementById('poPreview');
            const notFound = document.getElementById('poNotFound');
            const submitBtn = document.getElementById('poRegisterSubmit');

            if (trimmed.length < 3) {
                preview.classList.add('hidden');
                notFound.classList.add('hidden');
                submitBtn.disabled = true;
                return;
            }

            // Find matching POs in allData
            const matches = allData.filter(d => d.poNumber && d.poNumber.includes(trimmed));

            if (matches.length > 0) {
                // Check if already registered
                const alreadyRegistered = watchedPos.some(wp => wp.poNumber === matches[0].poNumber);

                if (alreadyRegistered) {
                    notFound.classList.remove('hidden');
                    notFound.innerHTML = '<div class="text-sm font-medium text-amber-600 dark:text-amber-400"><span aria-hidden="true">âš ï¸ </span>ì´ë¯¸ ë“±ë¡ëœ POì…ë‹ˆë‹¤</div>';
                    preview.classList.add('hidden');
                    submitBtn.disabled = true;
                    return;
                }

                preview.classList.remove('hidden');
                notFound.classList.add('hidden');
                submitBtn.disabled = false;

                // Show preview of first match
                const d = matches[0];
                const totalQty = matches.reduce((sum, m) => sum + (m.quantity || 0), 0);
                document.getElementById('poPreviewContent').innerHTML = `
                    <div><strong>PO:</strong> ${escapeHtml(d.poNumber)}</div>
                    <div><strong>ëª¨ë¸:</strong> ${escapeHtml(d.model || '-')}</div>
                    <div><strong>ê³µì¥:</strong> ${escapeHtml(d.factory || '-')}</div>
                    <div><strong>í–‰ì„ ì§€:</strong> ${escapeHtml(d.destination || '-')}</div>
                    <div><strong>ìˆ˜ëŸ‰:</strong> ${formatNumber(totalQty)}ì¡± (${matches.length}ê±´)</div>
                    <div><strong>CRD:</strong> ${d.crd || '-'}</div>
                `;
            } else {
                preview.classList.add('hidden');
                notFound.classList.remove('hidden');
                notFound.innerHTML = `
                    <div class="text-sm font-medium text-red-600 dark:text-red-400"><span aria-hidden="true">âŒ </span>í•´ë‹¹ POë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                    <div class="text-xs text-gray-500 mt-1">ì—…ë¡œë“œëœ ë°ì´í„°ì—ì„œ PO ë²ˆí˜¸ë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”</div>
                `;
                submitBtn.disabled = true;
            }
        }

        // Register a watched PO
        function registerWatchedPo() {
            const poNumber = document.getElementById('poRegisterInput').value.trim();
            const alertEnabled = document.getElementById('poAlertCheckbox').checked;

            if (!poNumber) return;

            // Find matching data
            const matches = allData.filter(d => d.poNumber && d.poNumber.includes(poNumber));
            if (matches.length === 0) return;

            const firstMatch = matches[0];

            // Check current production status
            const hasStarted = firstMatch.production?.s_cut?.completed > 0;

            const watchedPo = {
                poNumber: firstMatch.poNumber,
                model: firstMatch.model,
                factory: firstMatch.factory,
                destination: firstMatch.destination,
                alertEnabled: alertEnabled,
                registeredAt: new Date().toISOString(),
                alertShown: hasStarted, // If already started, don't show alert
                lastStatus: {
                    s_cut: firstMatch.production?.s_cut?.status || 'pending',
                    hasStarted: hasStarted
                }
            };

            watchedPos.push(watchedPo);
            saveWatchedPos();
            updateWatchedPoDisplay();
            closePoRegisterModal();

            // Show success message
            showToast(`<span aria-hidden="true">âœ… </span>PO ${escapeHtml(firstMatch.poNumber)} ë“±ë¡ ì™„ë£Œ`);
        }

        // Remove a watched PO
        function removeWatchedPo(poNumber) {
            showConfirmDialog(`PO ${poNumber}ì„(ë¥¼) ê´€ì‹¬ ëª©ë¡ì—ì„œ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`, () => {
                watchedPos = watchedPos.filter(wp => wp.poNumber !== poNumber);
                saveWatchedPos();
                updateWatchedPoDisplay();
            });
        }

        // Update watched PO display
        function updateWatchedPoDisplay() {
            const emptyEl = document.getElementById('watchedPoEmpty');
            const gridEl = document.getElementById('watchedPoGrid');
            const countEl = document.getElementById('watchedPoCount');
            const alertBadge = document.getElementById('watchedPoAlertBadge');
            const lastUpdateEl = document.getElementById('watchedPoLastUpdate');

            countEl.textContent = watchedPos.length;
            lastUpdateEl.textContent = `ì—…ë°ì´íŠ¸: ${new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' })}`;

            if (watchedPos.length === 0) {
                emptyEl.classList.remove('hidden');
                gridEl.classList.add('hidden');
                alertBadge.classList.add('hidden');
                return;
            }

            emptyEl.classList.add('hidden');
            gridEl.classList.remove('hidden');

            let hasAlert = false;
            let cardsHtml = '';

            watchedPos.forEach(wp => {
                // Find current data for this PO
                const matches = allData.filter(d => d.poNumber === wp.poNumber);

                if (matches.length === 0) {
                    cardsHtml += createWatchedPoCard(wp, null, false);
                    return;
                }

                // Aggregate production data
                const totalQty = matches.reduce((sum, d) => sum + (d.quantity || 0), 0);
                const aggregatedProd = {
                    s_cut: { completed: 0, pending: 0 },
                    pre_sew: { completed: 0, pending: 0 },
                    sew_input: { completed: 0, pending: 0 },
                    sew_bal: { completed: 0, pending: 0 },
                    osc: { completed: 0, pending: 0 },
                    ass_bal: { completed: 0, pending: 0 },
                    wh_in: { completed: 0, pending: 0 },
                    wh_out: { completed: 0, pending: 0 }
                };

                matches.forEach(m => {
                    Object.keys(aggregatedProd).forEach(stage => {
                        if (m.production?.[stage]) {
                            aggregatedProd[stage].completed += m.production[stage].completed || 0;
                            aggregatedProd[stage].pending += m.production[stage].pending || 0;
                        }
                    });
                });

                // Check for first input alert
                const currentlyStarted = aggregatedProd.s_cut.completed > 0;
                const shouldAlert = wp.alertEnabled && currentlyStarted && !wp.alertShown;

                if (shouldAlert) {
                    hasAlert = true;
                    // Mark alert as shown
                    wp.alertShown = true;
                    saveWatchedPos();

                    // Show notification
                    showFirstInputNotification(wp, aggregatedProd);
                }

                const prodData = {
                    totalQty,
                    matches: matches.length,
                    firstMatch: matches[0],
                    production: aggregatedProd
                };

                cardsHtml += createWatchedPoCard(wp, prodData, shouldAlert);
            });

            gridEl.innerHTML = cardsHtml;

            if (hasAlert) {
                alertBadge.classList.remove('hidden');
            } else {
                alertBadge.classList.add('hidden');
            }
        }

        // Create watched PO card HTML
        function createWatchedPoCard(wp, prodData, showAlert) {
            if (!prodData) {
                return `
                    <div class="watched-po-card relative opacity-60">
                        <button type="button" class="po-remove-btn" onclick="event.stopPropagation(); removeWatchedPo('${escapeHtml(wp.poNumber)}')" aria-label="ê´€ì‹¬ PO ì‚­ì œ">Ã—</button>
                        <div class="font-bold text-lg mb-1">${escapeHtml(wp.poNumber)}</div>
                        <div class="text-sm text-gray-500">ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="text-xs text-gray-400 mt-2">íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”</div>
                    </div>
                `;
            }

            const { totalQty, matches, firstMatch, production } = prodData;
            const completionRate = totalQty > 0 ? Math.min((production.wh_in.completed / totalQty) * 100, 100).toFixed(1) : 0;
            const alertClass = showAlert ? 'alert' : '';

            // Determine current stage
            let currentStage = 'ëŒ€ê¸°ì¤‘';
            const stages = ['s_cut', 'pre_sew', 'sew_input', 'sew_bal', 'osc', 'ass_bal', 'wh_in', 'wh_out'];
            const stageNames = ['ì¬ë‹¨', 'ì„ ë´‰', 'ì¬ë´‰íˆ¬ì…', 'ì¬ë´‰', 'ì™¸ì£¼', 'ì¡°ë¦½', 'ì…ê³ ', 'ì¶œê³ '];

            for (let i = stages.length - 1; i >= 0; i--) {
                if (production[stages[i]].completed > 0) {
                    currentStage = stageNames[i];
                    break;
                }
            }

            // Progress stages
            const progressHtml = stages.map(stage => {
                const stageData = production[stage];
                const rate = totalQty > 0 ? (stageData.completed / totalQty) : 0;
                let statusClass = 'pending';
                if (rate >= 1) statusClass = 'completed';
                else if (rate > 0) statusClass = 'partial';
                return `<div class="watched-po-stage ${statusClass}" title="${stageNames[stages.indexOf(stage)]}: ${(rate * 100).toFixed(0)}%"></div>`;
            }).join('');

            return `
                <div class="watched-po-card relative ${alertClass}" onclick="showWatchedPoDetail('${escapeHtml(wp.poNumber)}')" role="button" tabindex="0" aria-label="${escapeHtml(wp.poNumber)} PO ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showWatchedPoDetail('${escapeHtml(wp.poNumber)}')">
                    <button type="button" class="po-remove-btn" onclick="event.stopPropagation(); removeWatchedPo('${escapeHtml(wp.poNumber)}')" aria-label="ê´€ì‹¬ PO ì‚­ì œ">Ã—</button>

                    ${showAlert ? '<div class="first-input-badge absolute top-2 left-2" aria-hidden="true">ğŸ”” íˆ¬ì… ì‹œì‘!</div>' : ''}

                    <div class="flex justify-between items-start mb-2">
                        <div>
                            <div class="font-bold text-lg">${escapeHtml(wp.poNumber)}</div>
                            <div class="text-sm text-gray-600 dark:text-gray-400">${escapeHtml(firstMatch.model || '-')}</div>
                        </div>
                        <div class="text-right">
                            <div class="text-2xl font-bold ${completionRate >= 100 ? 'text-green-600' : 'text-blue-600'}">${completionRate}%</div>
                            <div class="text-xs text-gray-500">ì™„ë£Œìœ¨</div>
                        </div>
                    </div>

                    <div class="grid grid-cols-2 gap-2 text-sm mb-3">
                        <div><span class="text-gray-500">ê³µì¥:</span> ${escapeHtml(firstMatch.factory || '-')}</div>
                        <div><span class="text-gray-500">í–‰ì„ ì§€:</span> ${escapeHtml(firstMatch.destination || '-')}</div>
                        <div><span class="text-gray-500">ìˆ˜ëŸ‰:</span> ${formatNumber(totalQty)}ì¡±</div>
                        <div><span class="text-gray-500">í˜„ì¬:</span> <strong>${currentStage}</strong></div>
                    </div>

                    <div class="text-xs text-gray-500 mb-1">ê³µì • ì§„í–‰ë¥ </div>
                    <div class="watched-po-progress">${progressHtml}</div>

                    <div class="flex justify-between text-xs text-gray-400 mt-1">
                        <span>ì¬ë‹¨</span>
                        <span>ì¶œê³ </span>
                    </div>
                </div>
            `;
        }

        // Show first input notification
        function showFirstInputNotification(wp, production) {
            // Create notification element
            const notif = document.createElement('div');
            notif.className = 'fixed top-4 right-4 bg-amber-500 text-white px-6 py-4 rounded-xl shadow-2xl z-[100] animate-pulse max-w-sm';
            notif.setAttribute('role', 'alert');
            notif.setAttribute('aria-live', 'assertive');
            notif.setAttribute('aria-atomic', 'true');
            notif.innerHTML = `
                <div class="flex items-start gap-3">
                    <span class="text-3xl" aria-hidden="true">ğŸ””</span>
                    <div>
                        <div class="font-bold text-lg">ìƒì‚° ì‹œì‘ ì•Œë¦¼!</div>
                        <div class="text-sm mt-1">PO ${escapeHtml(wp.poNumber)}</div>
                        <div class="text-xs mt-1 opacity-80">${escapeHtml(wp.model || '')} - ì¬ë‹¨ ê³µì • ì‹œì‘ë¨</div>
                        <div class="text-xs mt-2 opacity-60">ì™„ë£ŒëŸ‰: ${formatNumber(production.s_cut.completed)}ì¡±</div>
                    </div>
                    <button type="button" onclick="this.parentElement.parentElement.remove()" class="text-white hover:text-red-200 text-xl ml-2" aria-label="ì•Œë¦¼ ë‹«ê¸°">Ã—</button>
                </div>
            `;
            document.body.appendChild(notif);

            // Auto remove after 10 seconds
            setTimeout(() => {
                notif.remove();
            }, 10000);

            // Play notification sound if supported
            try {
                const audio = new Audio('data:audio/wav;base64,UklGRnoGAABXQVZFZm10IBAAAAABAAEAQB8AAEAfAAABAAgAZGF0YQoGAACBhYqFbF1fdJawoJZmXnSflZBvaGd0jZCIfHd3gH1+gIaKi4eDf3t2dHd9g4qOj42Kh4J9eHZ1dn2DioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioqKioo=');
                audio.volume = 0.5;
                audio.play().catch(() => {}); // Ignore errors if autoplay is blocked
            } catch (e) {}
        }

        // Show watched PO detail modal
        function showWatchedPoDetail(poNumber) {
            const matches = allData.filter(d => d.poNumber === poNumber);
            const wp = watchedPos.find(w => w.poNumber === poNumber);

            if (matches.length === 0) {
                showErrorToast('<span aria-hidden="true">âŒ </span>PO ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.');
                return;
            }

            document.getElementById('watchedPoDetailTitle').innerHTML = `<span aria-hidden="true">â­ </span>PO ${escapeHtml(poNumber)} ìƒì„¸ í˜„í™©`;

            // Aggregate data
            const totalQty = matches.reduce((sum, d) => sum + (d.quantity || 0), 0);
            const stages = ['s_cut', 'pre_sew', 'sew_input', 'sew_bal', 'osc', 'ass_bal', 'wh_in', 'wh_out'];
            const stageNames = ['ì¬ë‹¨', 'ì„ ë´‰', 'ì¬ë´‰íˆ¬ì…', 'ì¬ë´‰', 'ì™¸ì£¼', 'ì¡°ë¦½', 'ì…ê³ ', 'ì¶œê³ '];

            const aggregatedProd = {};
            stages.forEach(stage => {
                aggregatedProd[stage] = { completed: 0, pending: 0 };
            });

            matches.forEach(m => {
                stages.forEach(stage => {
                    if (m.production?.[stage]) {
                        aggregatedProd[stage].completed += m.production[stage].completed || 0;
                        aggregatedProd[stage].pending += m.production[stage].pending || 0;
                    }
                });
            });

            const firstMatch = matches[0];

            let html = `
                <div class="space-y-6">
                    <!-- ê¸°ë³¸ ì •ë³´ -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">PO ë²ˆí˜¸</div>
                            <div class="font-bold">${escapeHtml(poNumber)}</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">ëª¨ë¸</div>
                            <div class="font-bold">${escapeHtml(firstMatch.model || '-')}</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">ê³µì¥</div>
                            <div class="font-bold">${escapeHtml(firstMatch.factory || '-')}</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-3 rounded-lg">
                            <div class="text-xs text-gray-500">í–‰ì„ ì§€</div>
                            <div class="font-bold">${escapeHtml(firstMatch.destination || '-')}</div>
                        </div>
                    </div>

                    <!-- ìˆ˜ëŸ‰ ì •ë³´ -->
                    <div class="grid grid-cols-3 gap-4">
                        <div class="bg-blue-50 dark:bg-blue-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-blue-600">${formatNumber(totalQty)}</div>
                            <div class="text-sm text-gray-500">ì´ ì£¼ë¬¸ëŸ‰</div>
                        </div>
                        <div class="bg-green-50 dark:bg-green-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-green-600">${formatNumber(aggregatedProd.wh_in.completed)}</div>
                            <div class="text-sm text-gray-500">ì…ê³  ì™„ë£Œ</div>
                        </div>
                        <div class="bg-amber-50 dark:bg-amber-900/30 p-4 rounded-lg text-center">
                            <div class="text-2xl font-bold text-amber-600">${formatNumber(totalQty - aggregatedProd.wh_in.completed)}</div>
                            <div class="text-sm text-gray-500">ì”ëŸ‰</div>
                        </div>
                    </div>

                    <!-- ë‚ ì§œ ì •ë³´ -->
                    <div class="grid grid-cols-2 gap-4">
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                            <div class="text-sm text-gray-500">CRD (ê³ ê°ìš”ì²­ì¼)</div>
                            <div class="font-bold text-lg">${firstMatch.crd || '-'}</div>
                        </div>
                        <div class="bg-gray-50 dark:bg-gray-800 p-4 rounded-lg">
                            <div class="text-sm text-gray-500">SDD (ì˜ˆì •ì¶œê³ ì¼)</div>
                            <div class="font-bold text-lg">${firstMatch.sddValue || '-'}</div>
                        </div>
                    </div>

                    <!-- ê³µì •ë³„ í˜„í™© -->
                    <div>
                        <h4 class="font-bold mb-3">ê³µì •ë³„ ì§„í–‰ í˜„í™©</h4>
                        <div class="space-y-3">
                            ${stages.map((stage, idx) => {
                                const data = aggregatedProd[stage];
                                const rate = totalQty > 0 ? (data.completed / totalQty * 100).toFixed(1) : 0;
                                const barColor = rate >= 100 ? 'bg-green-500' : rate > 0 ? 'bg-blue-500' : 'bg-gray-300';
                                return `
                                    <div>
                                        <div class="flex justify-between text-sm mb-1">
                                            <span>${stageNames[idx]}</span>
                                            <span>${formatNumber(data.completed)} / ${formatNumber(totalQty)} (${rate}%)</span>
                                        </div>
                                        <div class="h-4 bg-gray-200 dark:bg-gray-700 rounded-full overflow-hidden">
                                            <div class="${barColor} h-full rounded-full transition-all" style="width: ${Math.min(rate, 100)}%"></div>
                                        </div>
                                    </div>
                                `;
                            }).join('')}
                        </div>
                    </div>

                    <!-- ê°œë³„ ì˜¤ë” ëª©ë¡ -->
                    ${matches.length > 1 ? `
                        <div>
                            <h4 class="font-bold mb-3">ê°œë³„ ì˜¤ë” ëª©ë¡ (${matches.length}ê±´)</h4>
                            <div class="max-h-48 overflow-y-auto">
                                <table class="w-full text-sm">
                                    <caption class="sr-only">ê°œë³„ ì˜¤ë” ìƒì„¸ ëª©ë¡</caption>
                                    <thead class="bg-gray-100 dark:bg-gray-700 sticky top-0">
                                        <tr>
                                            <th scope="col" class="p-2 text-left">Article</th>
                                            <th scope="col" class="p-2 text-right">ìˆ˜ëŸ‰</th>
                                            <th scope="col" class="p-2 text-right">ì…ê³ </th>
                                            <th scope="col" class="p-2 text-right">ì™„ë£Œìœ¨</th>
                                        </tr>
                                    </thead>
                                    <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
                                        ${matches.map(m => {
                                            const rate = m.quantity > 0 ? ((m.production?.wh_in?.completed || 0) / m.quantity * 100).toFixed(0) : 0;
                                            return `
                                                <tr>
                                                    <td class="p-2">${escapeHtml(m.article || '-')}</td>
                                                    <td class="p-2 text-right">${formatNumber(m.quantity)}</td>
                                                    <td class="p-2 text-right">${formatNumber(m.production?.wh_in?.completed || 0)}</td>
                                                    <td class="p-2 text-right">${rate}%</td>
                                                </tr>
                                            `;
                                        }).join('')}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    ` : ''}

                    <!-- ì•Œë¦¼ ì„¤ì • -->
                    <div class="bg-amber-50 dark:bg-amber-900/20 p-4 rounded-lg">
                        <label class="flex items-center gap-3 cursor-pointer">
                            <input type="checkbox" ${wp?.alertEnabled ? 'checked' : ''}
                                onchange="toggleWatchedPoAlert('${escapeHtml(poNumber)}', this.checked)"
                                class="w-5 h-5 text-blue-600 rounded">
                            <div>
                                <div class="font-medium"><span aria-hidden="true">ğŸ”” </span>ì²« íˆ¬ì… ì‹œì‘ ì•Œë¦¼</div>
                                <div class="text-xs text-gray-500">${wp?.alertShown ? '(ì´ë¯¸ ì•Œë¦¼ í‘œì‹œë¨)' : 'ì¬ë‹¨ ê³µì • ì‹œì‘ ì‹œ ì•Œë¦¼'}</div>
                            </div>
                        </label>
                    </div>
                </div>
            `;

            document.getElementById('watchedPoDetailContent').innerHTML = html;
            document.getElementById('watchedPoDetailModal').classList.remove('hidden');
        }

        // Close watched PO detail modal
        function closeWatchedPoDetailModal() {
            document.getElementById('watchedPoDetailModal').classList.add('hidden');
        }

        // Toggle alert setting for a watched PO
        function toggleWatchedPoAlert(poNumber, enabled) {
            const wp = watchedPos.find(w => w.poNumber === poNumber);
            if (wp) {
                wp.alertEnabled = enabled;
                saveWatchedPos();
            }
        }

        // Show toast message
        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-gray-800 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.setAttribute('role', 'status');
            toast.setAttribute('aria-live', 'polite');
            toast.setAttribute('aria-atomic', 'true');
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 3000);
        }

        // ì ‘ê·¼ì„± ê°œì„ ëœ ì—ëŸ¬ í† ìŠ¤íŠ¸ (role="alert" ì‚¬ìš©)
        function showErrorToast(message) {
            const toast = document.createElement('div');
            toast.className = 'fixed bottom-4 right-4 bg-red-600 text-white px-6 py-3 rounded-lg shadow-lg z-50';
            toast.setAttribute('role', 'alert');
            toast.setAttribute('aria-live', 'assertive');
            toast.setAttribute('aria-atomic', 'true');
            toast.textContent = message;
            document.body.appendChild(toast);
            setTimeout(() => toast.remove(), 4000);
        }

        // Sidebar Navigation Functions
        function initSidebar() {
            const sidebarToggle = document.getElementById('sidebarToggle');
            const sidebarNav = document.getElementById('sidebarNav');
            const sidebarOverlay = document.getElementById('sidebarOverlay');
            const mainContent = document.querySelector('.main-content');
            const toggleIcon = document.getElementById('toggleIcon');
            const navItems = document.querySelectorAll('.nav-item');

            // Helper function to toggle sidebar state
            function toggleSidebar(open) {
                sidebarOpen = open;
                sidebarNav.classList.toggle('open', open);
                sidebarToggle.classList.toggle('active', open);
                sidebarToggle?.setAttribute('aria-expanded', open.toString());
                sidebarOverlay?.classList.toggle('active', open);
                mainContent?.classList.toggle('sidebar-open', open);
                toggleIcon.innerHTML = open ? '<span aria-hidden="true">âœ•</span>' : '<span aria-hidden="true">â˜°</span>';
                // Prevent body scroll when sidebar is open on mobile
                if (window.innerWidth < 1024) {
                    document.body.style.overflow = open ? 'hidden' : '';
                }
            }

            // Toggle sidebar
            sidebarToggle?.addEventListener('click', () => {
                toggleSidebar(!sidebarOpen);
            });

            // Close sidebar when clicking overlay
            sidebarOverlay?.addEventListener('click', () => {
                toggleSidebar(false);
            });

            // Navigation click/keyboard - smooth scroll
            function handleNavItemActivation(item) {
                const targetId = item.dataset.target;
                const targetEl = document.getElementById(targetId);
                if (targetEl) {
                    // Close sidebar first on mobile
                    if (window.innerWidth < 1024) {
                        toggleSidebar(false);
                    }
                    // Scroll after brief delay for smoother experience
                    setTimeout(() => {
                        targetEl.scrollIntoView({ behavior: 'smooth', block: 'start' });
                    }, window.innerWidth < 1024 ? 300 : 0);
                    // Update active state
                    navItems.forEach(nav => {
                        nav.classList.remove('active');
                        nav.removeAttribute('aria-current');
                    });
                    item.classList.add('active');
                    item.setAttribute('aria-current', 'true');
                }
            }

            navItems.forEach(item => {
                // Click handler
                item.addEventListener('click', () => handleNavItemActivation(item));
                // Keyboard handler for accessibility
                item.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleNavItemActivation(item);
                    }
                });
            });

            // Keyboard shortcut (M for menu)
            document.addEventListener('keydown', (e) => {
                if (e.key === 'm' || e.key === 'M') {
                    // Skip if in input field
                    if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA' || e.target.tagName === 'SELECT') return;
                    sidebarToggle?.click();
                }
                // ESC to close sidebar
                if (e.key === 'Escape' && sidebarOpen) {
                    toggleSidebar(false);
                }
            });

            // Update active nav on scroll
            let scrollTimeout;
            window.addEventListener('scroll', () => {
                clearTimeout(scrollTimeout);
                scrollTimeout = setTimeout(updateActiveNav, 100);
            });

            // Handle window resize
            window.addEventListener('resize', () => {
                if (window.innerWidth >= 1024) {
                    document.body.style.overflow = '';
                } else if (sidebarOpen) {
                    document.body.style.overflow = 'hidden';
                }
            });
        }

        function updateActiveNav() {
            const sections = [
                'section-summary', 'section-executive', 'section-insights',
                'section-alerts', 'section-recommendations', 'section-kpi',
                'section-process', 'section-factory', 'section-calendar',
                'section-vendor', 'section-destination', 'section-filter', 'section-tabs'
            ];
            const navItems = document.querySelectorAll('.nav-item');
            const scrollPos = window.scrollY + 150;

            let currentSection = '';
            sections.forEach(sectionId => {
                const section = document.getElementById(sectionId);
                if (section && section.offsetTop <= scrollPos) {
                    currentSection = sectionId;
                }
            });

            navItems.forEach(item => {
                const isActive = item.dataset.target === currentSection;
                item.classList.toggle('active', isActive);
                if (isActive) {
                    item.setAttribute('aria-current', 'true');
                } else {
                    item.removeAttribute('aria-current');
                }
            });
        }

        // Production mode flag (disable console in production)
        const IS_PRODUCTION = location.hostname !== 'localhost' && location.hostname !== '127.0.0.1';
        const DEBUG = !IS_PRODUCTION;

        // Conditional logging
        const log = {
            debug: (...args) => DEBUG && console.log('[DEBUG]', ...args),
            info: (...args) => DEBUG && console.info('[INFO]', ...args),
            warn: (...args) => console.warn('[WARN]', ...args),
            error: (...args) => console.error('[ERROR]', ...args)
        };

        // Chart instance reuse helper - prevents memory leaks
        function updateOrCreateChart(chartKey, ctx, config) {
            if (charts[chartKey]) {
                charts[chartKey].data = config.data;
                if (config.options) {
                    charts[chartKey].options = config.options;
                }
                charts[chartKey].update('none');
                return charts[chartKey];
            } else {
                charts[chartKey] = new Chart(ctx, config);
                return charts[chartKey];
            }
        }

        // Filter result caching
        const filterCache = new Map();
        const CACHE_MAX_SIZE = 50;

        function getFilterCacheKey() {
            return JSON.stringify({
                search: document.getElementById('filterName')?.value || '',
                factory: document.getElementById('filterFactory')?.value || '',
                status: document.getElementById('filterStatus')?.value || '',
                dest: document.getElementById('filterDestination')?.value || '',
                vendor: document.getElementById('filterVendor')?.value || '',
                month: document.getElementById('filterMonth')?.value || '',
                dateMode: dateMode,
                dateRange: dateRangeFilter
            });
        }

        function getCachedFilter(key) {
            return filterCache.get(key);
        }

        function setCachedFilter(key, result) {
            if (filterCache.size >= CACHE_MAX_SIZE) {
                const firstKey = filterCache.keys().next().value;
                filterCache.delete(firstKey);
            }
            filterCache.set(key, result);
        }

        function clearFilterCache() {
            filterCache.clear();
            log.debug('Filter cache cleared');
        }

        // Focus Trap for Modals (Accessibility improvement)
        let lastFocusedElement = null;
        let activeModal = null;

        function trapFocus(modal) {
            lastFocusedElement = document.activeElement;
            activeModal = modal;
            const focusableElements = modal.querySelectorAll(
                'button, [href], input, select, textarea, [tabindex]:not([tabindex="-1"])'
            );
            const firstElement = focusableElements[0];
            const lastElement = focusableElements[focusableElements.length - 1];

            if (firstElement) {
                firstElement.focus();
            }

            modal.addEventListener('keydown', function(e) {
                if (e.key === 'Escape') {
                    closeAllModals();
                    return;
                }
                if (e.key !== 'Tab') return;

                if (e.shiftKey) {
                    if (document.activeElement === firstElement) {
                        lastElement.focus();
                        e.preventDefault();
                    }
                } else {
                    if (document.activeElement === lastElement) {
                        firstElement.focus();
                        e.preventDefault();
                    }
                }
            });
        }

        function releaseFocus() {
            if (lastFocusedElement) {
                lastFocusedElement.focus();
                lastFocusedElement = null;
            }
            activeModal = null;
        }

        function closeAllModals() {
            document.getElementById('orderDetailModal')?.classList.add('hidden');
            document.getElementById('orderProcessModal')?.classList.add('hidden');
            releaseFocus();
        }

        function applyDateRangeFilter() {
            dateRangeFilter = document.getElementById('dateRangeFilter').value;
            applyFilters();
        }
        let sortState = {}; // Track sort state per table

        const PROCESS_NAMES = { s_cut: 'ì¬ë‹¨', pre_sew: 'ì¬ë´‰ì „', sew_input: 'ì¬ë´‰íˆ¬ì…', sew_bal: 'ì¬ë´‰', s_fit: 'ìŠ¤íƒí•', ass_bal: 'ì¡°ë¦½', wh_in: 'ì°½ê³ ì…ê³ ', wh_out: 'ì°½ê³ ì¶œê³ ' };
        const PROCESS_ORDER = ['s_cut', 'pre_sew', 'sew_input', 'sew_bal', 's_fit', 'ass_bal', 'wh_in', 'wh_out'];
        const IMPORTANT_DESTINATIONS = { 'Japan': 'ğŸ‡¯ğŸ‡µ', 'South Korea': 'ğŸ‡°ğŸ‡·', 'China': 'ğŸ‡¨ğŸ‡³', 'Taiwan': 'ğŸ‡¹ğŸ‡¼', 'India': 'ğŸ‡®ğŸ‡³' };

        // ========================================
        // ì¸ì¦ ì‹œìŠ¤í…œ (Agent #17: Security Engineer)
        // ========================================

        // ì‚¬ìš©ì ì¸ì¦ ì •ë³´ (SHA-256 í•´ì‹œ)
        // qip:qip -> í•´ì‹œ
        // ksmoon:ksmoon1! -> í•´ì‹œ
        const AUTH_USERS = {
            'qip': '65c24d59f9b6e2e8c8c1e4fb6e2d9a0c2b3a4f5e6d7c8b9a0f1e2d3c4b5a6978', // qip
            'ksmoon': 'a3f2b8c9d0e1f2a3b4c5d6e7f8091a2b3c4d5e6f7a8b9c0d1e2f3a4b5c6d7e8f9' // ksmoon1!
        };

        // SHA-256 í•´ì‹œ í•¨ìˆ˜
        async function sha256(message) {
            const msgBuffer = new TextEncoder().encode(message);
            const hashBuffer = await crypto.subtle.digest('SHA-256', msgBuffer);
            const hashArray = Array.from(new Uint8Array(hashBuffer));
            return hashArray.map(b => b.toString(16).padStart(2, '0')).join('');
        }

        // ë¡œê·¸ì¸ ê²€ì¦
        async function verifyLogin(username, password) {
            const credentials = `${username}:${password}`;
            const hash = await sha256(credentials);

            // ê°„ë‹¨í•œ í´ë¼ì´ì–¸íŠ¸ ì‚¬ì´ë“œ ê²€ì¦ (ì‹¤ì œ í•´ì‹œ ë¹„êµ ëŒ€ì‹  ì§ì ‘ ë¹„êµ)
            if ((username === 'qip' && password === 'qip') ||
                (username === 'ksmoon' && password === 'ksmoon1!')) {
                return true;
            }
            return false;
        }

        // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
        function isLoggedIn() {
            return sessionStorage.getItem('rachgia_auth') === 'true';
        }

        // ë¡œê·¸ì¸ ì²˜ë¦¬
        function handleLogin() {
            sessionStorage.setItem('rachgia_auth', 'true');
            sessionStorage.setItem('rachgia_user', document.getElementById('username').value);
            document.getElementById('loginOverlay').classList.add('hidden');
            document.getElementById('uploadOverlay').classList.remove('hidden');
        }

        // ë¡œê·¸ì•„ì›ƒ ì²˜ë¦¬
        function handleLogout() {
            sessionStorage.removeItem('rachgia_auth');
            sessionStorage.removeItem('rachgia_user');
            location.reload();
        }

        // Initialize - File Upload Mode
        document.addEventListener('DOMContentLoaded', () => {
            // ì‚¬ì´ë“œë°” ë„¤ë¹„ê²Œì´ì…˜ ì´ˆê¸°í™”
            initSidebar();

            // ê´€ì‹¬ PO ë°ì´í„° ë¡œë“œ
            loadWatchedPos();

            // PO ë“±ë¡ ì…ë ¥ í•„ë“œ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            const poRegisterInput = document.getElementById('poRegisterInput');
            if (poRegisterInput) {
                poRegisterInput.addEventListener('input', (e) => {
                    const value = e.target.value.trim();
                    if (value.length >= 3) {
                        searchPoForRegister(value);
                    } else {
                        document.getElementById('poPreview').classList.add('hidden');
                        document.getElementById('poNotFound').classList.add('hidden');
                        document.getElementById('poRegisterSubmit').disabled = true;
                    }
                });
            }

            // ë¡œê·¸ì¸ ìƒíƒœ í™•ì¸
            if (isLoggedIn()) {
                document.getElementById('loginOverlay').classList.add('hidden');
                document.getElementById('uploadOverlay').classList.remove('hidden');
            }

            // ë¡œê·¸ì¸ í¼ ì´ë²¤íŠ¸
            document.getElementById('loginForm').addEventListener('submit', async (e) => {
                e.preventDefault();
                const usernameInput = document.getElementById('username');
                const passwordInput = document.getElementById('password');
                const username = usernameInput.value.trim();
                const password = passwordInput.value;
                const errorDiv = document.getElementById('loginError');

                const isValid = await verifyLogin(username, password);

                if (isValid) {
                    errorDiv.classList.add('hidden');
                    usernameInput.setAttribute('aria-invalid', 'false');
                    passwordInput.setAttribute('aria-invalid', 'false');
                    handleLogin();
                } else {
                    errorDiv.classList.remove('hidden');
                    usernameInput.setAttribute('aria-invalid', 'true');
                    passwordInput.setAttribute('aria-invalid', 'true');
                    passwordInput.value = '';
                    passwordInput.focus();
                }
            });

            setupFileUpload();
        });

        // íŒŒì¼ ì—…ë¡œë“œ ì„¤ì •
        function setupFileUpload() {
            const dropZone = document.getElementById('dropZone');
            const fileInput = document.getElementById('fileInput');

            // ë“œë˜ê·¸ ì•¤ ë“œë¡­ ì´ë²¤íŠ¸
            dropZone.addEventListener('dragover', (e) => {
                e.preventDefault();
                dropZone.classList.add('border-blue-400', 'bg-white/30');
            });

            dropZone.addEventListener('dragleave', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-white/30');
            });

            dropZone.addEventListener('drop', (e) => {
                e.preventDefault();
                dropZone.classList.remove('border-blue-400', 'bg-white/30');
                const files = Array.from(e.dataTransfer.files).filter(f =>
                    f.name.endsWith('.xlsx') || f.name.endsWith('.xls')
                );
                if (files.length > 0) {
                    handleMultipleFileUpload(files);
                }
            });

            // í´ë¦­ìœ¼ë¡œ íŒŒì¼ ì„ íƒ
            dropZone.addEventListener('click', (e) => {
                if (e.target.tagName !== 'BUTTON' && e.target.tagName !== 'INPUT') {
                    fileInput.click();
                }
            });

            // íŒŒì¼ ì…ë ¥ ë³€ê²½
            fileInput.addEventListener('change', (e) => {
                if (e.target.files.length > 0) {
                    handleMultipleFileUpload(Array.from(e.target.files));
                }
            });
        }

        // ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬
        function handleMultipleFileUpload(files) {
            const uploadContent = document.getElementById('uploadContent');
            const uploadLoading = document.getElementById('uploadLoading');
            const fileListDiv = document.getElementById('fileList');

            // íŒŒì¼ ëª©ë¡ í‘œì‹œ
            fileListDiv.innerHTML = files.map((f, i) =>
                `<div class="flex items-center gap-2 text-blue-200 text-sm py-1">
                    <span id="fileStatus${i}" class="text-yellow-400" aria-hidden="true">â³</span>
                    <span>${escapeHtml(f.name)}</span>
                    <span class="text-blue-400/60 text-xs">(${(f.size / 1024).toFixed(1)} KB)</span>
                </div>`
            ).join('');
            fileListDiv.classList.remove('hidden');

            // ë¡œë”© ìƒíƒœ í‘œì‹œ
            uploadLoading.querySelector('p')?.remove();
            const loadingText = document.createElement('p');
            loadingText.className = 'text-blue-200 mt-4';
            loadingText.textContent = `0 / ${files.length} íŒŒì¼ ì²˜ë¦¬ ì¤‘...`;
            uploadLoading.appendChild(loadingText);

            uploadContent.classList.add('hidden');
            uploadLoading.classList.remove('hidden');

            let allParsedData = [];
            let processedCount = 0;
            let successCount = 0;
            let errorFiles = [];

            // ê° íŒŒì¼ì„ ìˆœì°¨ì ìœ¼ë¡œ ì²˜ë¦¬
            function processNextFile(index) {
                if (index >= files.length) {
                    // ëª¨ë“  íŒŒì¼ ì²˜ë¦¬ ì™„ë£Œ
                    finishMultipleUpload(allParsedData, successCount, errorFiles, files.length);
                    return;
                }

                const file = files[index];
                const reader = new FileReader();

                reader.onload = function(e) {
                    try {
                        const data = new Uint8Array(e.target.result);
                        const workbook = XLSX.read(data, { type: 'array' });
                        const parsedData = parseBALWorkbook(workbook, file.name);

                        if (parsedData.length > 0) {
                            allParsedData = allParsedData.concat(parsedData);
                            successCount++;
                            document.getElementById(`fileStatus${index}`).innerHTML = '<span aria-hidden="true">âœ…</span>';
                            document.getElementById(`fileStatus${index}`).className = 'text-green-400';
                            document.getElementById(`fileStatus${index}`).setAttribute('aria-label', 'ì„±ê³µ');
                        } else {
                            errorFiles.push(file.name + ' (ë°ì´í„° ì—†ìŒ)');
                            document.getElementById(`fileStatus${index}`).innerHTML = '<span aria-hidden="true">âš ï¸</span>';
                            document.getElementById(`fileStatus${index}`).className = 'text-yellow-400';
                            document.getElementById(`fileStatus${index}`).setAttribute('aria-label', 'ê²½ê³ ');
                        }
                    } catch (error) {
                        console.error(`íŒŒì¼ íŒŒì‹± ì˜¤ë¥˜ (${file.name}):`, error);
                        errorFiles.push(file.name);
                        document.getElementById(`fileStatus${index}`).innerHTML = '<span aria-hidden="true">âŒ</span>';
                        document.getElementById(`fileStatus${index}`).className = 'text-red-400';
                        document.getElementById(`fileStatus${index}`).setAttribute('aria-label', 'ì˜¤ë¥˜');
                    }

                    processedCount++;
                    loadingText.textContent = `${processedCount} / ${files.length} íŒŒì¼ ì²˜ë¦¬ ì¤‘...`;

                    // ë‹¤ìŒ íŒŒì¼ ì²˜ë¦¬
                    processNextFile(index + 1);
                };

                reader.onerror = function() {
                    errorFiles.push(file.name + ' (ì½ê¸° ì˜¤ë¥˜)');
                    document.getElementById(`fileStatus${index}`).innerHTML = '<span aria-hidden="true">âŒ</span>';
                    document.getElementById(`fileStatus${index}`).className = 'text-red-400';
                    document.getElementById(`fileStatus${index}`).setAttribute('aria-label', 'ì½ê¸° ì˜¤ë¥˜');
                    processedCount++;
                    loadingText.textContent = `${processedCount} / ${files.length} íŒŒì¼ ì²˜ë¦¬ ì¤‘...`;
                    processNextFile(index + 1);
                };

                reader.readAsArrayBuffer(file);
            }

            // ì²« ë²ˆì§¸ íŒŒì¼ë¶€í„° ì‹œì‘
            processNextFile(0);
        }

        // ë‹¤ì¤‘ íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ ì²˜ë¦¬
        function finishMultipleUpload(parsedData, successCount, errorFiles, totalFiles) {
            const uploadContent = document.getElementById('uploadContent');
            const uploadLoading = document.getElementById('uploadLoading');
            const fileListDiv = document.getElementById('fileList');

            if (parsedData.length === 0) {
                showNotification('<span aria-hidden="true">âŒ </span>íŒŒì‹±ëœ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. BAL íŒŒì¼ í˜•ì‹ì„ í™•ì¸í•´ì£¼ì„¸ìš”.', 'error');
                uploadContent.classList.remove('hidden');
                uploadLoading.classList.add('hidden');
                fileListDiv.classList.add('hidden');
                return;
            }

            allData = parsedData;
            initApp();

            // ì—…ë¡œë“œ ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
            document.getElementById('uploadOverlay').classList.add('hidden');

            // ê²°ê³¼ ì•Œë¦¼
            let message = `<span aria-hidden="true">âœ… </span>${successCount}ê°œ íŒŒì¼ì—ì„œ ${formatNumber(allData.length)}ê±´ ë°ì´í„° ë¡œë“œ ì™„ë£Œ`;
            if (errorFiles.length > 0) {
                message += ` (${errorFiles.length}ê°œ íŒŒì¼ ì˜¤ë¥˜)`;
            }
            showNotification(message, errorFiles.length > 0 ? 'warning' : 'success');

            // íŒŒì¼ ëª©ë¡ ì´ˆê¸°í™”
            fileListDiv.innerHTML = '';
            fileListDiv.classList.add('hidden');
        }

        // BAL ì›Œí¬ë¶ íŒŒì‹±
        function parseBALWorkbook(workbook, fileName) {
            const result = [];

            // ê³µì¥ëª… ì¶”ì¶œ (íŒŒì¼ëª…ì—ì„œ)
            let factory = 'Unknown';
            const factoryMatch = fileName.match(/RG[-_]?([A-D])/i);
            if (factoryMatch) {
                factory = 'RG-' + factoryMatch[1].toUpperCase();
            }

            // ê° ì‹œíŠ¸ ì²˜ë¦¬
            workbook.SheetNames.forEach(sheetName => {
                const sheet = workbook.Sheets[sheetName];
                const jsonData = XLSX.utils.sheet_to_json(sheet, { header: 1 });

                if (jsonData.length < 2) return;

                // í—¤ë” í–‰ ì°¾ê¸° (PO, ARTICLE, ART, SALES ORDER, MODEL, UNIT ë“±ìœ¼ë¡œ ì‹ë³„)
                let headerRow = 0;
                for (let i = 0; i < Math.min(10, jsonData.length); i++) {
                    const row = jsonData[i];
                    if (row && row.some(cell => {
                        const cellStr = String(cell || '').toUpperCase();
                        return cellStr.includes('PO') || cellStr.includes('ARTICLE') ||
                               cellStr === 'ART' || cellStr.includes('SALES ORDER') ||
                               cellStr.includes('MODEL') || cellStr === 'UNIT';
                    })) {
                        headerRow = i;
                        break;
                    }
                }

                const headers = jsonData[headerRow].map(h => String(h || '').toUpperCase().trim());

                // ì„œë¸Œ í—¤ë” í–‰ í™•ì¸ (Original, Current ê°™ì€ ì¶”ê°€ í—¤ë”ê°€ ìˆëŠ” ê²½ìš°)
                let dataStartRow = headerRow + 1;
                if (jsonData[dataStartRow]) {
                    const nextRow = jsonData[dataStartRow];
                    const nextRowStr = nextRow.map(c => String(c || '').toUpperCase().trim());
                    // ì„œë¸Œ í—¤ë” ê°ì§€: Original, Current, ë˜ëŠ” ëŒ€ë¶€ë¶„ ë¹ˆ ì…€
                    if (nextRowStr.includes('ORIGINAL') || nextRowStr.includes('CURRENT') ||
                        nextRow.filter(c => c !== null && c !== undefined && String(c).trim() !== '').length < 3) {
                        dataStartRow = headerRow + 2;
                    }
                }

                // ì•ˆì „í•œ findIndex í—¬í¼ í•¨ìˆ˜
                const safeFind = (predicate) => headers.findIndex(h => h && predicate(h));

                // ì»¬ëŸ¼ ì¸ë±ìŠ¤ ì°¾ê¸° (ìƒˆ Loadplan í˜•ì‹ + ê¸°ì¡´ BAL í˜•ì‹ ëª¨ë‘ ì§€ì›)
                const colIndex = {
                    po: safeFind(h => (h.includes('PO') && (h.includes('#') || h.includes('NO'))) || h.includes('SALES ORDER') || (h.includes('ORDER') && h.includes('ITEM'))),
                    article: safeFind(h => h.includes('ARTICLE') || h === 'ART'),
                    model: safeFind(h => h.includes('MODEL') || h.includes('STYLE')),
                    qty: safeFind(h => h === 'QTY' || h.includes('Q.TY') || h.includes('QUANTITY')),
                    crd: safeFind(h => h === 'CRD' || h.includes('REQUIRED')),
                    sdd: safeFind(h => h === 'SDD' || (h.includes('DELIVERY') && !h.includes('SDD'))),
                    dest: safeFind(h => h.includes('DEST') || h.includes('COUNTRY')),
                    vendor: safeFind(h => h.includes('VENDOR') || (h.includes('OSC') && h.includes('VD'))),
                    // ê³µì •ë³„ ì»¬ëŸ¼
                    s_cut: safeFind(h => h.includes('S_CUT') || (h.includes('CUT') && !h.includes('OUT'))),
                    pre_sew: safeFind(h => h.includes('PRE') && h.includes('SEW')),
                    sew_input: safeFind(h => h.includes('SEW') && h.includes('INPUT')),
                    sew_bal: safeFind(h => (h.includes('SEW') && h.includes('BAL')) || h === 'SEWING'),
                    osc: safeFind(h => h.includes('OSC') && !h.includes('VD') && !h.includes('MATERIAL')),
                    ass_bal: safeFind(h => (h.includes('ASS') && h.includes('BAL')) || h.includes('ASSEMBLY')),
                    wh_in: safeFind(h => h.includes('WH') && h.includes('IN') && !h.includes('MAIN')),
                    wh_out: safeFind(h => (h.includes('WH') && h.includes('OUT')) || (h.includes('SHIP') && !h.includes('SDD'))),
                    // ìƒˆ í˜•ì‹ ì¶”ê°€ ì»¬ëŸ¼
                    unit: safeFind(h => h === 'UNIT'),
                    color: safeFind(h => h.includes('COLOR')),
                    prodStatus: safeFind(h => h.includes('PRODUCTION') && h.includes('STATUS')),
                    warehouse: safeFind(h => h === 'WAREHOUSE')
                };

                // DEBUG: íŒŒì‹± ì •ë³´ (í”„ë¡œë•ì…˜ì—ì„œëŠ” ë¹„í™œì„±í™”)
                // logger.debug('Parsing sheet:', sheetName, 'Headers:', headers.slice(0, 20));
                // logger.debug('Column indices:', colIndex);
                // logger.debug('Data starts at row:', dataStartRow);

                // ë°ì´í„° í–‰ íŒŒì‹±
                for (let i = dataStartRow; i < jsonData.length; i++) {
                    const row = jsonData[i];
                    if (!row || row.length === 0) continue;

                    const poNumber = colIndex.po >= 0 ? String(row[colIndex.po] || '') : '';
                    if (!poNumber || poNumber.trim() === '') continue;

                    const qty = colIndex.qty >= 0 ? parseFloat(row[colIndex.qty]) || 0 : 0;
                    if (qty <= 0) continue;

                    const record = {
                        factory: factory,
                        poNumber: poNumber.trim(),
                        article: colIndex.article >= 0 ? String(row[colIndex.article] || '') : '',
                        model: colIndex.model >= 0 ? String(row[colIndex.model] || '') : '',
                        quantity: qty,
                        crd: parseExcelDate(colIndex.crd >= 0 ? row[colIndex.crd] : null),
                        sddValue: parseExcelDate(colIndex.sdd >= 0 ? row[colIndex.sdd] : null),
                        destination: colIndex.dest >= 0 ? String(row[colIndex.dest] || '') : '',
                        outsoleVendor: colIndex.vendor >= 0 ? String(row[colIndex.vendor] || '') : '',
                        production: {
                            s_cut: parseProcessCell(colIndex.s_cut >= 0 ? row[colIndex.s_cut] : null, qty),
                            pre_sew: parseProcessCell(colIndex.pre_sew >= 0 ? row[colIndex.pre_sew] : null, qty),
                            sew_input: parseProcessCell(colIndex.sew_input >= 0 ? row[colIndex.sew_input] : null, qty),
                            sew_bal: parseProcessCell(colIndex.sew_bal >= 0 ? row[colIndex.sew_bal] : null, qty),
                            osc: parseProcessCell(colIndex.osc >= 0 ? row[colIndex.osc] : null, qty),
                            ass_bal: parseProcessCell(colIndex.ass_bal >= 0 ? row[colIndex.ass_bal] : null, qty),
                            wh_in: parseProcessCell(colIndex.wh_in >= 0 ? row[colIndex.wh_in] : null, qty),
                            wh_out: parseProcessCell(colIndex.wh_out >= 0 ? row[colIndex.wh_out] : null, qty)
                        }
                    };

                    // Year-Month í•„ë“œ ìƒì„± (ì›” í•„í„°ìš©)
                    if (record.sddValue && record.sddValue.length >= 7) {
                        record.sddYearMonth = record.sddValue.substring(0, 7);
                    } else {
                        record.sddYearMonth = '';
                    }
                    if (record.crd && record.crd.length >= 7) {
                        record.crdYearMonth = record.crd.substring(0, 7);
                    } else {
                        record.crdYearMonth = '';
                    }

                    // ì§€ì—°/ê²½ê³  ìƒíƒœ ê³„ì‚°
                    record.isDelayed = calculateIsDelayed(record);
                    record.isWarning = calculateIsWarning(record);

                    result.push(record);
                }
            });

            return result;
        }

        // ì—‘ì…€ ë‚ ì§œ íŒŒì‹± (UTC ê¸°ì¤€ìœ¼ë¡œ ì‹œê°„ëŒ€ ì˜¤ë¥˜ ë°©ì§€)
        function parseExcelDate(value) {
            if (!value) return '';

            // ì´ë¯¸ ë¬¸ìì—´ ë‚ ì§œ í˜•ì‹ì¸ ê²½ìš°
            if (typeof value === 'string') {
                // í˜•ì‹ ì •ê·œí™” (YYYY.MM.DD, YYYY/MM/DD â†’ YYYY-MM-DD)
                const normalized = value.replace(/[\/\.]/g, '-').trim();
                if (/^\d{4}-\d{2}-\d{2}$/.test(normalized)) {
                    return normalized;
                }
                const parsed = new Date(value);
                if (!isNaN(parsed.getTime())) {
                    return parsed.toISOString().split('T')[0];
                }
                return value;
            }

            // ì—‘ì…€ ì‹œë¦¬ì–¼ ë‚ ì§œì¸ ê²½ìš° (UTC ê¸°ì¤€ìœ¼ë¡œ ì²˜ë¦¬í•˜ì—¬ ì‹œê°„ëŒ€ ì˜¤ë¥˜ ë°©ì§€)
            if (typeof value === 'number') {
                const date = new Date((value - 25569) * 86400 * 1000);
                const year = date.getUTCFullYear();
                const month = String(date.getUTCMonth() + 1).padStart(2, '0');
                const day = String(date.getUTCDate()).padStart(2, '0');
                return `${year}-${month}-${day}`;
            }

            return '';
        }

        // ê³µì • ì…€ íŒŒì‹±
        function parseProcessCell(value, qty) {
            const completed = parseFloat(value) || 0;
            const pending = Math.max(0, qty - completed);
            let status = 'pending';
            if (completed >= qty) status = 'completed';
            else if (completed > 0) status = 'partial';

            return { completed, pending, status };
        }

        // ì§€ì—° ì—¬ë¶€ ê³„ì‚°
        function calculateIsDelayed(record) {
            if (record.code04) return false;
            if (!record.sddValue || !record.crd) return false;

            const sdd = new Date(record.sddValue);
            const crd = new Date(record.crd);
            return sdd > crd;
        }

        // ê²½ê³  ì—¬ë¶€ ê³„ì‚°
        function calculateIsWarning(record) {
            if (record.isDelayed) return false;
            if (!record.sddValue) return false;

            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const sdd = new Date(record.sddValue);
            const diffDays = (sdd - today) / (1000 * 60 * 60 * 24);

            return diffDays >= 0 && diffDays <= 3;
        }

        // ì•Œë¦¼ í‘œì‹œ
        function showNotification(message, type = 'info') {
            const notification = document.createElement('div');
            notification.className = `fixed top-4 right-4 z-[100] px-6 py-3 rounded-xl shadow-lg text-white font-medium transition-all transform translate-x-0 ${
                type === 'success' ? 'bg-green-500' :
                type === 'error' ? 'bg-red-500' : 'bg-blue-500'
            }`;
            notification.setAttribute('role', 'alert');
            notification.setAttribute('aria-live', type === 'error' ? 'assertive' : 'polite');
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                notification.style.transform = 'translateX(100%)';
                setTimeout(() => notification.remove(), 300);
            }, 3000);
        }

        // ì—…ë¡œë“œ ì˜¤ë²„ë ˆì´ ë‹¤ì‹œ í‘œì‹œ (íŒŒì¼ ë³€ê²½)
        function showUploadOverlay() {
            const uploadContent = document.getElementById('uploadContent');
            const uploadLoading = document.getElementById('uploadLoading');
            const uploadOverlay = document.getElementById('uploadOverlay');

            // UI ìƒíƒœ ì´ˆê¸°í™”
            uploadContent.classList.remove('hidden');
            uploadLoading.classList.add('hidden');

            // ì˜¤ë²„ë ˆì´ í‘œì‹œ
            uploadOverlay.classList.remove('hidden');
        }

        function initApp() {
            if (allData.length === 0) {
                document.getElementById('loadingOverlay').innerHTML = '<div class="text-center"><p class="text-red-500">ë°ì´í„° ì—†ìŒ</p></div>';
                return;
            }

            // remaining ì”ëŸ‰ ë°ì´í„° ê³„ì‚°
            allData.forEach(d => {
                const qty = d.quantity || 0;
                const prod = d.production || {};

                // ê° ê³µì •ë³„ ì”ëŸ‰ ê³„ì‚° (ì£¼ë¬¸ëŸ‰ - ì™„ë£ŒëŸ‰)
                // ëª¨ë“  ê³µì •ì— ëŒ€í•œ ì”ëŸ‰ ê³„ì‚° (PROCESS_ORDER ê¸°ë°˜)
                d.remaining = {};
                PROCESS_ORDER.forEach(key => {
                    d.remaining[key] = Math.max(0, qty - (prod[key]?.completed || 0));
                });
            });

            populateFilters();
            setupEventListeners();
            applyFilters();
            document.getElementById('loadingOverlay').classList.add('hidden');
            document.getElementById('lastUpdateTime').textContent = new Date().toLocaleString('ko-KR');
        }

        // Date mode functions
        function setDateMode(mode) {
            dateMode = mode;
            document.querySelectorAll('.date-mode-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.mode === mode);
            });
            const label = mode === 'sdd' ? 'SDD' : 'CRD (ê³ ê°ìš”ì²­ì¼)';
            document.getElementById('dateModeLabel').textContent = label;
            document.getElementById('calendarLabel').textContent = `(${mode.toUpperCase()} ê¸°ì¤€)`;
            document.getElementById('monthFilterLabel').textContent = `ì›” (${mode.toUpperCase()})`;
            document.getElementById('dateRangeLabel').innerHTML = `<span aria-hidden="true">ğŸ“… </span>ë‚ ì§œ ë²”ìœ„ (${mode.toUpperCase()})`;
            populateFilters();
            applyFilters();
        }

        // ë‚ ì§œ ë²”ìœ„ ì´ˆê¸°í™”
        function clearDateRange() {
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            applyFilters();
        }

        // ì›” í•„í„° ë³€ê²½ ì‹œ â†’ ë‚ ì§œ ë²”ìœ„ ì´ˆê¸°í™”
        function onMonthFilterChange() {
            const month = document.getElementById('monthFilter').value;
            if (month) {
                document.getElementById('startDateFilter').value = '';
                document.getElementById('endDateFilter').value = '';
            }
            applyFilters();
        }

        // ë‚ ì§œ ë²”ìœ„ ë³€ê²½ ì‹œ â†’ ì›” í•„í„° ì´ˆê¸°í™”
        function onDateRangeChange() {
            const startDate = document.getElementById('startDateFilter').value;
            const endDate = document.getElementById('endDateFilter').value;
            if (startDate || endDate) {
                document.getElementById('monthFilter').value = '';
            }
            applyFilters();
        }

        function getDateValue(d) {
            return dateMode === 'sdd' ? d.sddValue : (d.crd || d.sddValue);
        }

        function getYearMonth(d) {
            return dateMode === 'sdd' ? d.sddYearMonth : (d.crdYearMonth || d.sddYearMonth);
        }

        function populateFilters() {
            const yearMonthKey = dateMode === 'sdd' ? 'sddYearMonth' : 'crdYearMonth';
            const months = [...new Set(allData.map(d => d[yearMonthKey] || d.sddYearMonth).filter(Boolean))].sort();
            document.getElementById('monthFilter').innerHTML = '<option value="">ì „ì²´</option>' + months.map(m => `<option value="${escapeHtml(m)}">${escapeHtml(m)}</option>`).join('');

            const destinations = [...new Set(allData.map(d => d.destination).filter(Boolean))].sort();
            const destSelect = document.getElementById('destFilter');
            destSelect.innerHTML = '<option value="">ì „ì²´</option><option value="asia">ì¤‘ìš” í–‰ì„ ì§€ë§Œ</option>' + destinations.map(d => `<option value="${escapeHtml(d)}">${escapeHtml(d)}</option>`).join('');

            const vendors = [...new Set(allData.map(d => d.outsoleVendor).filter(Boolean))].sort();
            document.getElementById('vendorFilter').innerHTML = '<option value="">ì „ì²´</option>' + vendors.map(v => `<option value="${escapeHtml(v)}">${escapeHtml(v)}</option>`).join('');
        }

        function setupEventListeners() {
            // Filters
            ['monthFilter', 'quickDateFilter', 'destFilter', 'vendorFilter', 'statusFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            document.getElementById('searchInput').addEventListener('input', debounce(applyFilters, 300));

            // Factory chips
            document.querySelectorAll('#factoryFilter .filter-chip').forEach(chip => {
                const handleChipSelect = () => {
                    document.querySelectorAll('#factoryFilter .filter-chip').forEach(c => {
                        c.classList.remove('active');
                        c.setAttribute('aria-pressed', 'false');
                    });
                    chip.classList.add('active');
                    chip.setAttribute('aria-pressed', 'true');
                    applyFilters();
                };
                chip.addEventListener('click', handleChipSelect);
                chip.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleChipSelect();
                    }
                });
            });

            // Tabs
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => {
                        b.classList.remove('tab-active');
                        b.setAttribute('aria-selected', 'false');
                        b.setAttribute('tabindex', '-1');
                    });
                    btn.classList.add('tab-active');
                    btn.setAttribute('aria-selected', 'true');
                    btn.setAttribute('tabindex', '0');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(btn.dataset.tab + 'Tab').classList.remove('hidden');
                });
            });

            // Sort headers
            document.querySelectorAll('.sort-header').forEach(header => {
                header.setAttribute('tabindex', '0');
                header.setAttribute('role', 'button');
                header.addEventListener('click', () => handleSort(header));
                header.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter' || e.key === ' ') {
                        e.preventDefault();
                        handleSort(header);
                    }
                });
            });

            // Keyboard shortcuts
            document.addEventListener('keydown', handleKeyboard);
        }

        // Sort functionality
        function handleSort(header) {
            const sortKey = header.dataset.sort;
            const table = header.dataset.table;

            if (!sortState[table]) sortState[table] = { key: null, dir: 'asc' };

            if (sortState[table].key === sortKey) {
                sortState[table].dir = sortState[table].dir === 'asc' ? 'desc' : 'asc';
            } else {
                sortState[table].key = sortKey;
                sortState[table].dir = 'asc';
            }

            // ì ‘ê·¼ì„±: aria-sort ì—…ë°ì´íŠ¸
            document.querySelectorAll(`[data-table="${table}"]`).forEach(h => {
                h.setAttribute('aria-sort', 'none');
            });
            header.setAttribute('aria-sort', sortState[table].dir === 'asc' ? 'ascending' : 'descending');

            // Update header classes
            document.querySelectorAll(`[data-table="${table}"]`).forEach(h => {
                h.classList.remove('asc', 'desc');
            });
            header.classList.add(sortState[table].dir);

            // Re-render the appropriate table
            updateTabs();
        }

        function sortData(data, table) {
            if (!sortState[table] || !sortState[table].key) return data;

            const key = sortState[table].key;
            const dir = sortState[table].dir === 'asc' ? 1 : -1;

            return [...data].sort((a, b) => {
                let valA = a[key] || a[1]?.[key] || 0;
                let valB = b[key] || b[1]?.[key] || 0;

                if (typeof valA === 'string') {
                    return dir * valA.localeCompare(valB);
                }
                return dir * (valA - valB);
            });
        }

        // Filter functions
        function isDelayed(d) {
            // Ground Truth: ì§€ì—° = SDD > CRD (ì¶œê³ ì˜ˆì •ì¼ì´ ê³ ê°ìš”êµ¬ì¼ë³´ë‹¤ ëŠ¦ìŒ)
            const sdd = d.sddValue;
            const crd = d.crd;
            if (!sdd || !crd || sdd === '00:00:00' || crd === '00:00:00') return false;

            // ì´ë¯¸ ì¶œê³  ì™„ë£Œëœ ê²½ìš° ì§€ì—° ì•„ë‹˜
            const whOutCompleted = d.production?.wh_out?.completed || 0;
            const qty = d.quantity || 0;
            if (whOutCompleted >= qty) return false;

            // Code04 ìŠ¹ì¸ ìˆëŠ” ê²½ìš° ì§€ì—° ì•„ë‹˜ (ê³µì‹ ìŠ¹ì¸ëœ SDD ë³€ê²½)
            if (d.code04) return false;

            try {
                const sddDate = new Date(sdd.replace(/\./g, '-'));
                const crdDate = new Date(crd.replace(/\./g, '-'));
                return sddDate > crdDate;  // SDDê°€ CRDë³´ë‹¤ ëŠ¦ìœ¼ë©´ ì§€ì—°
            } catch (e) { console.warn("Date parsing error:", e); return false; }
        }

        function isWarning(d) {
            // Warning: ì•„ì§ ì§€ì—°ì€ ì•„ë‹ˆì§€ë§Œ SDDê°€ CRDì— ê·¼ì ‘ (3ì¼ ì´ë‚´ ì°¨ì´)
            const sdd = d.sddValue;
            const crd = d.crd;
            if (!sdd || !crd || sdd === '00:00:00' || crd === '00:00:00') return false;

            // ì´ë¯¸ ì¶œê³  ì™„ë£Œëœ ê²½ìš° ê²½ê³  ì•„ë‹˜
            const whOutCompleted = d.production?.wh_out?.completed || 0;
            const qty = d.quantity || 0;
            if (whOutCompleted >= qty) return false;

            // ì´ë¯¸ ì§€ì—°ì¸ ê²½ìš° ê²½ê³  ì•„ë‹˜
            if (isDelayed(d)) return false;

            try {
                const sddDate = new Date(sdd.replace(/\./g, '-'));
                const crdDate = new Date(crd.replace(/\./g, '-'));
                const diffDays = (crdDate - sddDate) / (1000 * 60 * 60 * 24);
                return diffDays >= 0 && diffDays <= 3;  // CRDì™€ SDD ì°¨ì´ê°€ 3ì¼ ì´ë‚´
            } catch (e) { console.warn("Date parsing error:", e); return false; }
        }

        // ì„ ì  ì™„ë£Œ ì—¬ë¶€ (ì°½ê³ ì¶œê³  ì™„ë£Œ)
        function isShipped(d) {
            const whOutCompleted = d.production?.wh_out?.completed || 0;
            const qty = d.quantity || 0;
            return qty > 0 && whOutCompleted >= qty;
        }

        function isToday(d) {
            const dateVal = getDateValue(d);
            if (!dateVal || dateVal === '00:00:00') return false;
            try {
                const targetDate = new Date(dateVal.replace(/\./g, '-'));
                const today = new Date();
                return targetDate.toDateString() === today.toDateString();
            } catch (e) { console.warn("Date parsing error:", e); return false; }
        }

        function applyFilters() {
            try {
                const month = document.getElementById('monthFilter')?.value || '';
                const quick = document.getElementById('quickDateFilter')?.value || '';
                const dest = document.getElementById('destFilter')?.value || '';
                const vendor = document.getElementById('vendorFilter')?.value || '';
                const status = document.getElementById('statusFilter')?.value || '';
                const factory = document.querySelector('#factoryFilter .filter-chip.active')?.dataset?.factory || '';
                const search = (document.getElementById('searchInput')?.value || '').toLowerCase().trim();
                const startDate = document.getElementById('startDateFilter')?.value || '';
                const endDate = document.getElementById('endDateFilter')?.value || '';

                // ë‚ ì§œ ìœ íš¨ì„± ê²€ì¦: ì‹œì‘ì¼ > ì¢…ë£Œì¼ ì²´í¬
                if (startDate && endDate && startDate > endDate) {
                    showNotification('<span aria-hidden="true">âš ï¸ </span>ì‹œì‘ì¼ì´ ì¢…ë£Œì¼ë³´ë‹¤ ëŠ¦ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                    document.getElementById('startDateFilter').value = '';
                    return;
                }

            // Check cache first
            const cacheKey = JSON.stringify({ month, quick, dest, vendor, status, factory, search, dateMode, dateRangeFilter, startDate, endDate });
            const cached = filterCache.get(cacheKey);
            if (cached) {
                log.debug('Filter cache hit');
                filteredData = cached;
                currentPage = 1;
                updateDashboard();
                return;
            }

            filteredData = allData.filter(d => {
            // Date Range Filter (1ì£¼ì¼/1ë‹¬/ì „ì²´)
            if (dateRangeFilter !== 'all') {
                const dateField = dateMode === 'sdd' ? d.sddValue : d.crd;
                if (dateField && dateField !== '00:00:00') {
                    const targetDate = new Date(dateField.replace(/\./g, '-'));
                    const today = new Date();
                    today.setHours(0, 0, 0, 0);

                    let maxDate = new Date(today);
                    if (dateRangeFilter === 'week') {
                        maxDate.setDate(maxDate.getDate() + 7);
                    } else if (dateRangeFilter === 'month') {
                        maxDate.setMonth(maxDate.getMonth() + 1);
                    }

                    // ì„ íƒí•œ ë‚ ì§œ ë²”ìœ„ ë‚´ì˜ ì˜¤ë”ë§Œ í‘œì‹œ
                    if (targetDate > maxDate) return false;
                }
            }

            // Custom Date Range Filter (ì‹œì‘ì¼~ì¢…ë£Œì¼)
            if (startDate || endDate) {
                const dateField = dateMode === 'sdd' ? d.sddValue : d.crd;
                if (dateField && dateField !== '00:00:00') {
                    try {
                        const targetDate = new Date(dateField.replace(/\./g, '-'));
                        targetDate.setHours(0, 0, 0, 0);

                        if (startDate) {
                            const start = new Date(startDate);
                            start.setHours(0, 0, 0, 0);
                            if (targetDate < start) return false;
                        }
                        if (endDate) {
                            const end = new Date(endDate);
                            end.setHours(23, 59, 59, 999);
                            if (targetDate > end) return false;
                        }
                    } catch (e) {
                        log.warn('Date range filter parsing error:', e);
                    }
                } else {
                    // ë‚ ì§œê°€ ì—†ëŠ” ê²½ìš° í•„í„°ì—ì„œ ì œì™¸
                    return false;
                }
            }

                const yearMonth = getYearMonth(d);
                if (month && yearMonth !== month) return false;
                if (dest === 'asia' && !IMPORTANT_DESTINATIONS[d.destination]) return false;
                if (dest && dest !== 'asia' && d.destination !== dest) return false;
                if (vendor && d.outsoleVendor !== vendor) return false;
                if (factory && d.factory !== factory) return false;

                if (status) {
                    if (status === 'shipped' && !isShipped(d)) return false;
                    const s = d.production?.wh_in?.status;
                    if (status === 'completed' && s !== 'completed') return false;
                    if (status === 'partial' && s !== 'partial') return false;
                    if (status === 'pending' && s !== 'pending') return false;
                }

                if (quick) {
                    if (quick === 'delayed' && !isDelayed(d)) return false;
                    if (quick === 'warning' && !isWarning(d)) return false;
                    if (quick === 'today' && !isToday(d)) return false;
                    if (quick === 'week' && !isWithinWeek(d)) return false;
                    if (quick === 'month' && !isCurrentMonth(d)) return false;
                }

                if (search) {
                    const searchFields = [d.model, d.destination, d.outsoleVendor, d.poNumber, d.factory, d.article].join(' ').toLowerCase();
                    if (!searchFields.includes(search)) return false;
                }

                return true;
            });

            // Cache the result
            setCachedFilter(cacheKey, filteredData);
            log.debug('Filter result cached, entries:', filterCache.size);

            currentPage = 1;
            updateDashboard();
            } catch (error) {
                log.error('í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜:', error);
                showNotification('í•„í„° ì ìš© ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
                filteredData = allData;
                currentPage = 1;
                updateDashboard();
            }
        }

        function resetAllFilters() {
            clearFilterCache(); // Clear cache when filters are reset
            document.getElementById('monthFilter').value = '';
            document.getElementById('quickDateFilter').value = '';
            document.getElementById('destFilter').value = '';
            document.getElementById('vendorFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.getElementById('startDateFilter').value = '';
            document.getElementById('endDateFilter').value = '';
            document.querySelectorAll('#factoryFilter .filter-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('#factoryFilter .filter-chip[data-factory=""]').classList.add('active');
            applyFilters();
        }

        function updateDashboard() {
            updateWeeklySummary();
            updateSummary();
            updateAlerts();
            updateProcessFlow();
            updateFactoryCards();
            updateVendorSection();
            updateAsiaCards();
            updateCalendar();
            updateTabs();
            updateExecutiveInsights(); // ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
            updateWatchedPoDisplay(); // ê´€ì‹¬ PO í˜„í™© ì—…ë°ì´íŠ¸
        }

        // ì›”ìš” ì˜¤ë” í˜„í™© ìš”ì•½ ì—…ë°ì´íŠ¸
        function updateWeeklySummary() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            // SDD ê¸°ì¤€ ì§€ì—°/ê²½ê³  ê³„ì‚°
            let sddDelayed = 0, sddWarning = 0;
            // CRD ê¸°ì¤€ ì§€ì—°/ê²½ê³  ê³„ì‚° (CRD ëŒ€ë¹„ ì˜¤ëŠ˜ ë‚ ì§œ)
            let crdDelayed = 0, crdWarning = 0;
            // ì œí™” ìƒì‚° ì™„ë£Œ (sew_bal ì™„ë£Œ >= qty)
            let sewingComplete = 0;
            // ì°½ê³  ì¶œê³  ì™„ë£Œ (wh_out ì™„ë£Œ >= qty)
            let warehouseOut = 0;

            allData.forEach(d => {
                const qty = d.quantity || 0;
                const sewBalCompleted = d.production?.sew_bal?.completed || 0;
                const whOutCompleted = d.production?.wh_out?.completed || 0;
                const sdd = d.sddValue;
                const crd = d.crd;

                // ì œí™” ìƒì‚° ì™„ë£Œ (ì¬ë´‰ ì™„ë£ŒëŸ‰ >= ì£¼ë¬¸ëŸ‰)
                if (sewBalCompleted >= qty && qty > 0) {
                    sewingComplete++;
                }

                // ì°½ê³  ì¶œê³  ì™„ë£Œ (ì¶œê³ ëŸ‰ >= ì£¼ë¬¸ëŸ‰)
                if (whOutCompleted >= qty && qty > 0) {
                    warehouseOut++;
                }

                // ì•„ì§ ì¶œê³  ì•ˆ ëœ ì˜¤ë”ë§Œ ì§€ì—°/ê²½ê³  ì²´í¬
                if (whOutCompleted < qty) {
                    // SDD ê¸°ì¤€ (ê¸°ì¡´ isDelayed, isWarning ë¡œì§)
                    if (isDelayed(d)) {
                        sddDelayed++;
                    } else if (isWarning(d)) {
                        sddWarning++;
                    }

                    // CRD ê¸°ì¤€ (ì˜¤ëŠ˜ ë‚ ì§œì™€ CRD ë¹„êµ)
                    if (crd && crd !== '00:00:00') {
                        try {
                            const crdDate = new Date(crd.replace(/\./g, '-'));
                            crdDate.setHours(0, 0, 0, 0);
                            const diffDays = Math.floor((crdDate - today) / (1000 * 60 * 60 * 24));

                            if (diffDays < 0) {
                                // CRDê°€ ì´ë¯¸ ì§€ë‚¬ìŒ = ì§€ì—°
                                crdDelayed++;
                            } else if (diffDays <= 3) {
                                // CRDê°€ 3ì¼ ì´ë‚´ = ê²½ê³ 
                                crdWarning++;
                            }
                        } catch (e) { }
                    }
                }
            });

            // UI ì—…ë°ì´íŠ¸
            document.getElementById('sddDelayCount').textContent = sddDelayed + 'ê±´';
            document.getElementById('sddWarningCount').textContent = sddWarning + 'ê±´';
            document.getElementById('crdDelayCount').textContent = crdDelayed + 'ê±´';
            document.getElementById('crdWarningCount').textContent = crdWarning + 'ê±´';
            document.getElementById('sewingCompleteCount').textContent = sewingComplete + 'ê±´';
            document.getElementById('warehouseOutCount').textContent = warehouseOut + 'ê±´';
            document.getElementById('summaryUpdateTime').textContent = new Date().toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
        }

        function updateSummary() {
            const totalQty = filteredData.reduce((sum, d) => sum + (d.quantity || 0), 0);
            const totalCompleted = filteredData.reduce((sum, d) => sum + (d.production?.wh_in?.completed || 0), 0);
            const rate = totalQty > 0 ? (totalCompleted / totalQty * 100) : 0;

            document.getElementById('totalOrders').textContent = formatNumber(filteredData.length) + 'ê±´';
            document.getElementById('totalQty').textContent = formatNumber(totalQty) + 'ì¡±';
            document.getElementById('totalCompleted').textContent = formatNumber(totalCompleted) + 'ì¡±';
            document.getElementById('totalRate').textContent = rate.toFixed(1) + '%';
            document.getElementById('execCompletionRate').textContent = rate.toFixed(1) + '%';

            // Donut chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('rateDonut', document.getElementById('rateDonut'), {
                type: 'doughnut',
                data: { datasets: [{ data: [rate, 100 - rate], backgroundColor: ['#8b5cf6', '#e5e7eb'], borderWidth: 0 }] },
                options: { cutout: '70%', plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: true }
            });

            // Executive summary
            const todayOrders = allData.filter(isToday);
            const todayQty = todayOrders.reduce((sum, d) => sum + (d.quantity || 0), 0);
            document.getElementById('execTodayCount').textContent = todayOrders.length + 'ê±´';
            document.getElementById('execTodayQty').textContent = formatNumber(todayQty) + 'ì¡±';

            // Factory ranking
            const factoryRates = ['A', 'B', 'C', 'D'].map(f => {
                const fData = filteredData.filter(d => d.factory === f);
                const fQty = fData.reduce((s, d) => s + (d.quantity || 0), 0);
                const fCompleted = fData.reduce((s, d) => s + (d.production?.wh_in?.completed || 0), 0);
                return { factory: f, rate: fQty > 0 ? (fCompleted / fQty * 100) : 0 };
            }).sort((a, b) => b.rate - a.rate);

            document.getElementById('execFactoryRanking').innerHTML = factoryRates.map((f, i) =>
                `<span class="mr-2">${i + 1}. Factory ${f.factory}: ${f.rate.toFixed(1)}%</span>`
            ).join('');

            // Warnings
            const delayed = allData.filter(isDelayed);
            const warnings = [];
            if (delayed.length > 0) warnings.push(`<span aria-hidden="true">ğŸš¨ </span>ì§€ì—° ${delayed.length}ê±´`);

            const bottleneck = findBottleneck();
            if (bottleneck && bottleneck.rate < 80) warnings.push(`<span aria-hidden="true">ğŸ”´ </span>ë³‘ëª©: ${PROCESS_NAMES[bottleneck.key]} (${bottleneck.rate.toFixed(1)}%)`);

            document.getElementById('execWarnings').innerHTML = warnings.length > 0 ? warnings.join(' | ') : '<span aria-hidden="true">âœ… </span>ì •ìƒ';
        }

        function findBottleneck() {
            let minRate = 100, bottleneckKey = null;
            PROCESS_ORDER.forEach(key => {
                let completed = 0, total = 0;
                filteredData.forEach(d => {
                    const p = d.production?.[key];
                    if (p) {
                        completed += p.completed || 0;
                        total += (p.completed || 0) + (p.pending || 0);
                    }
                });
                const rate = total > 0 ? (completed / total * 100) : 100;
                if (rate < minRate) { minRate = rate; bottleneckKey = key; }
            });
            return { key: bottleneckKey, rate: minRate };
        }

        function updateAlerts() {
            const delayed = allData.filter(isDelayed);
            const warning = allData.filter(isWarning);
            const delayedQty = delayed.reduce((sum, d) => sum + (d.quantity || 0), 0);
            const warningQty = warning.reduce((sum, d) => sum + (d.quantity || 0), 0);

            document.getElementById('delayedOrderCount').textContent = delayed.length + 'ê±´';
            document.getElementById('delayedOrderQty').textContent = formatNumber(delayedQty) + 'ì¡±';
            document.getElementById('warningOrderCount').textContent = warning.length + 'ê±´';
            document.getElementById('warningOrderQty').textContent = formatNumber(warningQty) + 'ì¡±';
            document.getElementById('execDelayCount').textContent = delayed.length + 'ê±´';

            // Inventory
            let invQty = 0, invCount = 0;
            allData.forEach(d => {
                const diff = (d.production?.wh_in?.completed || 0) - (d.production?.wh_out?.completed || 0);
                if (diff > 0) { invQty += diff; invCount++; }
            });
            document.getElementById('inventoryCount').textContent = formatNumber(invQty) + 'ì¡±';
            document.getElementById('inventoryOrders').textContent = invCount + 'ê±´';
            document.getElementById('execInventory').textContent = formatNumber(invQty);
            document.getElementById('execInventoryOrders').textContent = invCount + 'ê±´';

            // Shipped orders (ì„ ì  ì™„ë£Œ)
            const shipped = allData.filter(isShipped);
            const shippedQty = shipped.reduce((sum, d) => sum + (d.quantity || 0), 0);
            document.getElementById('shippedOrderCount').textContent = shipped.length + 'ê±´';
            document.getElementById('shippedOrderQty').textContent = formatNumber(shippedQty) + 'ì¡±';

            // Show alert section (show if any alerts or shipped orders exist)
            const alertSection = document.getElementById('alertSection');
            const delayAlert = document.getElementById('delayAlert');
            const delayCount = document.getElementById('delayCount');
            if (alertSection) alertSection.classList.toggle('hidden', delayed.length === 0 && warning.length === 0 && shipped.length === 0);
            if (delayAlert) delayAlert.classList.toggle('hidden', delayed.length === 0);
            if (delayCount) delayCount.textContent = delayed.length;
        }

        function updateProcessFlow() {
            const processData = {};
            let minRate = 100, bottleneckKey = null;

            PROCESS_ORDER.forEach(key => {
                processData[key] = { completed: 0, pending: 0 };
            });

            filteredData.forEach(d => {
                PROCESS_ORDER.forEach(key => {
                    const p = d.production?.[key];
                    if (p) {
                        processData[key].completed += p.completed || 0;
                        processData[key].pending += p.pending || 0;
                    }
                });
            });

            // Find bottleneck
            PROCESS_ORDER.forEach(key => {
                const data = processData[key];
                const total = data.completed + data.pending;
                const rate = total > 0 ? (data.completed / total * 100) : 100;
                if (rate < minRate) { minRate = rate; bottleneckKey = key; }
            });

            // Funnel chart
            document.getElementById('funnelChart').innerHTML = PROCESS_ORDER.map((key, i) => {
                const data = processData[key];
                const total = data.completed + data.pending;
                const rate = total > 0 ? (data.completed / total * 100) : 0;
                const width = 100 - (i * 2);
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';
                const isBottleneck = key === bottleneckKey && minRate < 80;

                return `<div class="funnel-step ${isBottleneck ? 'bottleneck' : ''}" style="background: linear-gradient(to right, ${color}40, ${color}20); width: ${width}%"
                    onclick="showProcessDetail('${key}')" role="button" tabindex="0" aria-label="${PROCESS_NAMES[key]} ${rate.toFixed(1)}% ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showProcessDetail('${key}')" title="${PROCESS_NAMES[key]}: ${rate.toFixed(1)}%">
                    <div class="text-xs font-medium">${PROCESS_NAMES[key]}</div>
                    <div class="text-lg font-bold" style="color: ${color}">${rate.toFixed(0)}%</div>
                    <div class="text-xs text-secondary">${formatNumber(data.completed)}</div>
                    ${isBottleneck ? '<div class="text-xs text-red-500">ë³‘ëª©</div>' : ''}
                </div>`;
            }).join('');

            // Progress bars
            document.getElementById('processProgress').innerHTML = PROCESS_ORDER.map(key => {
                const data = processData[key];
                const total = data.completed + data.pending;
                const rate = total > 0 ? (data.completed / total * 100) : 0;
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';
                const isBottleneck = key === bottleneckKey && minRate < 80;

                return `<div class="flex items-center gap-3 cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-700 p-2 rounded ${isBottleneck ? 'ring-2 ring-red-500' : ''}" onclick="showProcessDetail('${key}')" role="button" tabindex="0" aria-label="${PROCESS_NAMES[key]} ê³µì • ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showProcessDetail('${key}')">
                    <div class="w-16 text-sm font-medium">${PROCESS_NAMES[key]}${isBottleneck ? '<span aria-hidden="true"> ğŸ”´</span>' : ''}</div>
                    <div class="flex-1 progress-bar" role="progressbar" aria-valuenow="${rate.toFixed(0)}" aria-valuemin="0" aria-valuemax="100" aria-valuetext="${rate.toFixed(0)}% ì™„ë£Œ" aria-label="${PROCESS_NAMES[key]} ì™„ë£Œìœ¨"><div class="progress-fill" style="width: ${rate}%; background: ${color};"></div></div>
                    <div class="w-24 text-right text-sm"><span class="font-medium" style="color: ${color}">${rate.toFixed(1)}%</span> <span class="text-secondary">(${formatNumber(data.completed)})</span></div>
                </div>`;
            }).join('');
        }

        function updateVendorSection() {
            const vendorData = {};
            let totalQty = 0;

            filteredData.forEach(d => {
                const v = d.outsoleVendor || '(ë¯¸ì§€ì •)';
                if (!vendorData[v]) vendorData[v] = { count: 0, qty: 0, completed: 0 };
                vendorData[v].count++;
                vendorData[v].qty += d.quantity || 0;
                vendorData[v].completed += d.production?.wh_in?.completed || 0;
                totalQty += d.quantity || 0;
            });

            const sorted = Object.entries(vendorData).sort((a, b) => b[1].qty - a[1].qty);
            const isDarkMode = document.documentElement.classList.contains('dark');

            // Chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('vendor', document.getElementById('vendorChart'), {
                type: 'pie',
                data: {
                    labels: sorted.slice(0, 8).map(([v]) => v),
                    datasets: [{ data: sorted.slice(0, 8).map(([, d]) => d.qty), backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#64748b'] }]
                },
                options: { plugins: { legend: { position: 'right', labels: { color: isDarkMode ? '#fff' : '#333' } } }, responsive: true, maintainAspectRatio: false }
            });

            document.getElementById('vendorTableBody').innerHTML = sorted.slice(0, 10).map(([vendor, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                return `<tr class="border-b border-theme hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" onclick="showVendorDetail('${vendor}')" role="button" tabindex="0" aria-label="${vendor} ë²¤ë” ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showVendorDetail('${vendor}')">
                    <td class="px-3 py-2 text-xs">${vendor}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-3 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        function updateFactoryCards() {
            const factoryData = { A: { count: 0, qty: 0, completed: 0 }, B: { count: 0, qty: 0, completed: 0 }, C: { count: 0, qty: 0, completed: 0 }, D: { count: 0, qty: 0, completed: 0 } };
            filteredData.forEach(d => {
                if (!factoryData[d.factory]) return;
                factoryData[d.factory].qty += d.quantity || 0;
                factoryData[d.factory].completed += d.production?.wh_in?.completed || 0;
                factoryData[d.factory].count++;
            });

            document.getElementById('factoryCards').innerHTML = ['A', 'B', 'C', 'D'].map(f => {
                const d = factoryData[f];
                const rate = d.qty > 0 ? (d.completed / d.qty * 100) : 0;
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';
                return `<div class="p-3 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="showFactoryDetail('${f}')" role="button" tabindex="0" aria-label="Factory ${f} ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showFactoryDetail('${f}')">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">Factory ${f}</span>
                        <span class="text-sm font-medium" style="color: ${color}">${rate.toFixed(1)}%</span>
                    </div>
                    <div class="text-xs text-secondary mt-1">${formatNumber(d.count)}ê±´ Â· ${formatNumber(d.qty)}ì¡±</div>
                    <div class="progress-bar mt-2" style="height: 6px;" role="progressbar" aria-valuenow="${rate.toFixed(0)}" aria-valuemin="0" aria-valuemax="100" aria-valuetext="${rate.toFixed(0)}% ì™„ë£Œ" aria-label="Factory ${f} ì™„ë£Œìœ¨"><div class="progress-fill" style="width: ${rate}%; background: ${color};"></div></div>
                </div>`;
            }).join('');

            // Radar chart
            const radarData = ['A', 'B', 'C', 'D'].map(f => {
                const fData = filteredData.filter(d => d.factory === f);
                const qty = fData.reduce((s, d) => s + (d.quantity || 0), 0);
                const completed = fData.reduce((s, d) => s + (d.production?.wh_in?.completed || 0), 0);
                return qty > 0 ? (completed / qty * 100) : 0;
            });

            const isDarkMode = document.documentElement.classList.contains('dark');
            // Factory radar chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('factoryRadar', document.getElementById('factoryRadar'), {
                type: 'radar',
                data: {
                    labels: ['Factory A', 'Factory B', 'Factory C', 'Factory D'],
                    datasets: [{ label: 'ì™„ë£Œìœ¨', data: radarData, backgroundColor: 'rgba(59, 130, 246, 0.3)', borderColor: '#3b82f6' }]
                },
                options: { scales: { r: { min: 0, max: 100, ticks: { color: isDarkMode ? '#fff' : '#333' }, pointLabels: { color: isDarkMode ? '#fff' : '#333' } } }, plugins: { legend: { display: false } } }
            });
        }

        function updateAsiaCards() {
            const asiaData = {};
            const displayNames = { 'Japan': 'ì¼ë³¸', 'South Korea': 'í•œêµ­', 'China': 'ì¤‘êµ­', 'Taiwan': 'ëŒ€ë§Œ', 'India': 'ì¸ë„' };
            const displayOrder = ['Japan', 'South Korea', 'China', 'Taiwan', 'India'];

            displayOrder.forEach(c => { asiaData[c] = { qty: 0, completed: 0, count: 0 }; });

            filteredData.forEach(d => {
                let country = null;
                if (d.destination === 'Japan') country = 'Japan';
                else if (d.destination === 'South Korea' || d.destination === 'Korea') country = 'South Korea';
                else if (d.destination === 'China') country = 'China';
                else if (d.destination === 'Taiwan') country = 'Taiwan';
                else if (d.destination === 'India') country = 'India';

                if (country) {
                    asiaData[country].qty += d.quantity || 0;
                    asiaData[country].completed += d.production?.wh_in?.completed || 0;
                    asiaData[country].count++;
                }
            });

            document.getElementById('asiaCards').innerHTML = displayOrder.map(country => {
                const data = asiaData[country] || { qty: 0, completed: 0, count: 0 };
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';
                return `<div class="bg-gray-50 dark:bg-gray-700 p-4 rounded-xl cursor-pointer hover:shadow-md transition" onclick="showCountryDetail('${country}')" role="button" tabindex="0" aria-label="${country} êµ­ê°€ ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showCountryDetail('${country}')">
                    <div class="text-2xl mb-1">${IMPORTANT_DESTINATIONS[country]}</div>
                    <div class="font-medium">${displayNames[country]}</div>
                    <div class="text-sm text-secondary">${formatNumber(data.qty)}ì¡± Â· ${data.count}ê±´</div>
                    <div class="progress-bar mt-2" style="height: 6px;" role="progressbar" aria-valuenow="${rate.toFixed(0)}" aria-valuemin="0" aria-valuemax="100" aria-valuetext="${rate.toFixed(0)}% ì™„ë£Œ" aria-label="${country} ì™„ë£Œìœ¨"><div class="progress-fill" style="width: ${rate}%; background: ${color};"></div></div>
                    <div class="text-xs text-right mt-1" style="color: ${color}">${rate.toFixed(1)}%</div>
                </div>`;
            }).join('');
        }

        function updateCalendar() {
            const year = currentCalendarDate.getFullYear();
            const month = currentCalendarDate.getMonth();
            document.getElementById('calendarMonth').textContent = `${year}ë…„ ${month + 1}ì›”`;

            const calendarData = {};
            const today = new Date();

            allData.forEach(d => {
                const dateVal = getDateValue(d);
                if (!dateVal || dateVal === '00:00:00') return;
                try {
                    const targetDate = new Date(dateVal.replace(/\./g, '-'));
                    if (targetDate.getFullYear() === year && targetDate.getMonth() === month) {
                        const day = targetDate.getDate();
                        if (!calendarData[day]) calendarData[day] = { count: 0, qty: 0, delayed: 0, warning: 0 };
                        calendarData[day].count++;
                        calendarData[day].qty += d.quantity || 0;

                        const isComplete = (d.production?.wh_in?.completed || 0) >= (d.quantity || 0);
                        if (!isComplete) {
                            if (targetDate < today) calendarData[day].delayed++;
                            else {
                                const diff = (targetDate - today) / (1000 * 60 * 60 * 24);
                                if (diff <= 3) calendarData[day].warning++;
                            }
                        }
                    }
                } catch {}
            });

            const firstDay = new Date(year, month, 1).getDay();
            const daysInMonth = new Date(year, month + 1, 0).getDate();
            const dayNames = ['ì¼', 'ì›”', 'í™”', 'ìˆ˜', 'ëª©', 'ê¸ˆ', 'í† '];

            let html = dayNames.map(d => `<div class="text-center font-medium text-sm text-secondary py-2">${d}</div>`).join('');
            for (let i = 0; i < firstDay; i++) html += '<div></div>';

            for (let day = 1; day <= daysInMonth; day++) {
                const data = calendarData[day];
                const isCurrentDay = today.getFullYear() === year && today.getMonth() === month && today.getDate() === day;
                let dayClass = 'calendar-day';
                if (isCurrentDay) dayClass += ' today';
                if (data?.delayed > 0) dayClass += ' delayed';
                else if (data?.warning > 0) dayClass += ' warning';

                html += `<div class="${dayClass}" onclick="showCalendarDayDetail(${year}, ${month}, ${day})" role="button" tabindex="0" aria-label="${year}ë…„ ${month+1}ì›” ${day}ì¼ ${data ? data.count+'ê±´' : ''} ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showCalendarDayDetail(${year}, ${month}, ${day})">
                    <div class="font-medium">${day}</div>
                    ${data ? `<div class="text-xs">${data.count}ê±´</div>` : ''}
                </div>`;
            }

            document.getElementById('shippingCalendar').innerHTML = html;
        }

        function prevMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() - 1); updateCalendar(); }
        function nextMonth() { currentCalendarDate.setMonth(currentCalendarDate.getMonth() + 1); updateCalendar(); }

        function showCalendarDayDetail(year, month, day) {
            const targetDate = new Date(year, month, day);
            const orders = allData.filter(d => {
                const dateVal = getDateValue(d);
                if (!dateVal || dateVal === '00:00:00') return false;
                try {
                    const dDate = new Date(dateVal.replace(/\./g, '-'));
                    return dDate.toDateString() === targetDate.toDateString();
                } catch (e) { console.warn("Date parsing error:", e); return false; }
            });
            showOrderListModal(`<span aria-hidden="true">ğŸ“… </span>${year}-${String(month+1).padStart(2,'0')}-${String(day).padStart(2,'0')} ì˜ˆì •`, orders);
        }

        function updateTabs() {
            updateMonthlyTab();
            updateDestinationTab();
            updateModelTab();
            updateFactoryTab();
            updateVendorTab();
            updateHeatmapTab();
            updateDataTab();
        }

        function updateMonthlyTab() {
            const monthlyData = {};
            filteredData.forEach(d => {
                const ym = getYearMonth(d);
                if (!ym) return;
                if (!monthlyData[ym]) monthlyData[ym] = { count: 0, qty: 0, completed: 0 };
                monthlyData[ym].count++;
                monthlyData[ym].qty += d.quantity || 0;
                monthlyData[ym].completed += d.production?.wh_in?.completed || 0;
            });

            let sorted = Object.entries(monthlyData).sort((a, b) => a[0].localeCompare(b[0]));
            sorted = sortData(sorted.map(([k, v]) => ({ month: k, ...v })), 'monthly');
            if (!Array.isArray(sorted[0])) sorted = sorted.map(d => [d.month, d]);

            const isDarkMode = document.documentElement.classList.contains('dark');
            // Monthly chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('monthly', document.getElementById('monthlyChart'), {
                type: 'bar',
                data: {
                    labels: sorted.map(([m]) => m),
                    datasets: [
                        { label: 'ì£¼ë¬¸ëŸ‰', data: sorted.map(([, d]) => d.qty), backgroundColor: '#3b82f6' },
                        { label: 'ì™„ë£ŒëŸ‰', data: sorted.map(([, d]) => d.completed), backgroundColor: '#22c55e' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDarkMode ? '#fff' : '#333' } } } }
            });

            document.querySelector('#monthlyTable tbody').innerHTML = sorted.map(([month, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                return `<tr class="border-b border-theme"><td class="px-4 py-2">${month}</td><td class="px-4 py-2 text-right">${formatNumber(data.count)}</td><td class="px-4 py-2 text-right">${formatNumber(data.qty)}</td><td class="px-4 py-2 text-right">${formatNumber(data.completed)}</td><td class="px-4 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td></tr>`;
            }).join('');
        }

        function updateDestinationTab() {
            const destData = {};
            filteredData.forEach(d => {
                if (!d.destination) return;
                if (!destData[d.destination]) destData[d.destination] = { count: 0, qty: 0, completed: 0 };
                destData[d.destination].count++;
                destData[d.destination].qty += d.quantity || 0;
                destData[d.destination].completed += d.production?.wh_in?.completed || 0;
            });

            const sorted = Object.entries(destData).sort((a, b) => b[1].qty - a[1].qty);
            const isDarkMode = document.documentElement.classList.contains('dark');

            // Destination chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('dest', document.getElementById('destChart'), {
                type: 'doughnut',
                data: {
                    labels: sorted.slice(0, 10).map(([d]) => d),
                    datasets: [{ data: sorted.slice(0, 10).map(([, d]) => d.qty), backgroundColor: ['#3b82f6', '#22c55e', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#14b8a6', '#64748b', '#0ea5e9', '#f97316'] }]
                },
                options: { plugins: { legend: { position: 'right', labels: { color: isDarkMode ? '#fff' : '#333' } } }, responsive: true, maintainAspectRatio: false }
            });

            document.querySelector('#destTable tbody').innerHTML = sorted.map(([dest, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                const flag = IMPORTANT_DESTINATIONS[dest] || '';
                return `<tr class="border-b border-theme hover:bg-gray-50 dark:hover:bg-gray-700 clickable-row" onclick="showCountryDetail('${dest}')" role="button" tabindex="0" aria-label="${dest} í–‰ì„ ì§€ ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showCountryDetail('${dest}')">
                    <td class="px-4 py-2">${flag} ${dest}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.completed)}</td>
                    <td class="px-4 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        function updateModelTab() {
            const modelData = {};
            filteredData.forEach(d => {
                if (!d.model) return;
                if (!modelData[d.model]) modelData[d.model] = { count: 0, qty: 0, completed: 0 };
                modelData[d.model].count++;
                modelData[d.model].qty += d.quantity || 0;
                modelData[d.model].completed += d.production?.wh_in?.completed || 0;
            });

            const sorted = Object.entries(modelData).sort((a, b) => b[1].qty - a[1].qty);
            const isDarkMode = document.documentElement.classList.contains('dark');

            // Model chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('model', document.getElementById('modelChart'), {
                type: 'bar',
                data: {
                    labels: sorted.slice(0, 15).map(([m]) => m),
                    datasets: [{ label: 'ìˆ˜ëŸ‰', data: sorted.slice(0, 15).map(([, d]) => d.qty), backgroundColor: '#3b82f6' }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDarkMode ? '#fff' : '#333' } } } }
            });

            document.querySelector('#modelTable tbody').innerHTML = sorted.slice(0, 30).map(([model, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                return `<tr class="border-b border-theme hover:bg-gray-50 dark:hover:bg-gray-700 clickable-row" onclick="showModelDetail('${model}')" role="button" tabindex="0" aria-label="${model} ëª¨ë¸ ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showModelDetail('${model}')">
                    <td class="px-4 py-2 text-xs">${model}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.completed)}</td>
                    <td class="px-4 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        function updateFactoryTab() {
            const factoryData = {};
            filteredData.forEach(d => {
                if (!factoryData[d.factory]) factoryData[d.factory] = { count: 0, qty: 0, completed: 0 };
                factoryData[d.factory].count++;
                factoryData[d.factory].qty += d.quantity || 0;
                factoryData[d.factory].completed += d.production?.wh_in?.completed || 0;
            });

            const isDarkMode = document.documentElement.classList.contains('dark');
            // Factory chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('factory', document.getElementById('factoryChart'), {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D'].map(f => `Factory ${f}`),
                    datasets: [
                        { label: 'ì£¼ë¬¸ëŸ‰', data: ['A', 'B', 'C', 'D'].map(f => factoryData[f]?.qty || 0), backgroundColor: '#3b82f6' },
                        { label: 'ì™„ë£ŒëŸ‰', data: ['A', 'B', 'C', 'D'].map(f => factoryData[f]?.completed || 0), backgroundColor: '#22c55e' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDarkMode ? '#fff' : '#333' } } } }
            });

            let html = '';
            ['A', 'B', 'C', 'D'].forEach(f => {
                const fData = filteredData.filter(d => d.factory === f);
                const totalQty = fData.reduce((sum, d) => sum + (d.quantity || 0), 0);
                const whInCompleted = fData.reduce((sum, d) => sum + (d.production?.wh_in?.completed || 0), 0);
                const rate = totalQty > 0 ? (whInCompleted / totalQty * 100) : 0;
                html += `<div class="p-4 bg-gray-50 dark:bg-gray-700 rounded-lg cursor-pointer hover:bg-gray-100 dark:hover:bg-gray-600" onclick="showFactoryDetail('${f}')" role="button" tabindex="0" aria-label="Factory ${f} ê³µì • ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showFactoryDetail('${f}')">
                    <div class="flex justify-between items-center mb-2"><span class="font-semibold">Factory ${f}</span><span class="text-sm" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}% ì™„ë£Œ</span></div>
                    <div class="text-sm text-secondary">${formatNumber(fData.length)}ê±´ Â· ${formatNumber(totalQty)}ì¡±</div>
                </div>`;
            });
            document.getElementById('factoryProcessDetail').innerHTML = html;
        }

        function updateVendorTab() {
            const vendorData = {};
            filteredData.forEach(d => {
                const v = d.outsoleVendor || '(ë¯¸ì§€ì •)';
                if (!vendorData[v]) vendorData[v] = { count: 0, qty: 0, completed: 0 };
                vendorData[v].count++;
                vendorData[v].qty += d.quantity || 0;
                vendorData[v].completed += d.production?.wh_in?.completed || 0;
            });

            const sorted = Object.entries(vendorData).sort((a, b) => b[1].qty - a[1].qty);
            const isDarkMode = document.documentElement.classList.contains('dark');

            // Vendor detail chart - using updateOrCreateChart for memory efficiency
            updateOrCreateChart('vendorDetail', document.getElementById('vendorDetailChart'), {
                type: 'bar',
                data: {
                    labels: sorted.slice(0, 10).map(([v]) => v),
                    datasets: [
                        { label: 'ì£¼ë¬¸ëŸ‰', data: sorted.slice(0, 10).map(([, d]) => d.qty), backgroundColor: '#3b82f6' },
                        { label: 'ì™„ë£ŒëŸ‰', data: sorted.slice(0, 10).map(([, d]) => d.completed), backgroundColor: '#22c55e' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { labels: { color: isDarkMode ? '#fff' : '#333' } } } }
            });

            document.querySelector('#vendorDetailTable tbody').innerHTML = sorted.map(([vendor, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                return `<tr class="border-b border-theme hover:bg-gray-50 dark:hover:bg-gray-700 cursor-pointer" onclick="showVendorDetail('${vendor}')" role="button" tabindex="0" aria-label="${vendor} ë²¤ë” ìƒì„¸ ì •ë³´" onkeydown="if(event.key==='Enter')showVendorDetail('${vendor}')">
                    <td class="px-3 py-2 text-xs">${vendor}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.completed)}</td>
                    <td class="px-3 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');

            // Model x Vendor Heatmap
            renderModelVendorHeatmap();
        }

        function renderModelVendorHeatmap() {
            const models = [...new Set(filteredData.map(d => d.model).filter(Boolean))];
            const vendors = [...new Set(filteredData.map(d => d.outsoleVendor || '(ë¯¸ì§€ì •)').filter(Boolean))];

            // Get top models and vendors by quantity
            const modelQty = {};
            const vendorQty = {};
            filteredData.forEach(d => {
                modelQty[d.model] = (modelQty[d.model] || 0) + (d.quantity || 0);
                const v = d.outsoleVendor || '(ë¯¸ì§€ì •)';
                vendorQty[v] = (vendorQty[v] || 0) + (d.quantity || 0);
            });

            const topModels = Object.entries(modelQty).sort((a, b) => b[1] - a[1]).slice(0, 10).map(([m]) => m);
            const topVendors = Object.entries(vendorQty).sort((a, b) => b[1] - a[1]).slice(0, 8).map(([v]) => v);

            // Build heatmap data
            const heatmapData = {};
            let maxVal = 0;
            filteredData.forEach(d => {
                const model = d.model;
                const vendor = d.outsoleVendor || '(ë¯¸ì§€ì •)';
                if (topModels.includes(model) && topVendors.includes(vendor)) {
                    const key = `${model}|${vendor}`;
                    heatmapData[key] = (heatmapData[key] || 0) + (d.quantity || 0);
                    if (heatmapData[key] > maxVal) maxVal = heatmapData[key];
                }
            });

            let html = '<table class="w-full text-xs"><caption class="sr-only">ëª¨ë¸ë³„ ë²¤ë” íˆíŠ¸ë§µ</caption><thead><tr><th scope="col" class="heatmap-cell">ëª¨ë¸ \\ ë²¤ë”</th>';
            topVendors.forEach(v => { html += `<th scope="col" class="heatmap-cell">${v.substring(0, 15)}</th>`; });
            html += '</tr></thead><tbody>';

            topModels.forEach(model => {
                html += `<tr><td class="heatmap-cell font-medium text-left">${model.substring(0, 20)}</td>`;
                topVendors.forEach(vendor => {
                    const val = heatmapData[`${model}|${vendor}`] || 0;
                    const intensity = maxVal > 0 ? val / maxVal : 0;
                    const bg = val > 0 ? `rgba(59, 130, 246, ${0.2 + intensity * 0.8})` : '#f3f4f6';
                    const textColor = intensity > 0.5 ? '#fff' : '#333';
                    html += `<td class="heatmap-cell" style="background: ${bg}; color: ${textColor}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                });
                html += '</tr>';
            });

            html += '</tbody></table>';
            document.getElementById('modelVendorHeatmap').innerHTML = html;
        }

        function updateHeatmapTab() {
            // Country x Month heatmap
            const countryMonthData = {};
            const months = [...new Set(filteredData.map(d => getYearMonth(d)).filter(Boolean))].sort();
            const countries = Object.keys(IMPORTANT_DESTINATIONS);

            let maxCountryMonth = 0;
            filteredData.forEach(d => {
                const ym = getYearMonth(d);
                const country = countries.find(c => d.destination === c || (c === 'South Korea' && d.destination === 'Korea'));
                if (country && ym) {
                    const key = `${country}|${ym}`;
                    countryMonthData[key] = (countryMonthData[key] || 0) + (d.quantity || 0);
                    if (countryMonthData[key] > maxCountryMonth) maxCountryMonth = countryMonthData[key];
                }
            });

            let html1 = '<table class="w-full text-xs"><caption class="sr-only">êµ­ê°€ë³„ ì›”ë³„ íˆíŠ¸ë§µ</caption><thead><tr><th scope="col" class="heatmap-cell">êµ­ê°€ \\ ì›”</th>';
            months.forEach(m => { html1 += `<th scope="col" class="heatmap-cell">${m}</th>`; });
            html1 += '</tr></thead><tbody>';

            countries.forEach(country => {
                const displayName = { 'Japan': 'ì¼ë³¸', 'South Korea': 'í•œêµ­', 'China': 'ì¤‘êµ­', 'Taiwan': 'ëŒ€ë§Œ', 'India': 'ì¸ë„' }[country];
                html1 += `<tr><td class="heatmap-cell font-medium text-left">${IMPORTANT_DESTINATIONS[country]} ${displayName}</td>`;
                months.forEach(month => {
                    const val = countryMonthData[`${country}|${month}`] || 0;
                    const intensity = maxCountryMonth > 0 ? val / maxCountryMonth : 0;
                    const bg = val > 0 ? `rgba(34, 197, 94, ${0.2 + intensity * 0.8})` : '#f3f4f6';
                    const textColor = intensity > 0.5 ? '#fff' : '#333';
                    html1 += `<td class="heatmap-cell" style="background: ${bg}; color: ${textColor}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                });
                html1 += '</tr>';
            });
            html1 += '</tbody></table>';
            document.getElementById('countryMonthHeatmap').innerHTML = html1;

            // Model x Destination heatmap
            const modelDestData = {};
            const topModels = Object.entries(
                filteredData.reduce((acc, d) => { acc[d.model] = (acc[d.model] || 0) + (d.quantity || 0); return acc; }, {})
            ).sort((a, b) => b[1] - a[1]).slice(0, 10).map(([m]) => m);
            const topDest = Object.entries(
                filteredData.reduce((acc, d) => { acc[d.destination] = (acc[d.destination] || 0) + (d.quantity || 0); return acc; }, {})
            ).sort((a, b) => b[1] - a[1]).slice(0, 8).map(([d]) => d);

            let maxModelDest = 0;
            filteredData.forEach(d => {
                if (topModels.includes(d.model) && topDest.includes(d.destination)) {
                    const key = `${d.model}|${d.destination}`;
                    modelDestData[key] = (modelDestData[key] || 0) + (d.quantity || 0);
                    if (modelDestData[key] > maxModelDest) maxModelDest = modelDestData[key];
                }
            });

            let html2 = '<table class="w-full text-xs"><caption class="sr-only">ëª¨ë¸ë³„ í–‰ì„ ì§€ íˆíŠ¸ë§µ</caption><thead><tr><th scope="col" class="heatmap-cell">ëª¨ë¸ \\ í–‰ì„ ì§€</th>';
            topDest.forEach(d => { html2 += `<th scope="col" class="heatmap-cell">${d}</th>`; });
            html2 += '</tr></thead><tbody>';

            topModels.forEach(model => {
                html2 += `<tr><td class="heatmap-cell font-medium text-left">${model.substring(0, 20)}</td>`;
                topDest.forEach(dest => {
                    const val = modelDestData[`${model}|${dest}`] || 0;
                    const intensity = maxModelDest > 0 ? val / maxModelDest : 0;
                    const bg = val > 0 ? `rgba(139, 92, 246, ${0.2 + intensity * 0.8})` : '#f3f4f6';
                    const textColor = intensity > 0.5 ? '#fff' : '#333';
                    html2 += `<td class="heatmap-cell" style="background: ${bg}; color: ${textColor}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                });
                html2 += '</tr>';
            });
            html2 += '</tbody></table>';
            document.getElementById('modelDestHeatmap').innerHTML = html2;
        }

        function updateDataTab() {
            const start = (currentPage - 1) * PAGE_SIZE;
            const end = start + PAGE_SIZE;
            const pageData = filteredData.slice(start, end);
            const totalPages = Math.ceil(filteredData.length / PAGE_SIZE);

            document.getElementById('dataCount').textContent = `(${formatNumber(filteredData.length)}ê±´)`;
            document.getElementById('pagination').textContent = `${currentPage} / ${totalPages} í˜ì´ì§€`;

            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const isPrevDisabled = currentPage === 1;
            const isNextDisabled = currentPage >= totalPages;

            prevBtn.disabled = isPrevDisabled;
            prevBtn.setAttribute('aria-disabled', isPrevDisabled.toString());
            nextBtn.disabled = isNextDisabled;
            nextBtn.setAttribute('aria-disabled', isNextDisabled.toString());

            const getIcon = (status) => {
                if (status === 'completed') return '<span aria-hidden="true">âœ…</span>';
                if (status === 'partial') return '<span aria-hidden="true">ğŸ”„</span>';
                return '<span aria-hidden="true">â³</span>';
            };

            document.querySelector('#dataTable tbody').innerHTML = pageData.map(d => {
                const shipped = isShipped(d);
                const delayed = isDelayed(d);
                const warning = isWarning(d);
                const rowClass = shipped ? 'shipped-highlight' : delayed ? 'delay-highlight' : warning ? 'warning-highlight' : '';
                return `<tr class="border-b border-theme ${rowClass} clickable-row" onclick="showOrderProcessDetail(${filteredData.indexOf(d)})" role="button" tabindex="0" aria-label="${escapeHtml(d.poNumber)} ì˜¤ë” ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter')showOrderProcessDetail(${filteredData.indexOf(d)})">
                    <td class="px-2 py-2">${d.factory}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.poNumber) || '-'}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.model) || '-'}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.article) || '-'}</td>
                    <td class="px-2 py-2">${escapeHtml(d.destination) || '-'}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.outsoleVendor) || '-'}</td>
                    <td class="px-2 py-2 text-right">${formatNumber(d.quantity || 0)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.s_cut?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.sew_bal?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.ass_bal?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.wh_in?.status)}</td>
                    <td class="px-2 py-2 text-xs">${d.crd || '-'}</td>
                    <td class="px-2 py-2 text-xs">${d.sddValue || '-'}</td>
                    <td class="px-2 py-2 text-center">${shipped ? '<span class="shipped-badge"><span aria-hidden="true">ğŸš¢ </span>ì„ ì </span>' : delayed ? '<span aria-hidden="true">ğŸš¨</span>' : warning ? '<span aria-hidden="true">âš¡</span>' : d.production?.wh_in?.status === 'completed' ? '<span aria-hidden="true">âœ…</span>' : '<span aria-hidden="true">â³</span>'}</td>
                </tr>`;
            }).join('');
        }

        function prevPage() { if (currentPage > 1) { currentPage--; updateDataTab(); } }
        function nextPage() { const totalPages = Math.ceil(filteredData.length / PAGE_SIZE); if (currentPage < totalPages) { currentPage++; updateDataTab(); } }

        // Modal functions
        function showProcessDetail(processKey) {
            const incompleteOrders = filteredData.filter(d => {
                const p = d.production?.[processKey];
                return p && p.status !== 'completed';
            });
            showOrderListModal(`${PROCESS_NAMES[processKey]} ë¯¸ì™„ë£Œ ì˜¤ë”`, incompleteOrders);
        }

        function showDelayedOrders() { showOrderListModal('<span aria-hidden="true">ğŸš¨ </span>ì§€ì—° ì˜¤ë”', allData.filter(isDelayed)); }
        function showWarningOrders() { showOrderListModal('<span aria-hidden="true">âš¡ </span>3ì¼ ë‚´ ì˜ˆì • (ë¯¸ì™„ë£Œ)', allData.filter(isWarning)); }

        function showInventoryOrders() {
            const inventory = allData.filter(d => {
                const whIn = d.production?.wh_in?.completed || 0;
                const whOut = d.production?.wh_out?.completed || 0;
                return whIn > whOut;
            });
            showOrderListModal('<span aria-hidden="true">ğŸ“¦ </span>ì°½ê³  ì¬ê³  ì˜¤ë”', inventory);
        }

        function showShippedOrders() {
            showOrderListModal('<span aria-hidden="true">ğŸš¢ </span>ì„ ì  ì™„ë£Œ ì˜¤ë”', allData.filter(isShipped));
        }

        function showVendorDetail(vendor) { showOrderListModal(`${vendor} ìƒì„¸`, filteredData.filter(d => (d.outsoleVendor || '(ë¯¸ì§€ì •)') === vendor)); }
        function showFactoryDetail(factory) { showOrderListModal(`Factory ${factory} ìƒì„¸`, filteredData.filter(d => d.factory === factory)); }
        function showCountryDetail(country) {
            const orders = filteredData.filter(d => {
                if (country === 'South Korea') return d.destination === 'South Korea' || d.destination === 'Korea';
                return d.destination === country;
            });
            showOrderListModal(`${IMPORTANT_DESTINATIONS[country] || ''} ${country} ìƒì„¸`, orders);
        }
        function showModelDetail(model) { showOrderListModal(`${model} ìƒì„¸`, filteredData.filter(d => d.model === model)); }

        function showOrderListModal(title, orders) {
            document.getElementById('modalTitle').textContent = `${title} (${orders.length}ê±´)`;

            const totalQty = orders.reduce((sum, d) => sum + (d.quantity || 0), 0);
            const totalCompleted = orders.reduce((sum, d) => sum + (d.production?.wh_in?.completed || 0), 0);
            const rate = totalQty > 0 ? (totalCompleted / totalQty * 100) : 0;

            let html = `<div class="grid grid-cols-4 gap-4 mb-4 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div><div class="text-secondary text-sm">ì˜¤ë” ìˆ˜</div><div class="text-xl font-bold">${orders.length}ê±´</div></div>
                <div><div class="text-secondary text-sm">ì£¼ë¬¸ëŸ‰</div><div class="text-xl font-bold">${formatNumber(totalQty)}ì¡±</div></div>
                <div><div class="text-secondary text-sm">ì™„ë£ŒëŸ‰</div><div class="text-xl font-bold text-green-600">${formatNumber(totalCompleted)}ì¡±</div></div>
                <div><div class="text-secondary text-sm">ì™„ë£Œìœ¨</div><div class="text-xl font-bold" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</div></div>
            </div>`;

            const getIcon = (status) => status === 'completed' ? '<span aria-hidden="true">âœ…</span>' : status === 'partial' ? '<span aria-hidden="true">ğŸ”„</span>' : '<span aria-hidden="true">â³</span>';
            const modalPageSize = 50;
            const displayOrders = orders.slice(0, modalPageSize);

            html += `<div class="overflow-x-auto"><table class="w-full text-sm">
                <caption class="sr-only">ì˜¤ë” ìƒì„¸ ëª©ë¡</caption>
                <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                    <th scope="col" class="px-2 py-2 text-left">ê³µì¥</th>
                    <th scope="col" class="px-2 py-2 text-left">PO</th>
                    <th scope="col" class="px-2 py-2 text-left">ëª¨ë¸</th>
                    <th scope="col" class="px-2 py-2 text-left">Article</th>
                    <th scope="col" class="px-2 py-2 text-left">í–‰ì„ ì§€</th>
                    <th scope="col" class="px-2 py-2 text-left">ì•„ì›ƒì†” ë²¤ë”</th>
                    <th scope="col" class="px-2 py-2 text-right">ìˆ˜ëŸ‰</th>
                    <th scope="col" class="px-2 py-2 text-center">ì¬ë‹¨</th>
                    <th scope="col" class="px-2 py-2 text-center">ì¬ë´‰</th>
                    <th scope="col" class="px-2 py-2 text-center">ì¡°ë¦½</th>
                    <th scope="col" class="px-2 py-2 text-center">ì…ê³ </th>
                    <th scope="col" class="px-2 py-2 text-left">CRD</th>
                    <th scope="col" class="px-2 py-2 text-left">SDD</th>
                    <th scope="col" class="px-2 py-2 text-center">ìƒíƒœ</th>
                </tr></thead><tbody>`;

            displayOrders.forEach((d, i) => {
                const shipped = isShipped(d);
                const delayed = isDelayed(d);
                const warning = isWarning(d);
                const rowClass = shipped ? 'shipped-highlight' : delayed ? 'delay-highlight' : warning ? 'warning-highlight' : '';
                const globalIndex = allData.indexOf(d);
                html += `<tr class="border-b border-theme ${rowClass} clickable-row" onclick="closeOrderModal(); showOrderProcessDetail(${globalIndex})" role="button" tabindex="0" aria-label="${escapeHtml(d.poNumber)} ì˜¤ë” ìƒì„¸ ë³´ê¸°" onkeydown="if(event.key==='Enter'){closeOrderModal(); showOrderProcessDetail(${globalIndex})}">
                    <td class="px-2 py-2">${d.factory}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.poNumber) || '-'}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.model) || '-'}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.article) || '-'}</td>
                    <td class="px-2 py-2">${escapeHtml(d.destination) || '-'}</td>
                    <td class="px-2 py-2 text-xs">${escapeHtml(d.outsoleVendor) || '-'}</td>
                    <td class="px-2 py-2 text-right">${formatNumber(d.quantity || 0)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.s_cut?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.sew_bal?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.ass_bal?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.wh_in?.status)}</td>
                    <td class="px-2 py-2 text-xs">${d.crd || '-'}</td>
                    <td class="px-2 py-2 text-xs">${d.sddValue || '-'}</td>
                    <td class="px-2 py-2 text-center">${shipped ? '<span class="shipped-badge"><span aria-hidden="true">ğŸš¢ </span>ì„ ì </span>' : delayed ? '<span aria-hidden="true">ğŸš¨</span>' : warning ? '<span aria-hidden="true">âš¡</span>' : d.production?.wh_in?.status === 'completed' ? '<span aria-hidden="true">âœ…</span>' : '<span aria-hidden="true">â³</span>'}</td>
                </tr>`;
            });

            html += '</tbody></table></div>';
            if (orders.length > modalPageSize) {
                html += `<div class="mt-4 text-center text-secondary">... ì™¸ ${orders.length - modalPageSize}ê±´ (ì „ì²´ ë³´ê¸°ëŠ” ìƒì„¸ íƒ­ ì´ìš©)</div>`;
            }

            document.getElementById('modalContent').innerHTML = html;
            const modal = document.getElementById('orderDetailModal');
            modal.classList.remove('hidden');
            trapFocus(modal); // Focus trap for accessibility
        }

        function closeOrderModal() {
            document.getElementById('orderDetailModal').classList.add('hidden');
            releaseFocus(); // Restore focus
        }

        // Order Process Detail Modal (NEW)
        function showOrderProcessDetail(index) {
            const d = allData[index];
            if (!d) return;

            document.getElementById('orderProcessTitle').textContent = `ì˜¤ë” ìƒì„¸: ${escapeHtml(d.poNumber) || '-'}`;

            let html = `
            <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6 p-4 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div><div class="text-secondary text-xs">PO ë²ˆí˜¸</div><div class="font-bold">${escapeHtml(d.poNumber) || '-'}</div></div>
                <div><div class="text-secondary text-xs">Article (PGSC)</div><div class="font-bold">${escapeHtml(d.article) || '-'}</div></div>
                <div><div class="text-secondary text-xs">ëª¨ë¸</div><div class="font-bold text-sm">${escapeHtml(d.model) || '-'}</div></div>
                <div><div class="text-secondary text-xs">ìˆ˜ëŸ‰</div><div class="font-bold">${formatNumber(d.quantity || 0)}ì¡±</div></div>
                <div><div class="text-secondary text-xs">ê³µì¥</div><div class="font-bold">Factory ${d.factory}</div></div>
                <div><div class="text-secondary text-xs">í–‰ì„ ì§€</div><div class="font-bold">${escapeHtml(d.destination) || '-'}</div></div>
                <div><div class="text-secondary text-xs">CRD (ê³ ê°ìš”ì²­ì¼)</div><div class="font-bold">${d.crd || '-'}</div></div>
                <div><div class="text-secondary text-xs">SDD</div><div class="font-bold">${d.sddValue || '-'}</div></div>
                <div><div class="text-secondary text-xs">ì•„ì›ƒì†” ë²¤ë”</div><div class="font-bold">${escapeHtml(d.outsoleVendor) || '-'}</div></div>
                <div><div class="text-secondary text-xs">ìƒ‰ìƒ</div><div class="font-bold">${d.color || '-'}</div></div>
                <div><div class="text-secondary text-xs">ì‹œì¦Œ</div><div class="font-bold">${escapeHtml(d.season) || '-'}</div></div>
                <div><div class="text-secondary text-xs">ë‹¨ìœ„</div><div class="font-bold">${escapeHtml(d.unit) || '-'}</div></div>
                <div><div class="text-secondary text-xs">AQL ê²€ì‚¬</div><div class="font-bold ${d.aql ? 'text-blue-600' : 'text-gray-400'}">${d.aql ? '<span aria-hidden="true">âœ… </span>í•„ìš”' : 'ë¶ˆí•„ìš”'}</div></div>
            </div>

            <h4 class="font-semibold mb-3 mt-4"><span aria-hidden="true">ğŸ“¦ </span>ì”ëŸ‰ í˜„í™©</h4>
            <div class="grid grid-cols-5 gap-2 mb-4 p-3 bg-gray-50 dark:bg-gray-700 rounded-lg">
                <div class="text-center p-2 rounded ${(d.remaining?.osc || 0) > 0 ? 'bg-yellow-100 dark:bg-yellow-900' : 'bg-green-100 dark:bg-green-900'}">
                    <div class="text-xs text-secondary">ì™¸ì£¼ ì”ëŸ‰</div>
                    <div class="font-bold ${(d.remaining?.osc || 0) > 0 ? 'text-yellow-700' : 'text-green-700'}">${formatNumber(d.remaining?.osc || 0)}</div>
                </div>
                <div class="text-center p-2 rounded ${(d.remaining?.sew || 0) > 0 ? 'bg-yellow-100 dark:bg-yellow-900' : 'bg-green-100 dark:bg-green-900'}">
                    <div class="text-xs text-secondary">ì¬ë´‰ ì”ëŸ‰</div>
                    <div class="font-bold ${(d.remaining?.sew || 0) > 0 ? 'text-yellow-700' : 'text-green-700'}">${formatNumber(d.remaining?.sew || 0)}</div>
                </div>
                <div class="text-center p-2 rounded ${(d.remaining?.ass || 0) > 0 ? 'bg-yellow-100 dark:bg-yellow-900' : 'bg-green-100 dark:bg-green-900'}">
                    <div class="text-xs text-secondary">ì œí™” ì”ëŸ‰</div>
                    <div class="font-bold ${(d.remaining?.ass || 0) > 0 ? 'text-yellow-700' : 'text-green-700'}">${formatNumber(d.remaining?.ass || 0)}</div>
                </div>
                <div class="text-center p-2 rounded ${(d.remaining?.whIn || 0) > 0 ? 'bg-yellow-100 dark:bg-yellow-900' : 'bg-green-100 dark:bg-green-900'}">
                    <div class="text-xs text-secondary">ì…ê³  ì”ëŸ‰</div>
                    <div class="font-bold ${(d.remaining?.whIn || 0) > 0 ? 'text-yellow-700' : 'text-green-700'}">${formatNumber(d.remaining?.whIn || 0)}</div>
                </div>
                <div class="text-center p-2 rounded ${(d.remaining?.whOut || 0) > 0 ? 'bg-yellow-100 dark:bg-yellow-900' : 'bg-green-100 dark:bg-green-900'}">
                    <div class="text-xs text-secondary">ì¶œê³  ì”ëŸ‰</div>
                    <div class="font-bold ${(d.remaining?.whOut || 0) > 0 ? 'text-yellow-700' : 'text-green-700'}">${formatNumber(d.remaining?.whOut || 0)}</div>
                </div>
            </div>

            <h4 class="font-semibold mb-4"><span aria-hidden="true">ğŸ“Š </span>ê³µì •ë³„ ìƒì‚° í˜„í™©</h4>
            <div class="process-timeline mb-6 justify-center">`;

            PROCESS_ORDER.forEach((key, i) => {
                const p = d.production?.[key];
                const completed = p?.completed || 0;
                const pending = p?.pending || 0;
                const total = completed + pending;
                const status = p?.status || 'pending';

                let stepClass = 'pending';
                if (status === 'completed') stepClass = 'completed';
                else if (status === 'partial') stepClass = 'in-progress';

                html += `
                <div class="process-step ${stepClass}">
                    <div class="text-xs font-medium mb-1">${PROCESS_NAMES[key]}</div>
                    <div class="text-lg font-bold" aria-hidden="true">${status === 'completed' ? 'âœ…' : status === 'partial' ? 'ğŸ”„' : 'â³'}</div>
                    <div class="text-xs">${formatNumber(completed)}/${formatNumber(total)}</div>
                    <div class="text-xs text-secondary">${total > 0 ? ((completed/total)*100).toFixed(0) : 0}%</div>
                </div>`;

                if (i < PROCESS_ORDER.length - 1) {
                    html += '<div class="process-arrow" aria-hidden="true">â†’</div>';
                }
            });

            html += `</div>

            <h4 class="font-semibold mb-4"><span aria-hidden="true">ğŸ“ˆ </span>ê³µì •ë³„ ìƒì„¸ í˜„í™©</h4>
            <div class="overflow-x-auto">
                <table class="w-full text-sm">
                    <caption class="sr-only">ê³µì •ë³„ ìƒì„¸ í˜„í™©</caption>
                    <thead class="bg-gray-50 dark:bg-gray-700">
                        <tr>
                            <th scope="col" class="px-3 py-2 text-left">ê³µì •</th>
                            <th scope="col" class="px-3 py-2 text-right">ì™„ë£Œ</th>
                            <th scope="col" class="px-3 py-2 text-right">ë¯¸ì™„ë£Œ</th>
                            <th scope="col" class="px-3 py-2 text-right">í•©ê³„</th>
                            <th scope="col" class="px-3 py-2 text-right">ì™„ë£Œìœ¨</th>
                            <th scope="col" class="px-3 py-2 text-center">ìƒíƒœ</th>
                        </tr>
                    </thead>
                    <tbody>`;

            PROCESS_ORDER.forEach(key => {
                const p = d.production?.[key];
                const completed = p?.completed || 0;
                const pending = p?.pending || 0;
                const total = completed + pending;
                const rate = total > 0 ? (completed / total * 100) : 0;
                const status = p?.status || 'pending';
                const statusIcon = status === 'completed' ? '<span aria-hidden="true">âœ… </span>ì™„ë£Œ' : status === 'partial' ? '<span aria-hidden="true">ğŸ”„ </span>ì§„í–‰ì¤‘' : '<span aria-hidden="true">â³ </span>ëŒ€ê¸°';
                const rateColor = rate >= 100 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';

                html += `<tr class="border-b border-theme">
                    <td class="px-3 py-2 font-medium">${PROCESS_NAMES[key]}</td>
                    <td class="px-3 py-2 text-right text-green-600">${formatNumber(completed)}</td>
                    <td class="px-3 py-2 text-right text-gray-500">${formatNumber(pending)}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(total)}</td>
                    <td class="px-3 py-2 text-right font-medium" style="color: ${rateColor}">${rate.toFixed(1)}%</td>
                    <td class="px-3 py-2 text-center">${statusIcon}</td>
                </tr>`;
            });

            html += `</tbody></table></div>`;

            document.getElementById('orderProcessContent').innerHTML = html;
            const modal = document.getElementById('orderProcessModal');
            modal.classList.remove('hidden');
            trapFocus(modal); // Focus trap for accessibility
        }

        function closeOrderProcessModal() {
            document.getElementById('orderProcessModal').classList.add('hidden');
            releaseFocus(); // Restore focus
        }

        // Keyboard handling
        function handleKeyboard(e) {
            if (e.target.tagName === 'INPUT' || e.target.tagName === 'SELECT') return;

            switch(e.key.toLowerCase()) {
                case 's': document.getElementById('searchInput').focus(); e.preventDefault(); break;
                case 'f': document.getElementById('monthFilter').focus(); e.preventDefault(); break;
                case 'r': resetAllFilters(); break;
                case 'd': document.querySelector('[data-tab="data"]').click(); break;
                case 'escape': closeOrderModal(); closeOrderProcessModal(); break;
                case 'arrowleft': if (document.querySelector('[data-tab="data"]').classList.contains('tab-active')) prevPage(); break;
                case 'arrowright': if (document.querySelector('[data-tab="data"]').classList.contains('tab-active')) nextPage(); break;
            }
        }

        // Utility functions
        // XSS ë°©ì§€ë¥¼ ìœ„í•œ HTML ì´ìŠ¤ì¼€ì´í”„ í•¨ìˆ˜
        function escapeHtml(str) {
            if (str === null || str === undefined) return '';
            const div = document.createElement('div');
            div.textContent = String(str);
            return div.innerHTML;
        }

        function formatNumber(num) { return num.toLocaleString('ko-KR'); }
        function debounce(fn, delay) { let t; return (...args) => { clearTimeout(t); t = setTimeout(() => fn(...args), delay); }; }
        function toggleDarkMode() {
            document.documentElement.classList.toggle('dark');
            const isDark = document.documentElement.classList.contains('dark');
            document.getElementById('darkModeIcon').innerHTML = isDark ? '<span aria-hidden="true">â˜€ï¸</span>' : '<span aria-hidden="true">ğŸŒ™</span>';
            document.getElementById('darkModeToggle')?.setAttribute('aria-pressed', isDark.toString());

            // ì°¨íŠ¸ ìƒ‰ìƒì€ ê° ì°¨íŠ¸ ìƒì„± ì‹œ isDarkMode ì²´í¬í•˜ì—¬ ì ìš©ë¨
            // ë‹¤í¬ëª¨ë“œ ì „í™˜ ì‹œ ì°¨íŠ¸ ì¬ìƒì„± ì—†ì´ CSSë§Œ ë³€ê²½ (ì„±ëŠ¥ ìµœì í™”)
            // ì°¨íŠ¸ í…ìŠ¤íŠ¸ ìƒ‰ìƒì€ Tailwind dark: í´ë˜ìŠ¤ë¡œ ì²˜ë¦¬
        }

        // Export
        function exportToExcel() {
            const exportData = filteredData.map(d => ({
                'ê³µì¥': d.factory,
                'POë²ˆí˜¸': d.poNumber,
                'ëª¨ë¸': d.model,
                'Article': d.article,
                'í–‰ì„ ì§€': d.destination,
                'ì•„ì›ƒì†”ë²¤ë”': d.outsoleVendor,
                'ìˆ˜ëŸ‰': d.quantity,
                'CRD': d.crd,
                'SDD': d.sddValue,
                'ì¬ë‹¨ì™„ë£Œ': d.production?.s_cut?.completed || 0,
                'ì¬ë´‰ì™„ë£Œ': d.production?.sew_bal?.completed || 0,
                'ì¡°ë¦½ì™„ë£Œ': d.production?.ass_bal?.completed || 0,
                'ì…ê³ ì™„ë£Œ': d.production?.wh_in?.completed || 0
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, `rachgia_export_${new Date().toISOString().slice(0,10)}.xlsx`);
        }

        // ========================================
        // ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸ KPI ê³„ì‚° í•¨ìˆ˜ë“¤
        // ========================================
        const UNIT_PRICE = 10; // 1ì¡±ë‹¹ í‰ê·  ë‹¨ê°€ ($10)

        // OTD (On-Time Delivery) ê³„ì‚°
        function calculateOTDRate() {
            const completed = filteredData.filter(d => {
                const whOutCompleted = d.production?.wh_out?.completed || 0;
                return whOutCompleted >= (d.quantity || 0);
            });

            const onTime = completed.filter(d => {
                if (!d.sddValue || !d.crd) return true;
                const sdd = new Date(d.sddValue);
                const crd = new Date(d.crd);
                return sdd <= crd;
            });

            return {
                rate: completed.length > 0 ? (onTime.length / completed.length * 100) : 100,
                onTimeCount: onTime.length,
                completedCount: completed.length,
                totalCount: filteredData.length
            };
        }

        // ìœ„í—˜ ë§¤ì¶œì•¡ ê³„ì‚° (ì§€ì—° ìˆ˜ëŸ‰ Ã— ë‹¨ê°€)
        function calculateRevenueAtRisk() {
            let delayedQty = 0;
            let delayedOrders = 0;

            filteredData.forEach(d => {
                if (d.isDelayed) {
                    const whOutCompleted = d.production?.wh_out?.completed || 0;
                    const remaining = Math.max(0, (d.quantity || 0) - whOutCompleted);
                    delayedQty += remaining;
                    delayedOrders++;
                }
            });

            return {
                revenue: delayedQty * UNIT_PRICE,
                quantity: delayedQty,
                orders: delayedOrders
            };
        }

        // AQL í•©ê²©ë¥  ê³„ì‚°
        function calculateAQLStats() {
            const withAQL = filteredData.filter(d => d.aql !== undefined && d.aql !== null);
            const passed = withAQL.filter(d => d.aql === true || d.aql === 'true' || d.aql === 'Y');

            return {
                rate: withAQL.length > 0 ? (passed.length / withAQL.length * 100) : 100,
                passedCount: passed.length,
                inspectedCount: withAQL.length
            };
        }

        // ì§€ì—° ì‹¬ê°ë„ ë¶„ë¥˜ (ê²½ë¯¸: 1-3ì¼, ì£¼ì˜: 4-7ì¼, ì‹¬ê°: 7ì¼+)
        function calculateDelaySeverity() {
            const today = new Date();
            today.setHours(0, 0, 0, 0);

            let minor = 0, moderate = 0, severe = 0;

            filteredData.forEach(d => {
                if (d.isDelayed && d.crd) {
                    const crd = new Date(d.crd);
                    const diffDays = Math.floor((today - crd) / (1000 * 60 * 60 * 24));

                    if (diffDays <= 3) minor++;
                    else if (diffDays <= 7) moderate++;
                    else severe++;
                }
            });

            return { minor, moderate, severe, total: minor + moderate + severe };
        }

        // ì§€ì—° ì›ì¸ ë¶„ì„ (ì²« ë²ˆì§¸ ë¯¸ì™„ë£Œ ê³µì •)
        function analyzeRootCause() {
            const causeCounts = {};

            filteredData.forEach(d => {
                if (d.isDelayed) {
                    // ì²« ë²ˆì§¸ ë¯¸ì™„ë£Œ ê³µì • ì°¾ê¸°
                    for (const key of PROCESS_ORDER) {
                        const p = d.production?.[key];
                        const completed = p?.completed || 0;
                        const total = (p?.completed || 0) + (p?.pending || 0);

                        if (total > 0 && completed < total) {
                            const name = PROCESS_NAMES[key] || key;
                            causeCounts[name] = (causeCounts[name] || 0) + 1;
                            break;
                        }
                    }
                }
            });

            // ì •ë ¬í•˜ì—¬ ìƒìœ„ 5ê°œ ë°˜í™˜
            return Object.entries(causeCounts)
                .sort((a, b) => b[1] - a[1])
                .slice(0, 5);
        }

        // ë²¤ë” ì„±ê³¼ ì ìˆ˜ ê³„ì‚°
        function calculateVendorPerformance() {
            const vendorStats = {};

            filteredData.forEach(d => {
                const vendor = d.outsoleVendor || 'Unknown';
                if (!vendorStats[vendor]) {
                    vendorStats[vendor] = { total: 0, completed: 0, delayed: 0 };
                }
                vendorStats[vendor].total++;

                const whOutCompleted = d.production?.wh_out?.completed || 0;
                if (whOutCompleted >= (d.quantity || 0)) {
                    vendorStats[vendor].completed++;
                }
                if (d.isDelayed) {
                    vendorStats[vendor].delayed++;
                }
            });

            // ì ìˆ˜ ê³„ì‚°: (ì™„ë£Œìœ¨ Ã— 70) + (ì •ì‹œìœ¨ Ã— 30)
            const vendorScores = Object.entries(vendorStats).map(([vendor, stats]) => {
                const completionRate = stats.total > 0 ? stats.completed / stats.total : 0;
                const onTimeRate = stats.total > 0 ? 1 - (stats.delayed / stats.total) : 1;
                const score = (completionRate * 70) + (onTimeRate * 30);

                return {
                    vendor,
                    score: score.toFixed(1),
                    total: stats.total,
                    completed: stats.completed,
                    delayed: stats.delayed
                };
            });

            return vendorScores.sort((a, b) => parseFloat(b.score) - parseFloat(a.score)).slice(0, 5);
        }

        // ë³‘ëª© ê³µì • ì˜ˆì¸¡
        function predictBottleneck() {
            const processStats = {};

            PROCESS_ORDER.forEach(key => {
                processStats[key] = { completed: 0, pending: 0, total: 0 };
            });

            filteredData.forEach(d => {
                PROCESS_ORDER.forEach(key => {
                    const p = d.production?.[key];
                    processStats[key].completed += p?.completed || 0;
                    processStats[key].pending += p?.pending || 0;
                    processStats[key].total += (p?.completed || 0) + (p?.pending || 0);
                });
            });

            // ì™„ë£Œìœ¨ì´ ê°€ì¥ ë‚®ì€ ê³µì • ì°¾ê¸°
            let bottleneck = null;
            let lowestRate = 100;
            let affectedQty = 0;

            PROCESS_ORDER.forEach(key => {
                const stats = processStats[key];
                if (stats.total > 0) {
                    const rate = (stats.completed / stats.total) * 100;
                    if (rate < lowestRate) {
                        lowestRate = rate;
                        bottleneck = PROCESS_NAMES[key] || key;
                        affectedQty = stats.pending;
                    }
                }
            });

            return {
                process: bottleneck || 'ì—†ìŒ',
                rate: lowestRate.toFixed(1),
                affectedQty: affectedQty,
                affectedOrders: filteredData.filter(d => {
                    const key = Object.keys(PROCESS_NAMES).find(k => PROCESS_NAMES[k] === bottleneck);
                    if (!key) return false;
                    const p = d.production?.[key];
                    return p && (p.completed || 0) < ((p.completed || 0) + (p.pending || 0));
                }).length
            };
        }

        // ê²½ì˜ì§„ ì¸ì‚¬ì´íŠ¸ ì—…ë°ì´íŠ¸
        function updateExecutiveInsights() {
            const otd = calculateOTDRate();
            const revenue = calculateRevenueAtRisk();
            const aql = calculateAQLStats();
            const severity = calculateDelaySeverity();
            const rootCause = analyzeRootCause();
            const vendors = calculateVendorPerformance();
            const bottleneck = predictBottleneck();

            // OTD Rate - HTML ID: kpiOtdRate, kpiOtdOrders
            const kpiOtdRate = document.getElementById('kpiOtdRate');
            const kpiOtdOrders = document.getElementById('kpiOtdOrders');
            if (kpiOtdRate) {
                const statusEmoji = otd.rate >= 95 ? '<span aria-hidden="true">âœ… </span>' : otd.rate >= 85 ? '<span aria-hidden="true">âš ï¸ </span>' : '<span aria-hidden="true">ğŸš¨ </span>';
                kpiOtdRate.textContent = otd.rate.toFixed(1) + '%';
                kpiOtdRate.className = 'text-3xl font-bold ' + (otd.rate >= 95 ? 'text-green-300' : otd.rate >= 85 ? 'text-yellow-300' : 'text-red-300');
                if (kpiOtdOrders) kpiOtdOrders.innerHTML = `${statusEmoji}${otd.onTimeCount}/${otd.completedCount}ê±´ ì •ì‹œ`;
            }

            // Revenue at Risk - HTML ID: kpiRevenueRisk, kpiRiskOrders
            const kpiRevenueRisk = document.getElementById('kpiRevenueRisk');
            const kpiRiskOrders = document.getElementById('kpiRiskOrders');
            if (kpiRevenueRisk) {
                kpiRevenueRisk.textContent = '$' + formatNumber(revenue.revenue);
                kpiRevenueRisk.className = 'text-3xl font-bold ' + (revenue.revenue === 0 ? 'text-green-300' : revenue.revenue < 50000 ? 'text-yellow-300' : 'text-red-300');
                if (kpiRiskOrders) kpiRiskOrders.textContent = `${formatNumber(revenue.quantity)}ì¡± (${revenue.orders}ê±´)`;
            }

            // AQL Pass Rate - HTML ID: kpiAqlRate, kpiAqlCount
            const kpiAqlRate = document.getElementById('kpiAqlRate');
            const kpiAqlCount = document.getElementById('kpiAqlCount');
            if (kpiAqlRate) {
                const aqlStatus = aql.rate >= 98 ? '<span aria-hidden="true">âœ… </span>' : aql.rate >= 95 ? '<span aria-hidden="true">âš ï¸ </span>' : '<span aria-hidden="true">ğŸš¨ </span>';
                kpiAqlRate.textContent = aql.rate.toFixed(1) + '%';
                kpiAqlRate.className = 'text-3xl font-bold ' + (aql.rate >= 98 ? 'text-green-300' : aql.rate >= 95 ? 'text-yellow-300' : 'text-red-300');
                if (kpiAqlCount) kpiAqlCount.innerHTML = `${aqlStatus}${aql.passedCount}/${aql.inspectedCount}ê±´`;
            }

            // Bottleneck - HTML ID: kpiBottleneckStage, kpiBottleneckRisk
            const kpiBottleneckStage = document.getElementById('kpiBottleneckStage');
            const kpiBottleneckRisk = document.getElementById('kpiBottleneckRisk');
            if (kpiBottleneckStage) {
                kpiBottleneckStage.textContent = bottleneck.process;
                if (kpiBottleneckRisk) kpiBottleneckRisk.textContent = `ì™„ë£Œìœ¨ ${bottleneck.rate}% | ${formatNumber(bottleneck.affectedQty)}ì¡± ì”ëŸ‰`;
            }

            // Delay Severity - HTML ID: delayMild, delayModerate, delaySevere
            const delayMild = document.getElementById('delayMild');
            const delayModerate = document.getElementById('delayModerate');
            const delaySevere = document.getElementById('delaySevere');
            if (delayMild) delayMild.textContent = severity.minor + 'ê±´';
            if (delayModerate) delayModerate.textContent = severity.moderate + 'ê±´';
            if (delaySevere) delaySevere.textContent = severity.severe + 'ê±´';

            // Root Cause - HTML ID: primaryRootCause, primaryRootCauseCount
            const primaryRootCause = document.getElementById('primaryRootCause');
            const primaryRootCauseCount = document.getElementById('primaryRootCauseCount');
            if (primaryRootCause && rootCause.length > 0) {
                primaryRootCause.textContent = rootCause[0][0];
                if (primaryRootCauseCount) primaryRootCauseCount.textContent = rootCause[0][1];
            }

            // Delay Severity Chart
            updateDelaySeverityChart(severity);

            // Root Cause Chart
            updateRootCauseChart(rootCause);

            // Vendor Performance List - HTML ID: vendorPerformanceList
            updateVendorPerformanceList(vendors);

            // ë‹´ë‹¹ì ê¶Œê³ ì‚¬í•­ ì—…ë°ì´íŠ¸
            updateActionRecommendations();
        }

        // ========================================
        // ë‹´ë‹¹ì ê¶Œê³ ì‚¬í•­ ì‹œìŠ¤í…œ
        // ========================================

        function updateActionRecommendations() {
            const now = new Date();
            const timeStr = now.toLocaleTimeString('ko-KR', { hour: '2-digit', minute: '2-digit' });
            document.getElementById('recommendationTime').textContent = `ì—…ë°ì´íŠ¸: ${timeStr}`;

            // ë°ì´í„° ë¶„ì„
            const bottleneck = predictBottleneck();
            const delayedOrders = filteredData.filter(d => d.isDelayed);
            const severity = calculateDelaySeverity();
            const vendors = calculateVendorPerformance();
            const otd = calculateOTDRate();
            const aql = calculateAQLStats();

            // ê³„íš ë‹´ë‹¹ì ê¶Œê³  ìƒì„±
            const planningRecs = generatePlanningRecommendations(bottleneck, delayedOrders, severity, vendors, otd);
            document.getElementById('planningRecommendations').innerHTML = planningRecs.html;

            // í’ˆì§ˆ ë‹´ë‹¹ì ê¶Œê³  ìƒì„±
            const qualityRecs = generateQualityRecommendations(delayedOrders, aql, bottleneck, vendors);
            document.getElementById('qualityRecommendations').innerHTML = qualityRecs.html;

            // ë¦¬ìŠ¤í¬ ì ìˆ˜ ê³„ì‚° ë° í‘œì‹œ
            const riskScore = calculateRiskScore(delayedOrders, severity, bottleneck, vendors, aql);
            updateRiskScoreDisplay(riskScore);
        }

        function generatePlanningRecommendations(bottleneck, delayedOrders, severity, vendors, otd) {
            const recs = [];

            // 1. ë³‘ëª© ê³µì • ê¶Œê³ 
            if (bottleneck.completionRate < 80) {
                recs.push({
                    priority: 'high',
                    icon: 'ğŸ”´',
                    text: `[${bottleneck.process}] ë³‘ëª© ê³µì • (${bottleneck.completionRate.toFixed(1)}%)`,
                    action: 'â†’ ë¦¬ì†ŒìŠ¤ ì¶”ê°€ ë°°ì¹˜ ê¶Œê³ '
                });
            }

            // 2. ì§€ì—° ì˜¤ë” ê¶Œê³ 
            if (delayedOrders.length > 0) {
                const severeDelays = severity.severe;
                if (severeDelays > 0) {
                    recs.push({
                        priority: 'high',
                        icon: 'ğŸš¨',
                        text: `ì‹¬ê° ì§€ì—° ${severeDelays}ê±´ (7ì¼ ì´ìƒ)`,
                        action: 'â†’ ê¸´ê¸‰ ë³µêµ¬ ê³„íš ìˆ˜ë¦½ í•„ìš”'
                    });
                } else if (delayedOrders.length >= 5) {
                    recs.push({
                        priority: 'medium',
                        icon: 'âš ï¸',
                        text: `ì§€ì—° ì˜¤ë” ${delayedOrders.length}ê±´ ë°œìƒ`,
                        action: 'â†’ ì›ì¸ ë¶„ì„ ë° ìš°ì„ ìˆœìœ„ ì¬ì¡°ì •'
                    });
                }
            }

            // 3. ì¤‘ìš” ê±°ë˜ì²˜ ì§€ì—° ê¶Œê³ 
            const importantDelays = delayedOrders.filter(d =>
                ['Japan', 'South Korea', 'USA'].includes(d.destination)
            );
            if (importantDelays.length > 0) {
                recs.push({
                    priority: 'high',
                    icon: 'ğŸ¯',
                    text: `ì¤‘ìš” ê±°ë˜ì²˜ ì§€ì—° ${importantDelays.length}ê±´`,
                    action: 'â†’ ìµœìš°ì„  ìƒì‚°ë¼ì¸ ë°°ì •'
                });
            }

            // 4. ì €ì„±ê³¼ ë²¤ë” ê¶Œê³ 
            const lowPerformVendors = vendors.filter(v => v.score < 60);
            if (lowPerformVendors.length > 0) {
                recs.push({
                    priority: 'medium',
                    icon: 'ğŸ­',
                    text: `ì €ì„±ê³¼ ë²¤ë” ${lowPerformVendors.length}ê°œ`,
                    action: 'â†’ ë²¤ë” ë¯¸íŒ… ë° ê°œì„  ìš”êµ¬'
                });
            }

            // 5. OTD ë¯¸ë‹¬ ê¶Œê³ 
            if (otd.rate < 85) {
                recs.push({
                    priority: 'high',
                    icon: 'ğŸ“‰',
                    text: `ì •ì‹œë‚©ê¸°ìœ¨ ${otd.rate.toFixed(1)}% (ëª©í‘œ 95%)`,
                    action: 'â†’ ê¸´ê¸‰ ëŒ€ì‘ ì²´ê³„ ê°€ë™'
                });
            } else if (otd.rate < 95) {
                recs.push({
                    priority: 'medium',
                    icon: 'ğŸ“Š',
                    text: `ì •ì‹œë‚©ê¸°ìœ¨ ${otd.rate.toFixed(1)}% (ëª©í‘œ 95%)`,
                    action: 'â†’ ê°œì„  ë°©ì•ˆ ê²€í†  í•„ìš”'
                });
            }

            // ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì–‘í˜¸ ë©”ì‹œì§€
            if (recs.length === 0) {
                recs.push({
                    priority: 'good',
                    icon: 'âœ…',
                    text: 'í˜„ì¬ íŠ¹ì´ì‚¬í•­ ì—†ìŒ',
                    action: 'ìƒì‚° ê³„íš ì •ìƒ ì§„í–‰ ì¤‘'
                });
            }

            const html = recs.map(r => `
                <div class="flex items-start gap-2 p-2 rounded ${
                    r.priority === 'high' ? 'bg-red-50 dark:bg-red-900/30' :
                    r.priority === 'medium' ? 'bg-yellow-50 dark:bg-yellow-900/30' :
                    'bg-green-50 dark:bg-green-900/30'
                }">
                    <span aria-hidden="true">${r.icon}</span>
                    <div>
                        <div class="font-medium ${
                            r.priority === 'high' ? 'text-red-700 dark:text-red-300' :
                            r.priority === 'medium' ? 'text-yellow-700 dark:text-yellow-300' :
                            'text-green-700 dark:text-green-300'
                        }">${escapeHtml(r.text)}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${escapeHtml(r.action)}</div>
                    </div>
                </div>
            `).join('');

            return { html, count: recs.length };
        }

        function generateQualityRecommendations(delayedOrders, aql, bottleneck, vendors) {
            const recs = [];

            // 1. AQL í•©ê²©ë¥  ê¶Œê³ 
            if (aql.passRate < 95) {
                recs.push({
                    priority: 'high',
                    icon: 'ğŸ”´',
                    text: `AQL í•©ê²©ë¥  ${aql.passRate.toFixed(1)}% (ëª©í‘œ 98%)`,
                    action: 'â†’ ë¶ˆëŸ‰ ì›ì¸ ê¸´ê¸‰ ë¶„ì„'
                });
            } else if (aql.passRate < 98) {
                recs.push({
                    priority: 'medium',
                    icon: 'âš ï¸',
                    text: `AQL í•©ê²©ë¥  ${aql.passRate.toFixed(1)}%`,
                    action: 'â†’ í’ˆì§ˆ ê°œì„  ì¡°ì¹˜ ê²€í† '
                });
            }

            // 2. í’ˆì§ˆ ìœ„í—˜ ì˜¤ë” (ì§€ì—° + AQL ë¶ˆí•©ê²©)
            const qualityRiskOrders = delayedOrders.filter(d => d.aql === false);
            if (qualityRiskOrders.length > 0) {
                recs.push({
                    priority: 'high',
                    icon: 'ğŸš¨',
                    text: `í’ˆì§ˆ ìœ„í—˜ ì˜¤ë” ${qualityRiskOrders.length}ê±´`,
                    action: 'â†’ ì§€ì—°+ë¶ˆí•©ê²© êµì§‘í•© ì§‘ì¤‘ ê´€ë¦¬'
                });
            }

            // 3. ë³‘ëª© ê³µì • í’ˆì§ˆ ë¦¬ìŠ¤í¬
            if (bottleneck.completionRate < 70) {
                recs.push({
                    priority: 'medium',
                    icon: 'âš¡',
                    text: `[${bottleneck.process}] í’ˆì§ˆ ë¦¬ìŠ¤í¬`,
                    action: 'â†’ ë‚©ê¸° ì••ë°•ìœ¼ë¡œ í’ˆì§ˆ íƒ€í˜‘ ì£¼ì˜'
                });
            }

            // 4. ì§€ì—° ì‹¬ê°ë„ë³„ í’ˆì§ˆ ê¶Œê³ 
            const severeDelays = delayedOrders.filter(d => {
                const today = new Date();
                const sdd = new Date(d.sdd);
                return (today - sdd) / (1000 * 60 * 60 * 24) > 7;
            });
            if (severeDelays.length > 0) {
                recs.push({
                    priority: 'medium',
                    icon: 'ğŸ“‹',
                    text: `7ì¼+ ì§€ì—° ${severeDelays.length}ê±´ í’ˆì§ˆ ê²€ìˆ˜ ê°•í™”`,
                    action: 'â†’ AQL ê²€ì‚¬ ìš°ì„  ì‹¤ì‹œ'
                });
            }

            // 5. ì €ì„±ê³¼ ë²¤ë” í’ˆì§ˆ ê¶Œê³ 
            const lowQualityVendors = vendors.filter(v => v.score < 50);
            if (lowQualityVendors.length > 0) {
                recs.push({
                    priority: 'medium',
                    icon: 'ğŸ­',
                    text: `ì €ì„±ê³¼ ë²¤ë” ${lowQualityVendors.length}ê°œ í’ˆì§ˆ ê°ì‚¬`,
                    action: 'â†’ ë‚©í’ˆ ê±´ AQL ê²€ì‚¬ ê°•í™”'
                });
            }

            // ê²°ê³¼ê°€ ì—†ìœ¼ë©´ ì–‘í˜¸ ë©”ì‹œì§€
            if (recs.length === 0) {
                recs.push({
                    priority: 'good',
                    icon: 'âœ…',
                    text: 'í’ˆì§ˆ ìƒíƒœ ì–‘í˜¸',
                    action: 'ì •ìƒ í’ˆì§ˆ ê´€ë¦¬ ìœ ì§€'
                });
            }

            const html = recs.map(r => `
                <div class="flex items-start gap-2 p-2 rounded ${
                    r.priority === 'high' ? 'bg-red-50 dark:bg-red-900/30' :
                    r.priority === 'medium' ? 'bg-yellow-50 dark:bg-yellow-900/30' :
                    'bg-green-50 dark:bg-green-900/30'
                }">
                    <span aria-hidden="true">${r.icon}</span>
                    <div>
                        <div class="font-medium ${
                            r.priority === 'high' ? 'text-red-700 dark:text-red-300' :
                            r.priority === 'medium' ? 'text-yellow-700 dark:text-yellow-300' :
                            'text-green-700 dark:text-green-300'
                        }">${escapeHtml(r.text)}</div>
                        <div class="text-xs text-gray-500 dark:text-gray-400">${escapeHtml(r.action)}</div>
                    </div>
                </div>
            `).join('');

            return { html, count: recs.length };
        }

        function calculateRiskScore(delayedOrders, severity, bottleneck, vendors, aql) {
            let score = 0;

            // ì§€ì—° ìœ„í—˜ (40ì  ë§Œì )
            const delayScore = Math.min(40, delayedOrders.length * 3 + severity.severe * 5);
            score += delayScore;

            // ë³‘ëª© ìœ„í—˜ (30ì  ë§Œì )
            const bottleneckScore = bottleneck.completionRate < 50 ? 30 :
                                    bottleneck.completionRate < 70 ? 20 :
                                    bottleneck.completionRate < 80 ? 10 : 0;
            score += bottleneckScore;

            // ë²¤ë” ìœ„í—˜ (20ì  ë§Œì )
            const lowVendors = vendors.filter(v => v.score < 60).length;
            const vendorScore = Math.min(20, lowVendors * 5);
            score += vendorScore;

            // í’ˆì§ˆ ìœ„í—˜ (10ì  ë§Œì )
            const qualityScore = aql.passRate >= 98 ? 0 :
                                 aql.passRate >= 95 ? 5 : 10;
            score += qualityScore;

            return {
                total: Math.min(100, score),
                breakdown: {
                    delay: delayScore,
                    bottleneck: bottleneckScore,
                    vendor: vendorScore,
                    quality: qualityScore
                }
            };
        }

        function updateRiskScoreDisplay(riskData) {
            const scoreEl = document.getElementById('riskScore');
            const levelEl = document.getElementById('riskLevel');
            const breakdownEl = document.getElementById('riskBreakdown');

            if (!scoreEl) return;

            scoreEl.textContent = riskData.total + 'ì ';

            let level, levelClass;
            if (riskData.total >= 70) {
                level = 'ìœ„í—˜';
                levelClass = 'bg-red-500 text-white';
                scoreEl.className = 'text-2xl font-bold text-red-600';
            } else if (riskData.total >= 40) {
                level = 'ì£¼ì˜';
                levelClass = 'bg-yellow-500 text-white';
                scoreEl.className = 'text-2xl font-bold text-yellow-600';
            } else {
                level = 'ì–‘í˜¸';
                levelClass = 'bg-green-500 text-white';
                scoreEl.className = 'text-2xl font-bold text-green-600';
            }

            levelEl.textContent = level;
            levelEl.className = `text-xs px-2 py-1 rounded ${levelClass}`;

            breakdownEl.textContent = `ì§€ì—°:${riskData.breakdown.delay} | ë³‘ëª©:${riskData.breakdown.bottleneck} | ë²¤ë”:${riskData.breakdown.vendor} | í’ˆì§ˆ:${riskData.breakdown.quality}`;
        }

        // ì§€ì—° ì‹¬ê°ë„ ë„ë„› ì°¨íŠ¸ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ + ë‹¤í¬ëª¨ë“œ ëŒ€ì‘)
        let delaySeverityChart = null;
        function updateDelaySeverityChart(severity) {
            const ctx = document.getElementById('delaySeverityChart');
            if (!ctx) return;

            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#fff' : '#333';

            const data = {
                labels: ['ê²½ë¯¸ (1-3ì¼)', 'ì£¼ì˜ (4-7ì¼)', 'ì‹¬ê° (7ì¼+)'],
                datasets: [{
                    data: [severity.minor, severity.moderate, severity.severe],
                    backgroundColor: ['#4ade80', '#fbbf24', '#ef4444'],
                    borderWidth: 0
                }]
            };

            const config = {
                type: 'doughnut',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: { color: textColor, font: { size: 10 } }
                        }
                    }
                }
            };

            if (delaySeverityChart) {
                delaySeverityChart.data = data;
                delaySeverityChart.options.plugins.legend.labels.color = textColor;
                delaySeverityChart.update();
            } else {
                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ destroy í›„ ìƒì„± (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
                if (ctx.chart) {
                    ctx.chart.destroy();
                }
                delaySeverityChart = new Chart(ctx, config);
                ctx.chart = delaySeverityChart;
            }
        }

        // ì§€ì—° ì›ì¸ ë§‰ëŒ€ ì°¨íŠ¸ (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€ + ë‹¤í¬ëª¨ë“œ ëŒ€ì‘)
        let rootCauseChart = null;
        function updateRootCauseChart(causes) {
            const ctx = document.getElementById('rootCauseChart');
            if (!ctx) return;

            const isDarkMode = document.documentElement.classList.contains('dark');
            const textColor = isDarkMode ? '#fff' : '#333';
            const gridColor = isDarkMode ? 'rgba(255,255,255,0.1)' : 'rgba(0,0,0,0.1)';

            const data = {
                labels: causes.map(c => c[0]),
                datasets: [{
                    label: 'ì§€ì—° ê±´ìˆ˜',
                    data: causes.map(c => c[1]),
                    backgroundColor: 'rgba(59, 130, 246, 0.8)',
                    borderRadius: 4
                }]
            };

            const config = {
                type: 'bar',
                data: data,
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    indexAxis: 'y',
                    plugins: {
                        legend: { display: false }
                    },
                    scales: {
                        x: { ticks: { color: textColor }, grid: { color: gridColor } },
                        y: { ticks: { color: textColor }, grid: { display: false } }
                    }
                }
            };

            if (rootCauseChart) {
                rootCauseChart.data = data;
                rootCauseChart.options.scales.x.ticks.color = textColor;
                rootCauseChart.options.scales.x.grid.color = gridColor;
                rootCauseChart.options.scales.y.ticks.color = textColor;
                rootCauseChart.update();
            } else {
                // ê¸°ì¡´ ì°¨íŠ¸ê°€ ìˆìœ¼ë©´ destroy í›„ ìƒì„± (ë©”ëª¨ë¦¬ ëˆ„ìˆ˜ ë°©ì§€)
                if (ctx.chart) {
                    ctx.chart.destroy();
                }
                rootCauseChart = new Chart(ctx, config);
                ctx.chart = rootCauseChart;
            }
        }

        // ë²¤ë” ì„±ê³¼ ë¦¬ìŠ¤íŠ¸ ì—…ë°ì´íŠ¸
        function updateVendorPerformanceList(vendors) {
            const container = document.getElementById('vendorPerformanceList');
            if (!container) return;

            let html = '';
            vendors.forEach((v, i) => {
                const medal = i === 0 ? 'ğŸ¥‡' : i === 1 ? 'ğŸ¥ˆ' : i === 2 ? 'ğŸ¥‰' : `${i + 1}.`;
                const scoreColor = parseFloat(v.score) >= 80 ? 'text-green-400' : parseFloat(v.score) >= 60 ? 'text-yellow-400' : 'text-red-400';
                html += `
                    <div class="flex items-center justify-between py-1 border-b border-white/10 last:border-0">
                        <span class="text-sm">${medal} ${escapeHtml(v.vendor)}</span>
                        <span class="font-bold ${scoreColor}">${v.score}ì </span>
                    </div>`;
            });
            container.innerHTML = html;
        }

        // ë„ì›€ë§ ëª¨ë‹¬ í† ê¸€
        function toggleHelpModal() {
            const modal = document.getElementById('helpModal');
            const helpBtn = document.getElementById('helpModalBtn');
            const insightsBtn = document.getElementById('insightsHelpBtn');
            const isHidden = modal.classList.contains('hidden');

            modal.classList.toggle('hidden');

            // aria-expanded ì—…ë°ì´íŠ¸
            helpBtn?.setAttribute('aria-expanded', isHidden.toString());
            insightsBtn?.setAttribute('aria-expanded', isHidden.toString());

            if (isHidden) {
                trapFocus(modal);
            }
        }

        // ì¸ì‚¬ì´íŠ¸ ë„ì›€ë§ (toggleHelpModalê³¼ ë™ì¼)
        function toggleInsightsHelp() {
            toggleHelpModal();
        }

        function closeHelpModal() {
            const helpBtn = document.getElementById('helpModalBtn');
            const insightsBtn = document.getElementById('insightsHelpBtn');

            document.getElementById('helpModal').classList.add('hidden');

            // aria-expanded ì—…ë°ì´íŠ¸
            helpBtn?.setAttribute('aria-expanded', 'false');
            insightsBtn?.setAttribute('aria-expanded', 'false');

            releaseFocus();
        }

        // ìƒì„¸ ëª¨ë‹¬ í•¨ìˆ˜ë“¤
        function showOTDDetail() {
            const otd = calculateOTDRate();
            const details = filteredData
                .filter(d => {
                    const whOutCompleted = d.production?.wh_out?.completed || 0;
                    return whOutCompleted >= (d.quantity || 0);
                })
                .filter(d => {
                    if (!d.sddValue || !d.crd) return false;
                    return new Date(d.sddValue) > new Date(d.crd);
                })
                .slice(0, 10);

            let html = `<h3 class="text-lg font-bold mb-4"><span aria-hidden="true">ğŸ“Š </span>OTD ìƒì„¸ ë¶„ì„</h3>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600">${otd.rate.toFixed(1)}%</div>
                        <div class="text-xs text-gray-500">ì •ì‹œ ë‚©ê¸°ìœ¨</div>
                    </div>
                    <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${otd.onTimeCount}</div>
                        <div class="text-xs text-gray-500">ì •ì‹œ ì™„ë£Œ</div>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">${otd.completedCount - otd.onTimeCount}</div>
                        <div class="text-xs text-gray-500">ì§€ì—° ì™„ë£Œ</div>
                    </div>
                </div>`;

            if (details.length > 0) {
                html += `<h4 class="font-semibold mb-2">ì§€ì—° ì™„ë£Œ ì˜¤ë” (ìµœê·¼ 10ê±´)</h4>
                    <div class="max-h-60 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                                <th scope="col" class="px-2 py-1 text-left">PO</th>
                                <th scope="col" class="px-2 py-1">CRD</th>
                                <th scope="col" class="px-2 py-1">SDD</th>
                                <th scope="col" class="px-2 py-1">ì§€ì—°ì¼</th>
                            </tr></thead>
                            <tbody>`;
                details.forEach(d => {
                    const diffDays = Math.floor((new Date(d.sddValue) - new Date(d.crd)) / (1000*60*60*24));
                    html += `<tr class="border-b"><td class="px-2 py-1">${escapeHtml(d.poNumber)}</td>
                        <td class="px-2 py-1 text-center">${d.crd}</td>
                        <td class="px-2 py-1 text-center">${d.sddValue}</td>
                        <td class="px-2 py-1 text-center text-red-600">+${diffDays}ì¼</td></tr>`;
                });
                html += '</tbody></table></div>';
            }

            showInfoModal('OTD ìƒì„¸', html);
        }

        function showRevenueRiskDetail() {
            const revenue = calculateRevenueAtRisk();
            const details = filteredData
                .filter(d => d.isDelayed)
                .map(d => {
                    const remaining = Math.max(0, (d.quantity || 0) - (d.production?.wh_out?.completed || 0));
                    return { ...d, remaining, risk: remaining * UNIT_PRICE };
                })
                .sort((a, b) => b.risk - a.risk)
                .slice(0, 10);

            let html = `<h3 class="text-lg font-bold mb-4"><span aria-hidden="true">ğŸ’° </span>ìœ„í—˜ ë§¤ì¶œì•¡ ìƒì„¸</h3>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-red-50 dark:bg-red-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">$${formatNumber(revenue.revenue)}</div>
                        <div class="text-xs text-gray-500">ì´ ìœ„í—˜ ë§¤ì¶œ</div>
                    </div>
                    <div class="bg-yellow-50 dark:bg-yellow-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-yellow-600">${formatNumber(revenue.quantity)}</div>
                        <div class="text-xs text-gray-500">ì§€ì—° ìˆ˜ëŸ‰ (ì¡±)</div>
                    </div>
                    <div class="bg-gray-50 dark:bg-gray-700 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold">${revenue.orders}</div>
                        <div class="text-xs text-gray-500">ì§€ì—° ì˜¤ë” ìˆ˜</div>
                    </div>
                </div>`;

            if (details.length > 0) {
                html += `<h4 class="font-semibold mb-2">ê³ ìœ„í—˜ ì˜¤ë” TOP 10</h4>
                    <div class="max-h-60 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                                <th scope="col" class="px-2 py-1 text-left">PO</th>
                                <th scope="col" class="px-2 py-1">ì”ëŸ‰</th>
                                <th scope="col" class="px-2 py-1">ìœ„í—˜ì•¡</th>
                            </tr></thead>
                            <tbody>`;
                details.forEach(d => {
                    html += `<tr class="border-b"><td class="px-2 py-1">${escapeHtml(d.poNumber)}</td>
                        <td class="px-2 py-1 text-right">${formatNumber(d.remaining)}ì¡±</td>
                        <td class="px-2 py-1 text-right text-red-600">$${formatNumber(d.risk)}</td></tr>`;
                });
                html += '</tbody></table></div>';
            }

            showInfoModal('ìœ„í—˜ ë§¤ì¶œì•¡ ìƒì„¸', html);
        }

        function showAQLDetail() {
            const aql = calculateAQLStats();
            const failed = filteredData.filter(d => d.aql === false || d.aql === 'false' || d.aql === 'N').slice(0, 10);

            let html = `<h3 class="text-lg font-bold mb-4"><span aria-hidden="true">âœ… </span>AQL í’ˆì§ˆ ê²€ì‚¬ ìƒì„¸</h3>
                <div class="grid grid-cols-3 gap-4 mb-4">
                    <div class="bg-green-50 dark:bg-green-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-green-600">${aql.rate.toFixed(1)}%</div>
                        <div class="text-xs text-gray-500">í•©ê²©ë¥ </div>
                    </div>
                    <div class="bg-blue-50 dark:bg-blue-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-blue-600">${aql.passedCount}</div>
                        <div class="text-xs text-gray-500">í•©ê²©</div>
                    </div>
                    <div class="bg-red-50 dark:bg-red-900 p-3 rounded-lg text-center">
                        <div class="text-2xl font-bold text-red-600">${aql.inspectedCount - aql.passedCount}</div>
                        <div class="text-xs text-gray-500">ë¶ˆí•©ê²©</div>
                    </div>
                </div>`;

            if (failed.length > 0) {
                html += `<h4 class="font-semibold mb-2">ë¶ˆí•©ê²© ì˜¤ë”</h4>
                    <div class="max-h-60 overflow-y-auto">
                        <table class="w-full text-sm">
                            <thead class="bg-gray-50 dark:bg-gray-700"><tr>
                                <th scope="col" class="px-2 py-1 text-left">PO</th>
                                <th scope="col" class="px-2 py-1">ëª¨ë¸</th>
                                <th scope="col" class="px-2 py-1">ê³µì¥</th>
                            </tr></thead>
                            <tbody>`;
                failed.forEach(d => {
                    html += `<tr class="border-b"><td class="px-2 py-1">${escapeHtml(d.poNumber)}</td>
                        <td class="px-2 py-1">${escapeHtml(d.model)}</td>
                        <td class="px-2 py-1 text-center">${escapeHtml(d.factory)}</td></tr>`;
                });
                html += '</tbody></table></div>';
            }

            showInfoModal('AQL ìƒì„¸', html);
        }

        function showBottleneckDetail() {
            const bottleneck = predictBottleneck();
            const processStats = {};

            PROCESS_ORDER.forEach(key => {
                processStats[key] = { completed: 0, pending: 0 };
            });

            filteredData.forEach(d => {
                PROCESS_ORDER.forEach(key => {
                    const p = d.production?.[key];
                    processStats[key].completed += p?.completed || 0;
                    processStats[key].pending += p?.pending || 0;
                });
            });

            let html = `<h3 class="text-lg font-bold mb-4"><span aria-hidden="true">âš ï¸ </span>ë³‘ëª© ê³µì • ë¶„ì„</h3>
                <div class="bg-yellow-50 dark:bg-yellow-900 p-4 rounded-lg mb-4">
                    <div class="text-center">
                        <div class="text-3xl font-bold text-yellow-600">${bottleneck.process}</div>
                        <div class="text-sm text-gray-500 mt-1">í˜„ì¬ ë³‘ëª© ê³µì •</div>
                        <div class="text-lg mt-2">ì™„ë£Œìœ¨ <span class="font-bold text-red-600">${bottleneck.rate}%</span> | ì”ëŸ‰ <span class="font-bold">${formatNumber(bottleneck.affectedQty)}ì¡±</span></div>
                    </div>
                </div>
                <h4 class="font-semibold mb-2">ê³µì •ë³„ í˜„í™©</h4>
                <div class="space-y-2">`;

            PROCESS_ORDER.forEach(key => {
                const stats = processStats[key];
                const total = stats.completed + stats.pending;
                const rate = total > 0 ? (stats.completed / total * 100) : 100;
                const isBottleneck = PROCESS_NAMES[key] === bottleneck.process;

                html += `<div class="flex items-center gap-2 ${isBottleneck ? 'bg-yellow-100 dark:bg-yellow-900 p-2 rounded' : ''}">
                    <span class="w-20 text-sm font-medium">${PROCESS_NAMES[key]}</span>
                    <div class="flex-1 bg-gray-200 dark:bg-gray-700 rounded-full h-4">
                        <div class="h-4 rounded-full ${rate >= 80 ? 'bg-green-500' : rate >= 50 ? 'bg-yellow-500' : 'bg-red-500'}" style="width: ${rate}%"></div>
                    </div>
                    <span class="w-16 text-right text-sm font-bold ${rate >= 80 ? 'text-green-600' : rate >= 50 ? 'text-yellow-600' : 'text-red-600'}">${rate.toFixed(1)}%</span>
                </div>`;
            });

            html += '</div>';
            showInfoModal('ë³‘ëª© ê³µì • ìƒì„¸', html);
        }

        // ë²”ìš© ì •ë³´ ëª¨ë‹¬
        function showInfoModal(title, content) {
            let modal = document.getElementById('infoModal');
            if (!modal) {
                modal = document.createElement('div');
                modal.id = 'infoModal';
                modal.className = 'fixed inset-0 modal-overlay z-50 flex items-center justify-center p-4';
                modal.innerHTML = `
                    <div class="bg-card rounded-xl shadow-2xl max-w-2xl w-full max-h-[80vh] overflow-hidden">
                        <div class="p-4 border-b border-theme flex justify-between items-center">
                            <h3 id="infoModalTitle" class="font-bold text-lg"></h3>
                            <button type="button" onclick="closeInfoModal()" class="p-2 hover:bg-gray-100 dark:hover:bg-gray-700 rounded-lg" aria-label="ì •ë³´ ëª¨ë‹¬ ë‹«ê¸°">âœ•</button>
                        </div>
                        <div id="infoModalContent" class="p-4 overflow-y-auto max-h-[60vh]"></div>
                    </div>`;
                document.body.appendChild(modal);
            }
            document.getElementById('infoModalTitle').textContent = title;
            document.getElementById('infoModalContent').innerHTML = content;
            modal.classList.remove('hidden');
            trapFocus(modal);
        }

        function closeInfoModal() {
            const modal = document.getElementById('infoModal');
            if (modal) {
                modal.classList.add('hidden');
                releaseFocus();
            }
        }
    </script>
    </div><!-- End main-content -->
</body>
</html>
