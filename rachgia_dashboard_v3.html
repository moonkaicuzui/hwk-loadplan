<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Rachgia Factory í†µí•© ìƒì‚°ê´€ë¦¬ ëŒ€ì‹œë³´ë“œ v3</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .tab-active { border-bottom: 3px solid #3b82f6; color: #3b82f6; font-weight: 600; }
        .card-hover { transition: all 0.2s ease; }
        .card-hover:hover { transform: translateY(-2px); box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .asia-highlight { background: linear-gradient(135deg, #fef3c7 0%, #fde68a 100%); }
        .vendor-highlight { background: linear-gradient(135deg, #dbeafe 0%, #bfdbfe 100%); }
        .delay-highlight { background: linear-gradient(135deg, #fee2e2 0%, #fecaca 100%); animation: pulse-red 2s infinite; }
        @keyframes pulse-red { 0%, 100% { opacity: 1; } 50% { opacity: 0.8; } }
        table th { position: sticky; top: 0; background: #f8fafc; z-index: 10; }
        .clickable-row { cursor: pointer; }
        .clickable-row:hover { background-color: #f0f9ff !important; }
        .modal-overlay { background: rgba(0,0,0,0.5); }
        .progress-bar { height: 24px; border-radius: 12px; background: #e5e7eb; overflow: hidden; cursor: pointer; transition: transform 0.2s; }
        .progress-bar:hover { transform: scaleY(1.1); }
        .progress-fill { height: 100%; border-radius: 12px; transition: width 0.5s ease; }
        .filter-chip { display: inline-flex; align-items: center; padding: 4px 12px; border-radius: 9999px; font-size: 0.875rem; margin: 2px; cursor: pointer; transition: all 0.2s; }
        .filter-chip.active { background-color: #3b82f6; color: white; }
        .filter-chip:not(.active) { background-color: #e5e7eb; color: #374151; }
        .filter-chip:not(.active):hover { background-color: #d1d5db; }
        .filter-badge { display: inline-flex; align-items: center; padding: 2px 8px; border-radius: 9999px; font-size: 0.75rem; background: #dbeafe; color: #1e40af; margin: 2px; }
        .filter-badge button { margin-left: 4px; font-weight: bold; }
        .chart-container { position: relative; height: 300px; }
        .sort-header { cursor: pointer; user-select: none; }
        .sort-header:hover { background: #e2e8f0; }
        .sort-icon { margin-left: 4px; opacity: 0.5; }
        .sort-icon.active { opacity: 1; }
        .funnel-step { position: relative; text-align: center; padding: 8px; margin: 2px; border-radius: 4px; transition: all 0.2s; cursor: pointer; }
        .funnel-step:hover { transform: scale(1.02); }
        .tooltip { position: absolute; background: #1f2937; color: white; padding: 8px 12px; border-radius: 6px; font-size: 12px; z-index: 100; pointer-events: none; white-space: nowrap; }
        .loading-spinner { border: 3px solid #f3f4f6; border-top: 3px solid #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .inventory-card { border-left: 4px solid; }
        @media (max-width: 768px) { .chart-container { height: 250px; } }
        @media print {
            .no-print { display: none !important; }
            body { font-size: 12px; }
        }
    </style>
</head>
<body class="bg-gray-50 min-h-screen">
    <!-- Loading Overlay -->
    <div id="loadingOverlay" class="fixed inset-0 bg-white bg-opacity-90 z-50 flex items-center justify-center">
        <div class="text-center">
            <div class="loading-spinner mx-auto mb-4"></div>
            <p class="text-gray-600">ë°ì´í„° ë¡œë”© ì¤‘...</p>
        </div>
    </div>

    <header class="bg-gradient-to-r from-blue-600 to-indigo-700 text-white shadow-lg no-print">
        <div class="max-w-[2000px] mx-auto px-4 py-4">
            <div class="flex items-center justify-between flex-wrap gap-2">
                <div>
                    <h1 class="text-2xl font-bold">ğŸ­ Rachgia Factory í†µí•© ìƒì‚°ê´€ë¦¬</h1>
                    <p class="text-blue-100 text-sm mt-1">Factory A, B, C, D ìƒì‚° í˜„í™© ëª¨ë‹ˆí„°ë§</p>
                </div>
                <div class="flex items-center gap-4">
                    <div id="delayAlert" class="hidden bg-red-500 text-white px-4 py-2 rounded-lg animate-pulse cursor-pointer" onclick="showDelayedOrders()">
                        âš ï¸ ì§€ì—° ì˜¤ë”: <span id="delayCount">0</span>ê±´
                    </div>
                    <div class="text-right">
                        <div class="text-sm text-blue-100">ë°ì´í„° ê¸°ì¤€ì¼</div>
                        <div class="font-semibold">2025ë…„ 12ì›” 20ì¼</div>
                    </div>
                </div>
            </div>
        </div>
    </header>

    <div class="max-w-[2000px] mx-auto px-4 py-6">
        <!-- Alert Cards (NEW) -->
        <div id="alertSection" class="hidden mb-6">
            <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                <div class="delay-highlight rounded-xl shadow-sm p-4 cursor-pointer" onclick="showDelayedOrders()">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ğŸš¨</span>
                        <div>
                            <div class="text-red-700 text-sm font-medium">ì§€ì—° ì˜¤ë”</div>
                            <div class="text-2xl font-bold text-red-800" id="delayedOrderCount">0ê±´</div>
                            <div class="text-xs text-red-600" id="delayedOrderQty">0ì¡±</div>
                        </div>
                    </div>
                </div>
                <div class="bg-amber-50 border-l-4 border-amber-400 rounded-xl shadow-sm p-4 cursor-pointer" onclick="showTodayOrders()">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ğŸ“…</span>
                        <div>
                            <div class="text-amber-700 text-sm font-medium">ì˜¤ëŠ˜ ì¶œê³  ì˜ˆì •</div>
                            <div class="text-2xl font-bold text-amber-800" id="todayOrderCount">0ê±´</div>
                            <div class="text-xs text-amber-600" id="todayOrderQty">0ì¡±</div>
                        </div>
                    </div>
                </div>
                <div class="bg-blue-50 border-l-4 border-blue-400 rounded-xl shadow-sm p-4 cursor-pointer" onclick="showInventoryOrders()">
                    <div class="flex items-center gap-3">
                        <span class="text-3xl">ğŸ“¦</span>
                        <div>
                            <div class="text-blue-700 text-sm font-medium">ì°½ê³  ì¬ê³  (ì…ê³ -ì¶œê³ )</div>
                            <div class="text-2xl font-bold text-blue-800" id="inventoryCount">0ì¡±</div>
                            <div class="text-xs text-blue-600" id="inventoryOrders">0ê±´</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Summary Cards -->
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
            <div class="bg-white rounded-xl shadow-sm p-4 card-hover border-l-4 border-blue-500">
                <div class="text-gray-500 text-sm">ì´ ì˜¤ë” ê±´ìˆ˜</div>
                <div class="text-2xl font-bold text-gray-800" id="totalOrders">-</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 card-hover border-l-4 border-indigo-500">
                <div class="text-gray-500 text-sm">ì´ ì£¼ë¬¸ ìˆ˜ëŸ‰</div>
                <div class="text-2xl font-bold text-gray-800" id="totalQty">-</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 card-hover border-l-4 border-green-500">
                <div class="text-gray-500 text-sm">ìµœì¢… ì¶œê³  ì™„ë£Œ</div>
                <div class="text-2xl font-bold text-green-600" id="totalCompleted">-</div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-4 card-hover border-l-4 border-purple-500">
                <div class="flex justify-between items-center">
                    <div>
                        <div class="text-gray-500 text-sm">ì „ì²´ ì™„ë£Œìœ¨</div>
                        <div class="text-2xl font-bold text-purple-600" id="totalRate">-</div>
                    </div>
                    <div class="w-16 h-16"><canvas id="rateDonut"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Main Content Grid -->
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-6">
            <!-- Production Flow Funnel (NEW) -->
            <div class="lg:col-span-2 bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4">âš™ï¸ ê³µì •ë³„ ìƒì‚° í˜„í™© <span class="text-sm font-normal text-gray-500">(í´ë¦­í•˜ì—¬ ìƒì„¸ ë³´ê¸°)</span></h3>
                <div id="funnelChart" class="grid grid-cols-8 gap-1 mb-4"></div>
                <div id="processProgress" class="space-y-3"></div>
            </div>
            <div class="bg-white rounded-xl shadow-sm p-6">
                <h3 class="text-lg font-semibold mb-4">ğŸ­ ê³µì¥ë³„ ì¶œê³  ì™„ë£Œìœ¨</h3>
                <div id="factoryCards" class="space-y-3"></div>
                <!-- Radar Chart (NEW) -->
                <div class="mt-4 pt-4 border-t">
                    <h4 class="text-sm font-medium text-gray-600 mb-2">ê³µì¥ ë¹„êµ</h4>
                    <div style="height: 200px;"><canvas id="factoryRadar"></canvas></div>
                </div>
            </div>
        </div>

        <!-- Outsole Vendor Section -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ‘Ÿ Outsole Vendorë³„ í˜„í™©</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div><div class="chart-container"><canvas id="vendorChart"></canvas></div></div>
                <div>
                    <div class="overflow-x-auto max-h-[300px]">
                        <table class="w-full text-sm" id="vendorTable">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="px-3 py-2 text-left sort-header" data-sort="vendor">Vendor <span class="sort-icon">â†•</span></th>
                                    <th class="px-3 py-2 text-right sort-header" data-sort="count">ì˜¤ë” <span class="sort-icon">â†•</span></th>
                                    <th class="px-3 py-2 text-right">ì˜¤ë”%</th>
                                    <th class="px-3 py-2 text-right sort-header" data-sort="qty">ìˆ˜ëŸ‰ <span class="sort-icon">â†•</span></th>
                                    <th class="px-3 py-2 text-right">ìˆ˜ëŸ‰%</th>
                                </tr>
                            </thead>
                            <tbody id="vendorTableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- Vendor Ã— Month Heatmap -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ“Š Outsole Vendor Ã— SDD ì›”ë³„ ìˆ˜ëŸ‰</h3>
            <div id="vendorMonthHeatmap" class="overflow-x-auto"></div>
        </div>

        <!-- CRD-SDD Comparison -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ“Š ì›”ë³„ CRD vs SDD ë¹„êµ</h3>
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                <div><div class="chart-container"><canvas id="crdSddChart"></canvas></div></div>
                <div class="overflow-x-auto">
                    <table class="w-full text-sm" id="crdSddTable">
                        <thead class="bg-gray-50">
                            <tr><th class="px-3 py-2 text-left">ì›”</th><th class="px-3 py-2 text-right">CRD ìˆ˜ëŸ‰</th><th class="px-3 py-2 text-right">SDD ìˆ˜ëŸ‰</th><th class="px-3 py-2 text-right">ì°¨ì´</th><th class="px-3 py-2 text-center">ìƒíƒœ</th></tr>
                        </thead>
                        <tbody id="crdSddTableBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- Important Destinations -->
        <div class="bg-white rounded-xl shadow-sm p-6 mb-6">
            <h3 class="text-lg font-semibold mb-4">ğŸ¯ ì¤‘ìš” í–‰ì„ ì§€</h3>
            <div class="grid grid-cols-2 md:grid-cols-5 gap-4" id="asiaCards"></div>
        </div>

        <!-- Filters with Reset and Badges (IMPROVED) -->
        <div class="bg-white rounded-xl shadow-sm p-4 mb-6 no-print">
            <div class="flex justify-between items-center mb-3">
                <h4 class="font-medium text-gray-700">ğŸ” í•„í„°</h4>
                <button onclick="resetAllFilters()" class="text-sm bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded-lg transition">
                    â†º í•„í„° ì´ˆê¸°í™”
                </button>
            </div>
            <div id="activeFilters" class="mb-3 hidden">
                <span class="text-xs text-gray-500">ì ìš©ëœ í•„í„°:</span>
                <div id="filterBadges" class="inline-flex flex-wrap gap-1 ml-2"></div>
            </div>
            <div class="flex flex-wrap items-center gap-4">
                <div class="flex-1 min-w-[120px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì›” (SDD)</label>
                    <select id="monthFilter" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"><option value="">ì „ì²´</option></select>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ë¹ ë¥¸ ì„ íƒ</label>
                    <select id="quickDateFilter" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´ ê¸°ê°„</option>
                        <option value="today">ì˜¤ëŠ˜</option>
                        <option value="week">ì´ë²ˆ ì£¼</option>
                        <option value="month">ì´ë²ˆ ë‹¬</option>
                        <option value="delayed">ì§€ì—°ë§Œ</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">í–‰ì„ ì§€</label>
                    <select id="destFilter" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´</option>
                        <option value="asia">ì¤‘ìš” í–‰ì„ ì§€ë§Œ</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">Vendor</label>
                    <select id="vendorFilter" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500"><option value="">ì „ì²´</option></select>
                </div>
                <div class="flex-1 min-w-[120px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ì™„ë£Œ ìƒíƒœ</label>
                    <select id="statusFilter" class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                        <option value="">ì „ì²´</option>
                        <option value="completed">ì¶œê³  ì™„ë£Œ</option>
                        <option value="partial">ì§„í–‰ ì¤‘</option>
                        <option value="pending">ë¯¸ì‹œì‘</option>
                    </select>
                </div>
                <div class="flex-1 min-w-[180px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">ê³µì¥</label>
                    <div id="factoryFilter" class="flex flex-wrap gap-1">
                        <span class="filter-chip active" data-factory="">ì „ì²´</span>
                        <span class="filter-chip" data-factory="A">A</span>
                        <span class="filter-chip" data-factory="B">B</span>
                        <span class="filter-chip" data-factory="C">C</span>
                        <span class="filter-chip" data-factory="D">D</span>
                    </div>
                </div>
                <div class="flex-1 min-w-[200px]">
                    <label class="block text-sm font-medium text-gray-700 mb-1">í†µí•© ê²€ìƒ‰</label>
                    <input type="text" id="searchInput" placeholder="ëª¨ë¸, PO, í–‰ì„ ì§€, ë²¤ë”..." class="w-full border rounded-lg px-3 py-2 focus:ring-2 focus:ring-blue-500">
                </div>
            </div>
        </div>

        <!-- Tabs -->
        <div class="bg-white rounded-xl shadow-sm mb-6">
            <div class="border-b overflow-x-auto">
                <nav class="flex -mb-px min-w-max">
                    <button class="tab-btn tab-active px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="monthly">ğŸ“… ì›”ë³„</button>
                    <button class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="destination">ğŸŒ í–‰ì„ ì§€ë³„</button>
                    <button class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="model">ğŸ‘Ÿ ëª¨ë¸ë³„</button>
                    <button class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="factory">ğŸ­ ê³µì¥ë³„</button>
                    <button class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="vendor">ğŸ“¦ ë²¤ë”ë³„</button>
                    <button class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="heatmap">ğŸ”¥ íˆíŠ¸ë§µ</button>
                    <button class="tab-btn px-6 py-3 text-sm font-medium whitespace-nowrap" data-tab="data">ğŸ“‹ ìƒì„¸</button>
                </nav>
            </div>
            <div id="tabContents" class="p-6">
                <div id="monthlyTab" class="tab-content">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">ì›”ë³„ ì˜¤ë” í˜„í™©</h3><div class="chart-container"><canvas id="monthlyChart"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ì›”ë³„ ì™„ë£Œ í˜„í™©</h3><div class="overflow-x-auto"><table class="w-full text-sm" id="monthlyTable"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left sort-header" data-sort="month">ì›” <span class="sort-icon">â†•</span></th><th class="px-4 py-2 text-right sort-header" data-sort="count">ì˜¤ë” <span class="sort-icon">â†•</span></th><th class="px-4 py-2 text-right sort-header" data-sort="qty">ì£¼ë¬¸ëŸ‰ <span class="sort-icon">â†•</span></th><th class="px-4 py-2 text-right sort-header" data-sort="completed">ì™„ë£ŒëŸ‰ <span class="sort-icon">â†•</span></th><th class="px-4 py-2 text-right sort-header" data-sort="rate">ì™„ë£Œìœ¨ <span class="sort-icon">â†•</span></th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>
                <div id="destinationTab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">êµ­ê°€ë³„ ìˆ˜ëŸ‰ ë¶„í¬</h3><div class="chart-container"><canvas id="destChart"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">í–‰ì„ ì§€ë³„ ìƒì„¸</h3><div class="overflow-x-auto max-h-[400px]"><table class="w-full text-sm" id="destTable"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left sort-header">êµ­ê°€</th><th class="px-4 py-2 text-right sort-header">ê±´ìˆ˜</th><th class="px-4 py-2 text-right sort-header">ìˆ˜ëŸ‰</th><th class="px-4 py-2 text-right sort-header">ì™„ë£Œ</th><th class="px-4 py-2 text-right sort-header">ì™„ë£Œìœ¨</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>
                <div id="modelTab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">ëª¨ë¸ë³„ ìˆ˜ëŸ‰ (Top 15)</h3><div class="chart-container" style="height:400px"><canvas id="modelChart"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ëª¨ë¸ë³„ ìƒì„¸</h3><div class="overflow-x-auto max-h-[400px]"><table class="w-full text-sm" id="modelTable"><thead class="bg-gray-50"><tr><th class="px-4 py-2 text-left">ëª¨ë¸</th><th class="px-4 py-2 text-right">ê±´ìˆ˜</th><th class="px-4 py-2 text-right">ìˆ˜ëŸ‰</th><th class="px-4 py-2 text-right">ì™„ë£Œ</th><th class="px-4 py-2 text-right">ì™„ë£Œìœ¨</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>
                <div id="factoryTab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">ê³µì¥ë³„ ìˆ˜ëŸ‰ ë¹„êµ</h3><div class="chart-container"><canvas id="factoryChart"></canvas></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ê³µì¥ë³„ ê³µì • í˜„í™©</h3><div id="factoryProcessDetail" class="space-y-4"></div></div>
                    </div>
                </div>
                <div id="vendorTab" class="tab-content hidden">
                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                        <div><h3 class="text-lg font-semibold mb-4">Vendor Ã— ê³µì¥ ë¶„í¬</h3><div id="vendorFactoryMatrix" class="overflow-x-auto"></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">Vendorë³„ ì™„ë£Œ í˜„í™©</h3><div class="overflow-x-auto max-h-[400px]"><table class="w-full text-sm" id="vendorDetailTable"><thead class="bg-gray-50"><tr><th class="px-3 py-2 text-left">Vendor</th><th class="px-3 py-2 text-right">ì˜¤ë”</th><th class="px-3 py-2 text-right">ìˆ˜ëŸ‰</th><th class="px-3 py-2 text-right">ì™„ë£Œ</th><th class="px-3 py-2 text-right">ì™„ë£Œìœ¨</th></tr></thead><tbody></tbody></table></div></div>
                    </div>
                </div>
                <div id="heatmapTab" class="tab-content hidden">
                    <div class="space-y-6">
                        <div><h3 class="text-lg font-semibold mb-4">ì¤‘ìš” í–‰ì„ ì§€ Ã— SDDì›” íˆíŠ¸ë§µ</h3><div id="countryMonthHeatmap" class="overflow-x-auto"></div></div>
                        <div><h3 class="text-lg font-semibold mb-4">ëª¨ë¸ Ã— í–‰ì„ ì§€ íˆíŠ¸ë§µ</h3><div id="modelDestHeatmap" class="overflow-x-auto"></div></div>
                    </div>
                </div>
                <div id="dataTab" class="tab-content hidden">
                    <div class="flex justify-between items-center mb-4 flex-wrap gap-2">
                        <div>
                            <h3 class="text-lg font-semibold">ìƒì„¸ ë°ì´í„° <span id="dataCount" class="text-sm font-normal text-gray-500"></span></h3>
                            <div id="pagination" class="text-sm text-gray-500 mt-1"></div>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="prevPage()" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm" id="prevBtn" disabled>â† ì´ì „</button>
                            <button onclick="nextPage()" class="bg-gray-100 hover:bg-gray-200 px-3 py-1 rounded text-sm" id="nextBtn">ë‹¤ìŒ â†’</button>
                            <button onclick="exportToExcel()" class="bg-green-500 text-white px-4 py-2 rounded-lg hover:bg-green-600 text-sm font-medium">ğŸ“¥ Excel</button>
                        </div>
                    </div>
                    <div class="overflow-x-auto">
                        <table class="w-full text-sm" id="dataTable">
                            <thead class="bg-gray-50"><tr>
                                <th class="px-2 py-2 text-left sort-header" data-sort="factory">ê³µì¥</th>
                                <th class="px-2 py-2 text-left sort-header" data-sort="model">ëª¨ë¸</th>
                                <th class="px-2 py-2 text-left sort-header" data-sort="destination">í–‰ì„ ì§€</th>
                                <th class="px-2 py-2 text-left">Vendor</th>
                                <th class="px-2 py-2 text-right sort-header" data-sort="quantity">ìˆ˜ëŸ‰</th>
                                <th class="px-2 py-2 text-center">ì¬ë‹¨</th>
                                <th class="px-2 py-2 text-center">ì¬ë´‰</th>
                                <th class="px-2 py-2 text-center">ì¡°ë¦½</th>
                                <th class="px-2 py-2 text-center">ì¶œê³ </th>
                                <th class="px-2 py-2 text-left sort-header" data-sort="sdd">SDD</th>
                                <th class="px-2 py-2 text-center">ìƒíƒœ</th>
                            </tr></thead>
                            <tbody></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal -->
    <div id="orderDetailModal" class="fixed inset-0 modal-overlay z-50 hidden flex items-center justify-center p-4">
        <div class="bg-white rounded-xl shadow-2xl max-w-4xl w-full max-h-[90vh] overflow-y-auto">
            <div class="sticky top-0 bg-white border-b p-4 flex justify-between items-center">
                <h3 class="text-lg font-semibold" id="modalTitle">ìƒì„¸ ì •ë³´</h3>
                <button onclick="closeOrderModal()" class="text-gray-500 hover:text-gray-700 text-2xl">&times;</button>
            </div>
            <div class="p-6" id="modalContent"></div>
        </div>
    </div>

    <script>
        // Load data from external file
        let allData = [];
        let filteredData = [];
        let charts = {};
        let currentPage = 1;
        const pageSize = 50;
        let sortState = { column: null, direction: 'asc' };

        const PROCESS_NAMES = { s_cut: 'ì¬ë‹¨', pre_sew: 'ì¬ë´‰ì „', sew_input: 'ì¬ë´‰íˆ¬ì…', sew_bal: 'ì¬ë´‰', s_fit: 'ìƒ˜í”Œí•', ass_bal: 'ì¡°ë¦½', wh_in: 'ì°½ê³ ì…ê³ ', wh_out: 'ì°½ê³ ì¶œê³ ' };
        const PROCESS_ORDER = ['s_cut', 'pre_sew', 'sew_input', 'sew_bal', 's_fit', 'ass_bal', 'wh_in', 'wh_out'];
        const IMPORTANT_DESTINATIONS = { 'Japan': 'ğŸ‡¯ğŸ‡µ', 'South Korea': 'ğŸ‡°ğŸ‡·', 'Korea': 'ğŸ‡°ğŸ‡·', 'China': 'ğŸ‡¨ğŸ‡³', 'Taiwan': 'ğŸ‡¹ğŸ‡¼', 'India': 'ğŸ‡®ğŸ‡³' };
        const TODAY = new Date('2025-12-20');

        // Load data
        fetch('dashboard_data.json')
            .then(r => r.json())
            .then(data => {
                allData = data;
                filteredData = [...allData];
                initApp();
            })
            .catch(e => {
                console.error('Failed to load data:', e);
                document.getElementById('loadingOverlay').innerHTML = '<div class="text-red-500">ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨</div>';
            });

        function initApp() {
            initFilters();
            initTabs();
            initFactoryFilter();
            initSortHeaders();
            applyFilters();
            document.getElementById('loadingOverlay').classList.add('hidden');
        }

        function initFilters() {
            const months = [...new Set(allData.map(d => d.sddYearMonth).filter(Boolean))].sort();
            const monthSelect = document.getElementById('monthFilter');
            months.forEach(m => { const opt = document.createElement('option'); opt.value = m; opt.textContent = m; monthSelect.appendChild(opt); });

            const vendors = [...new Set(allData.map(d => d.outsoleVendor).filter(Boolean))].sort();
            const vendorSelect = document.getElementById('vendorFilter');
            vendors.forEach(v => { const opt = document.createElement('option'); opt.value = v; opt.textContent = v; vendorSelect.appendChild(opt); });

            const destinations = [...new Set(allData.map(d => d.destination).filter(Boolean))].sort();
            const destSelect = document.getElementById('destFilter');
            destinations.forEach(d => { const opt = document.createElement('option'); opt.value = d; opt.textContent = d; destSelect.appendChild(opt); });

            const debouncedFilter = debounce(() => applyFilters(), 300);
            ['monthFilter', 'destFilter', 'vendorFilter', 'statusFilter', 'quickDateFilter'].forEach(id => {
                document.getElementById(id).addEventListener('change', applyFilters);
            });
            document.getElementById('searchInput').addEventListener('input', debouncedFilter);
        }

        function initTabs() {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('tab-active'));
                    btn.classList.add('tab-active');
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.add('hidden'));
                    document.getElementById(btn.dataset.tab + 'Tab').classList.remove('hidden');
                    updateTabs();
                });
            });
        }

        function initFactoryFilter() {
            document.querySelectorAll('#factoryFilter .filter-chip').forEach(chip => {
                chip.addEventListener('click', () => {
                    document.querySelectorAll('#factoryFilter .filter-chip').forEach(c => c.classList.remove('active'));
                    chip.classList.add('active');
                    applyFilters();
                });
            });
        }

        function initSortHeaders() {
            document.querySelectorAll('.sort-header').forEach(header => {
                header.addEventListener('click', () => {
                    const column = header.dataset.sort;
                    if (sortState.column === column) {
                        sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
                    } else {
                        sortState.column = column;
                        sortState.direction = 'asc';
                    }
                    updateDataTab();
                });
            });
        }

        function resetAllFilters() {
            document.getElementById('monthFilter').value = '';
            document.getElementById('destFilter').value = '';
            document.getElementById('vendorFilter').value = '';
            document.getElementById('statusFilter').value = '';
            document.getElementById('quickDateFilter').value = '';
            document.getElementById('searchInput').value = '';
            document.querySelectorAll('#factoryFilter .filter-chip').forEach(c => c.classList.remove('active'));
            document.querySelector('#factoryFilter .filter-chip[data-factory=""]').classList.add('active');
            applyFilters();
        }

        function updateFilterBadges() {
            const badges = [];
            const month = document.getElementById('monthFilter').value;
            const dest = document.getElementById('destFilter').value;
            const vendor = document.getElementById('vendorFilter').value;
            const status = document.getElementById('statusFilter').value;
            const quick = document.getElementById('quickDateFilter').value;
            const factory = document.querySelector('#factoryFilter .filter-chip.active')?.dataset.factory;
            const search = document.getElementById('searchInput').value;

            if (month) badges.push({ label: `ì›”: ${month}`, filter: 'monthFilter' });
            if (dest) badges.push({ label: `í–‰ì„ ì§€: ${dest}`, filter: 'destFilter' });
            if (vendor) badges.push({ label: `ë²¤ë”: ${vendor}`, filter: 'vendorFilter' });
            if (status) badges.push({ label: `ìƒíƒœ: ${status}`, filter: 'statusFilter' });
            if (quick) badges.push({ label: `ê¸°ê°„: ${quick}`, filter: 'quickDateFilter' });
            if (factory) badges.push({ label: `ê³µì¥: ${factory}`, filter: 'factoryFilter' });
            if (search) badges.push({ label: `ê²€ìƒ‰: ${search}`, filter: 'searchInput' });

            const container = document.getElementById('filterBadges');
            const section = document.getElementById('activeFilters');

            if (badges.length > 0) {
                section.classList.remove('hidden');
                container.innerHTML = badges.map(b =>
                    `<span class="filter-badge">${b.label}<button onclick="clearFilter('${b.filter}')">&times;</button></span>`
                ).join('');
            } else {
                section.classList.add('hidden');
            }
        }

        function clearFilter(filterId) {
            if (filterId === 'factoryFilter') {
                document.querySelectorAll('#factoryFilter .filter-chip').forEach(c => c.classList.remove('active'));
                document.querySelector('#factoryFilter .filter-chip[data-factory=""]').classList.add('active');
            } else {
                document.getElementById(filterId).value = '';
            }
            applyFilters();
        }

        function isDelayed(d) {
            if (!d.sddValue || d.sddValue === '00:00:00') return false;
            const whOutCompleted = d.production?.wh_out?.completed || 0;
            const qty = d.quantity || 0;
            if (whOutCompleted >= qty) return false;

            try {
                const sddDate = new Date(d.sddValue.replace(/\./g, '-'));
                return sddDate < TODAY;
            } catch { return false; }
        }

        function isToday(d) {
            if (!d.sddValue || d.sddValue === '00:00:00') return false;
            try {
                const sddDate = new Date(d.sddValue.replace(/\./g, '-'));
                return sddDate.toDateString() === TODAY.toDateString();
            } catch { return false; }
        }

        function applyFilters() {
            const month = document.getElementById('monthFilter').value;
            const dest = document.getElementById('destFilter').value;
            const vendor = document.getElementById('vendorFilter').value;
            const status = document.getElementById('statusFilter').value;
            const quick = document.getElementById('quickDateFilter').value;
            const factory = document.querySelector('#factoryFilter .filter-chip.active')?.dataset.factory || '';
            const search = document.getElementById('searchInput').value.toLowerCase();

            filteredData = allData.filter(d => {
                if (month && d.sddYearMonth !== month) return false;
                if (dest === 'asia' && !IMPORTANT_DESTINATIONS[d.destination]) return false;
                if (dest && dest !== 'asia' && d.destination !== dest) return false;
                if (vendor && d.outsoleVendor !== vendor) return false;
                if (factory && d.factory !== factory) return false;

                if (status) {
                    const s = d.production?.wh_out?.status;
                    if (status !== s) return false;
                }

                if (quick === 'delayed' && !isDelayed(d)) return false;
                if (quick === 'today' && !isToday(d)) return false;
                // Additional quick filters can be added here

                if (search) {
                    const searchFields = [d.model, d.destination, d.outsoleVendor, d.poNumber, d.factory].join(' ').toLowerCase();
                    if (!searchFields.includes(search)) return false;
                }

                return true;
            });

            currentPage = 1;
            updateFilterBadges();
            updateAll();
        }

        function updateAll() {
            updateAlertSection();
            updateAllCards();
            updateVendorSection();
            updateProcessProgress();
            updateFunnelChart();
            updateFactoryCards();
            updateFactoryRadar();
            updateAsiaCards();
            updateCrdSddComparison();
            updateTabs();
        }

        function updateAlertSection() {
            // Delayed orders
            const delayed = allData.filter(isDelayed);
            const delayedQty = delayed.reduce((sum, d) => sum + (d.quantity || 0), 0);

            // Today's orders
            const todayOrders = allData.filter(isToday);
            const todayQty = todayOrders.reduce((sum, d) => sum + (d.quantity || 0), 0);

            // Inventory (ì…ê³  - ì¶œê³ )
            let inventoryQty = 0;
            let inventoryOrderCount = 0;
            allData.forEach(d => {
                const whIn = d.production?.wh_in?.completed || 0;
                const whOut = d.production?.wh_out?.completed || 0;
                const diff = whIn - whOut;
                if (diff > 0) {
                    inventoryQty += diff;
                    inventoryOrderCount++;
                }
            });

            document.getElementById('delayedOrderCount').textContent = delayed.length + 'ê±´';
            document.getElementById('delayedOrderQty').textContent = formatNumber(delayedQty) + 'ì¡±';
            document.getElementById('todayOrderCount').textContent = todayOrders.length + 'ê±´';
            document.getElementById('todayOrderQty').textContent = formatNumber(todayQty) + 'ì¡±';
            document.getElementById('inventoryCount').textContent = formatNumber(inventoryQty) + 'ì¡±';
            document.getElementById('inventoryOrders').textContent = inventoryOrderCount + 'ê±´';

            // Show/hide alert section
            if (delayed.length > 0 || todayOrders.length > 0) {
                document.getElementById('alertSection').classList.remove('hidden');
                document.getElementById('delayAlert').classList.remove('hidden');
                document.getElementById('delayCount').textContent = delayed.length;
            }
        }

        function updateAllCards() {
            const totalQty = filteredData.reduce((sum, d) => sum + (d.quantity || 0), 0);
            const totalCompleted = filteredData.reduce((sum, d) => sum + (d.production?.wh_out?.completed || 0), 0);
            const rate = totalQty > 0 ? (totalCompleted / totalQty * 100) : 0;

            document.getElementById('totalOrders').textContent = formatNumber(filteredData.length);
            document.getElementById('totalQty').textContent = formatNumber(totalQty) + 'ì¡±';
            document.getElementById('totalCompleted').textContent = formatNumber(totalCompleted) + 'ì¡±';
            document.getElementById('totalRate').textContent = rate.toFixed(1) + '%';

            // Rate donut
            if (charts.rateDonut) charts.rateDonut.destroy();
            charts.rateDonut = new Chart(document.getElementById('rateDonut'), {
                type: 'doughnut',
                data: { datasets: [{ data: [rate, 100 - rate], backgroundColor: ['#8b5cf6', '#e5e7eb'], borderWidth: 0 }] },
                options: { cutout: '70%', plugins: { legend: { display: false } }, responsive: true, maintainAspectRatio: true }
            });
        }

        function updateFunnelChart() {
            const processData = {};
            PROCESS_ORDER.forEach(key => { processData[key] = { completed: 0, pending: 0, total: 0 }; });

            filteredData.forEach(d => {
                PROCESS_ORDER.forEach(key => {
                    const p = d.production?.[key];
                    if (p) {
                        processData[key].completed += p.completed || 0;
                        processData[key].pending += p.pending || 0;
                        processData[key].total += (p.completed || 0) + (p.pending || 0);
                    }
                });
            });

            const totalQty = filteredData.reduce((sum, d) => sum + (d.quantity || 0), 0);
            const container = document.getElementById('funnelChart');

            container.innerHTML = PROCESS_ORDER.map((key, i) => {
                const data = processData[key];
                const rate = data.total > 0 ? (data.completed / data.total * 100) : 0;
                const width = 100 - (i * 2);
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';

                return `<div class="funnel-step" style="background: linear-gradient(to right, ${color}40, ${color}20); width: ${width}%"
                    onclick="showProcessDetail('${key}')" title="${PROCESS_NAMES[key]}: ${rate.toFixed(1)}%">
                    <div class="text-xs font-medium">${PROCESS_NAMES[key]}</div>
                    <div class="text-lg font-bold" style="color: ${color}">${rate.toFixed(0)}%</div>
                    <div class="text-xs text-gray-500">${formatNumber(data.completed)}</div>
                </div>`;
            }).join('');
        }

        function updateProcessProgress() {
            const processData = {};
            PROCESS_ORDER.forEach(key => { processData[key] = { completed: 0, pending: 0 }; });

            filteredData.forEach(d => {
                PROCESS_ORDER.forEach(key => {
                    const p = d.production?.[key];
                    if (p) {
                        processData[key].completed += p.completed || 0;
                        processData[key].pending += p.pending || 0;
                    }
                });
            });

            const container = document.getElementById('processProgress');
            container.innerHTML = PROCESS_ORDER.map(key => {
                const data = processData[key];
                const total = data.completed + data.pending;
                const rate = total > 0 ? (data.completed / total * 100) : 0;
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';

                return `<div class="flex items-center gap-3 cursor-pointer hover:bg-gray-50 p-2 rounded" onclick="showProcessDetail('${key}')">
                    <div class="w-16 text-sm font-medium text-gray-600">${PROCESS_NAMES[key]}</div>
                    <div class="flex-1 progress-bar"><div class="progress-fill" style="width: ${rate}%; background: ${color};"></div></div>
                    <div class="w-24 text-right text-sm"><span class="font-medium" style="color: ${color}">${rate.toFixed(1)}%</span> <span class="text-gray-400">(${formatNumber(data.completed)})</span></div>
                </div>`;
            }).join('');
        }

        function updateVendorSection() {
            const vendorData = {};
            let totalQty = 0;

            filteredData.forEach(d => {
                const v = d.outsoleVendor || '(ë¯¸ì§€ì •)';
                if (!vendorData[v]) vendorData[v] = { count: 0, qty: 0, completed: 0 };
                vendorData[v].count++;
                vendorData[v].qty += d.quantity || 0;
                vendorData[v].completed += d.production?.wh_out?.completed || 0;
                totalQty += d.quantity || 0;
            });

            const sorted = Object.entries(vendorData).sort((a, b) => b[1].qty - a[1].qty);
            const totalCount = filteredData.length;

            // Chart
            if (charts.vendor) charts.vendor.destroy();
            const top6 = sorted.slice(0, 6);
            charts.vendor = new Chart(document.getElementById('vendorChart'), {
                type: 'doughnut',
                data: {
                    labels: top6.map(([v]) => v.substring(0, 12)),
                    datasets: [{ data: top6.map(([, d]) => d.qty), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899'] }]
                },
                options: { plugins: { legend: { position: 'right' } }, responsive: true, maintainAspectRatio: false }
            });

            // Table
            document.getElementById('vendorTableBody').innerHTML = sorted.map(([vendor, data]) => {
                const countPct = (data.count / totalCount * 100).toFixed(1);
                const qtyPct = (data.qty / totalQty * 100).toFixed(1);
                return `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="showVendorDetail('${vendor}')">
                    <td class="px-3 py-2 text-xs">${vendor}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-3 py-2 text-right text-gray-500">${countPct}%</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-3 py-2 text-right text-gray-500">${qtyPct}%</td>
                </tr>`;
            }).join('');

            updateVendorMonthHeatmap(sorted);
        }

        function updateVendorMonthHeatmap(sortedVendors) {
            const months = [...new Set(filteredData.map(d => d.sddYearMonth).filter(Boolean))].sort();
            const vendorMonthData = {};

            filteredData.forEach(d => {
                const v = d.outsoleVendor || '(ë¯¸ì§€ì •)';
                const m = d.sddYearMonth;
                if (m) {
                    const key = `${v}|${m}`;
                    vendorMonthData[key] = (vendorMonthData[key] || 0) + (d.quantity || 0);
                }
            });

            const topVendors = sortedVendors.slice(0, 8).map(([v]) => v);

            let html = '<table class="text-xs w-full"><thead><tr><th class="px-2 py-1 text-left">Vendor</th>';
            months.forEach(m => html += `<th class="px-2 py-1 text-center">${m}</th>`);
            html += '<th class="px-2 py-1 text-right">í•©ê³„</th></tr></thead><tbody>';

            topVendors.forEach(v => {
                let rowTotal = 0;
                html += `<tr class="border-b hover:bg-gray-50"><td class="px-2 py-1 font-medium">${v.substring(0, 15)}</td>`;
                months.forEach(m => {
                    const val = vendorMonthData[`${v}|${m}`] || 0;
                    rowTotal += val;
                    const intensity = Math.min(val / 100000, 1);
                    const bg = val > 0 ? `rgba(59, 130, 246, ${intensity})` : '#f9fafb';
                    html += `<td class="px-2 py-1 text-center" style="background: ${bg}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                });
                html += `<td class="px-2 py-1 text-right font-medium">${formatNumber(rowTotal)}</td></tr>`;
            });
            html += '</tbody></table>';

            document.getElementById('vendorMonthHeatmap').innerHTML = html;
        }

        function updateFactoryCards() {
            const factoryData = { A: { qty: 0, completed: 0, count: 0 }, B: { qty: 0, completed: 0, count: 0 }, C: { qty: 0, completed: 0, count: 0 }, D: { qty: 0, completed: 0, count: 0 } };

            filteredData.forEach(d => {
                if (!factoryData[d.factory]) return;
                factoryData[d.factory].qty += d.quantity || 0;
                factoryData[d.factory].completed += d.production?.wh_out?.completed || 0;
                factoryData[d.factory].count++;
            });

            document.getElementById('factoryCards').innerHTML = ['A', 'B', 'C', 'D'].map(f => {
                const d = factoryData[f];
                const rate = d.qty > 0 ? (d.completed / d.qty * 100) : 0;
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';
                return `<div class="p-3 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="showFactoryDetail('${f}')">
                    <div class="flex justify-between items-center">
                        <span class="font-semibold">Factory ${f}</span>
                        <span class="text-sm font-medium" style="color: ${color}">${rate.toFixed(1)}%</span>
                    </div>
                    <div class="text-xs text-gray-500 mt-1">${formatNumber(d.count)}ê±´ Â· ${formatNumber(d.qty)}ì¡±</div>
                    <div class="progress-bar mt-2" style="height: 8px;"><div class="progress-fill" style="width: ${rate}%; background: ${color};"></div></div>
                </div>`;
            }).join('');
        }

        function updateFactoryRadar() {
            const factoryProcessData = { A: {}, B: {}, C: {}, D: {} };

            filteredData.forEach(d => {
                if (!factoryProcessData[d.factory]) return;
                PROCESS_ORDER.forEach(key => {
                    if (!factoryProcessData[d.factory][key]) factoryProcessData[d.factory][key] = { completed: 0, total: 0 };
                    const p = d.production?.[key];
                    if (p) {
                        factoryProcessData[d.factory][key].completed += p.completed || 0;
                        factoryProcessData[d.factory][key].total += (p.completed || 0) + (p.pending || 0);
                    }
                });
            });

            const labels = PROCESS_ORDER.map(k => PROCESS_NAMES[k]);
            const colors = { A: '#3b82f6', B: '#10b981', C: '#f59e0b', D: '#ef4444' };

            const datasets = ['A', 'B', 'C', 'D'].map(f => ({
                label: `Factory ${f}`,
                data: PROCESS_ORDER.map(k => {
                    const d = factoryProcessData[f][k];
                    return d && d.total > 0 ? (d.completed / d.total * 100) : 0;
                }),
                borderColor: colors[f],
                backgroundColor: colors[f] + '20',
                borderWidth: 2
            }));

            if (charts.factoryRadar) charts.factoryRadar.destroy();
            charts.factoryRadar = new Chart(document.getElementById('factoryRadar'), {
                type: 'radar',
                data: { labels, datasets },
                options: {
                    scales: { r: { beginAtZero: true, max: 100 } },
                    plugins: { legend: { position: 'bottom', labels: { boxWidth: 12, font: { size: 10 } } } },
                    responsive: true, maintainAspectRatio: false
                }
            });
        }

        function updateAsiaCards() {
            const asiaData = {};
            filteredData.forEach(d => {
                let country = null;
                if (d.destination === 'Japan') country = 'Japan';
                else if (d.destination === 'South Korea' || d.destination === 'Korea') country = 'South Korea';
                else if (d.destination === 'China') country = 'China';
                else if (d.destination === 'Taiwan') country = 'Taiwan';
                else if (d.destination === 'India') country = 'India';

                if (country) {
                    if (!asiaData[country]) asiaData[country] = { qty: 0, completed: 0, count: 0 };
                    asiaData[country].qty += d.quantity || 0;
                    asiaData[country].completed += d.production?.wh_out?.completed || 0;
                    asiaData[country].count++;
                }
            });

            const displayNames = { 'Japan': 'ì¼ë³¸', 'South Korea': 'í•œêµ­', 'China': 'ì¤‘êµ­', 'Taiwan': 'ëŒ€ë§Œ', 'India': 'ì¸ë„' };
            const displayOrder = ['Japan', 'South Korea', 'China', 'Taiwan', 'India'];

            document.getElementById('asiaCards').innerHTML = displayOrder.map(country => {
                const data = asiaData[country] || { qty: 0, completed: 0, count: 0 };
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                const color = rate >= 80 ? '#22c55e' : rate >= 50 ? '#f59e0b' : '#ef4444';
                return `<div class="asia-highlight p-4 rounded-xl cursor-pointer hover:shadow-md transition" onclick="showCountryDetail('${country}')">
                    <div class="text-2xl mb-1">${IMPORTANT_DESTINATIONS[country]}</div>
                    <div class="font-medium">${displayNames[country]}</div>
                    <div class="text-sm text-gray-600">${formatNumber(data.qty)}ì¡± Â· ${data.count}ê±´</div>
                    <div class="progress-bar mt-2" style="height: 6px;"><div class="progress-fill" style="width: ${rate}%; background: ${color};"></div></div>
                    <div class="text-xs text-right mt-1" style="color: ${color}">${rate.toFixed(1)}%</div>
                </div>`;
            }).join('');
        }

        function updateCrdSddComparison() {
            const monthData = {};
            filteredData.forEach(d => {
                if (d.crdYearMonth) {
                    if (!monthData[d.crdYearMonth]) monthData[d.crdYearMonth] = { crd: 0, sdd: 0 };
                    monthData[d.crdYearMonth].crd += d.quantity || 0;
                }
                if (d.sddYearMonth) {
                    if (!monthData[d.sddYearMonth]) monthData[d.sddYearMonth] = { crd: 0, sdd: 0 };
                    monthData[d.sddYearMonth].sdd += d.quantity || 0;
                }
            });

            const allMonths = Object.keys(monthData).sort();

            // Chart
            if (charts.crdSdd) charts.crdSdd.destroy();
            charts.crdSdd = new Chart(document.getElementById('crdSddChart'), {
                type: 'bar',
                data: {
                    labels: allMonths,
                    datasets: [
                        { label: 'CRD', data: allMonths.map(m => monthData[m]?.crd || 0), backgroundColor: '#3b82f6' },
                        { label: 'SDD', data: allMonths.map(m => monthData[m]?.sdd || 0), backgroundColor: '#10b981' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'top' } } }
            });

            // Table
            document.getElementById('crdSddTableBody').innerHTML = allMonths.map(month => {
                const d = monthData[month];
                const diff = d.crd - d.sdd;
                const status = diff > 0 ? 'âš ï¸ ì•ë‹¹ê¹€' : diff < 0 ? 'ğŸ”„ ì§€ì—°' : 'âœ… ì¼ì¹˜';
                return `<tr class="border-b"><td class="px-3 py-2">${month}</td><td class="px-3 py-2 text-right">${formatNumber(d.crd)}</td><td class="px-3 py-2 text-right">${formatNumber(d.sdd)}</td><td class="px-3 py-2 text-right ${diff > 0 ? 'text-orange-600' : diff < 0 ? 'text-blue-600' : ''}">${diff > 0 ? '+' : ''}${formatNumber(diff)}</td><td class="px-3 py-2 text-center">${status}</td></tr>`;
            }).join('');
        }

        function updateTabs() { updateMonthlyTab(); updateDestinationTab(); updateModelTab(); updateFactoryTab(); updateVendorTab(); updateHeatmapTab(); updateDataTab(); }

        function updateMonthlyTab() {
            const monthlyData = {};
            filteredData.forEach(d => {
                if (!d.sddYearMonth) return;
                if (!monthlyData[d.sddYearMonth]) monthlyData[d.sddYearMonth] = { qty: 0, completed: 0, count: 0 };
                monthlyData[d.sddYearMonth].qty += d.quantity || 0;
                monthlyData[d.sddYearMonth].completed += d.production?.wh_out?.completed || 0;
                monthlyData[d.sddYearMonth].count++;
            });

            const months = Object.keys(monthlyData).sort();

            if (charts.monthly) charts.monthly.destroy();
            charts.monthly = new Chart(document.getElementById('monthlyChart'), {
                type: 'bar',
                data: {
                    labels: months,
                    datasets: [
                        { label: 'ì£¼ë¬¸ëŸ‰', data: months.map(m => monthlyData[m].qty), backgroundColor: '#3b82f6' },
                        { label: 'ì™„ë£ŒëŸ‰', data: months.map(m => monthlyData[m].completed), backgroundColor: '#10b981' }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    onClick: (e, elements) => {
                        if (elements.length > 0) {
                            const month = months[elements[0].index];
                            document.getElementById('monthFilter').value = month;
                            applyFilters();
                        }
                    }
                }
            });

            document.querySelector('#monthlyTable tbody').innerHTML = months.map(m => {
                const d = monthlyData[m];
                const rate = d.qty > 0 ? (d.completed / d.qty * 100) : 0;
                return `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="document.getElementById('monthFilter').value='${m}';applyFilters();">
                    <td class="px-4 py-2">${m}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(d.count)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(d.qty)}</td>
                    <td class="px-4 py-2 text-right text-green-600">${formatNumber(d.completed)}</td>
                    <td class="px-4 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        function updateDestinationTab() {
            const destData = {};
            filteredData.forEach(d => {
                if (!d.destination) return;
                if (!destData[d.destination]) destData[d.destination] = { qty: 0, completed: 0, count: 0 };
                destData[d.destination].qty += d.quantity || 0;
                destData[d.destination].completed += d.production?.wh_out?.completed || 0;
                destData[d.destination].count++;
            });

            const sorted = Object.entries(destData).sort((a, b) => b[1].qty - a[1].qty);
            const top10 = sorted.slice(0, 10);

            if (charts.dest) charts.dest.destroy();
            charts.dest = new Chart(document.getElementById('destChart'), {
                type: 'doughnut',
                data: {
                    labels: top10.map(([d]) => d),
                    datasets: [{ data: top10.map(([, d]) => d.qty), backgroundColor: ['#3b82f6', '#10b981', '#f59e0b', '#ef4444', '#8b5cf6', '#ec4899', '#06b6d4', '#84cc16', '#f97316', '#6366f1'] }]
                },
                options: { plugins: { legend: { position: 'right' } }, responsive: true, maintainAspectRatio: false }
            });

            document.querySelector('#destTable tbody').innerHTML = sorted.map(([dest, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                const flag = IMPORTANT_DESTINATIONS[dest] || '';
                return `<tr class="border-b hover:bg-gray-50 clickable-row" onclick="showCountryDetail('${dest}')">
                    <td class="px-4 py-2">${flag} ${dest}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.completed)}</td>
                    <td class="px-4 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        function updateModelTab() {
            const modelData = {};
            filteredData.forEach(d => {
                if (!d.model) return;
                if (!modelData[d.model]) modelData[d.model] = { qty: 0, completed: 0, count: 0 };
                modelData[d.model].qty += d.quantity || 0;
                modelData[d.model].completed += d.production?.wh_out?.completed || 0;
                modelData[d.model].count++;
            });

            const sorted = Object.entries(modelData).sort((a, b) => b[1].qty - a[1].qty);
            const top15 = sorted.slice(0, 15);

            if (charts.model) charts.model.destroy();
            charts.model = new Chart(document.getElementById('modelChart'), {
                type: 'bar',
                data: {
                    labels: top15.map(([m]) => m.substring(0, 15)),
                    datasets: [{ label: 'ìˆ˜ëŸ‰', data: top15.map(([, d]) => d.qty), backgroundColor: '#3b82f6' }]
                },
                options: { indexAxis: 'y', responsive: true, maintainAspectRatio: false }
            });

            document.querySelector('#modelTable tbody').innerHTML = sorted.slice(0, 30).map(([model, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                return `<tr class="border-b hover:bg-gray-50 clickable-row" onclick="showModelDetail('${model}')">
                    <td class="px-4 py-2 text-xs">${model}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-4 py-2 text-right">${formatNumber(data.completed)}</td>
                    <td class="px-4 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        function updateFactoryTab() {
            const factoryData = {};
            filteredData.forEach(d => {
                if (!factoryData[d.factory]) factoryData[d.factory] = { qty: 0, completed: 0, count: 0 };
                factoryData[d.factory].qty += d.quantity || 0;
                factoryData[d.factory].completed += d.production?.wh_out?.completed || 0;
                factoryData[d.factory].count++;
            });

            if (charts.factory) charts.factory.destroy();
            charts.factory = new Chart(document.getElementById('factoryChart'), {
                type: 'bar',
                data: {
                    labels: ['A', 'B', 'C', 'D'],
                    datasets: [
                        { label: 'ì£¼ë¬¸ëŸ‰', data: ['A', 'B', 'C', 'D'].map(f => factoryData[f]?.qty || 0), backgroundColor: '#3b82f6' },
                        { label: 'ì™„ë£ŒëŸ‰', data: ['A', 'B', 'C', 'D'].map(f => factoryData[f]?.completed || 0), backgroundColor: '#10b981' }
                    ]
                },
                options: { responsive: true, maintainAspectRatio: false }
            });

            let html = '';
            ['A', 'B', 'C', 'D'].forEach(f => {
                const fData = filteredData.filter(d => d.factory === f);
                const totalQty = fData.reduce((sum, d) => sum + (d.quantity || 0), 0);
                const whOutCompleted = fData.reduce((sum, d) => sum + (d.production?.wh_out?.completed || 0), 0);
                const rate = totalQty > 0 ? (whOutCompleted / totalQty * 100) : 0;
                html += `<div class="p-4 bg-gray-50 rounded-lg cursor-pointer hover:bg-gray-100" onclick="showFactoryDetail('${f}')">
                    <div class="flex justify-between items-center mb-2"><span class="font-semibold">Factory ${f}</span><span class="text-sm" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}% ì™„ë£Œ</span></div>
                    <div class="text-sm text-gray-600">${formatNumber(fData.length)}ê±´ Â· ${formatNumber(totalQty)}ì¡±</div>
                </div>`;
            });
            document.getElementById('factoryProcessDetail').innerHTML = html;
        }

        function updateVendorTab() {
            const vendorData = {};
            filteredData.forEach(d => {
                const v = d.outsoleVendor || '(ë¯¸ì§€ì •)';
                if (!vendorData[v]) vendorData[v] = { count: 0, qty: 0, completed: 0, factories: {} };
                vendorData[v].count++;
                vendorData[v].qty += d.quantity || 0;
                vendorData[v].completed += d.production?.wh_out?.completed || 0;
                vendorData[v].factories[d.factory] = (vendorData[v].factories[d.factory] || 0) + (d.quantity || 0);
            });

            const sorted = Object.entries(vendorData).sort((a, b) => b[1].qty - a[1].qty);

            // Matrix
            let matrixHtml = '<table class="text-xs w-full"><thead><tr><th class="px-2 py-1 text-left">Vendor</th><th class="px-2 py-1 text-right">A</th><th class="px-2 py-1 text-right">B</th><th class="px-2 py-1 text-right">C</th><th class="px-2 py-1 text-right">D</th><th class="px-2 py-1 text-right">í•©ê³„</th></tr></thead><tbody>';
            sorted.slice(0, 10).forEach(([vendor, data]) => {
                matrixHtml += `<tr class="border-b hover:bg-gray-50"><td class="px-2 py-1">${vendor.substring(0, 15)}</td>`;
                ['A', 'B', 'C', 'D'].forEach(f => {
                    const val = data.factories[f] || 0;
                    matrixHtml += `<td class="px-2 py-1 text-right">${val > 0 ? formatNumber(val) : '-'}</td>`;
                });
                matrixHtml += `<td class="px-2 py-1 text-right font-medium">${formatNumber(data.qty)}</td></tr>`;
            });
            matrixHtml += '</tbody></table>';
            document.getElementById('vendorFactoryMatrix').innerHTML = matrixHtml;

            // Detail table
            document.querySelector('#vendorDetailTable tbody').innerHTML = sorted.map(([vendor, data]) => {
                const rate = data.qty > 0 ? (data.completed / data.qty * 100) : 0;
                return `<tr class="border-b hover:bg-gray-50 cursor-pointer" onclick="showVendorDetail('${vendor}')">
                    <td class="px-3 py-2 text-xs">${vendor}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.count)}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.qty)}</td>
                    <td class="px-3 py-2 text-right">${formatNumber(data.completed)}</td>
                    <td class="px-3 py-2 text-right font-medium" style="color: ${rate >= 80 ? '#22c55e' : '#f59e0b'}">${rate.toFixed(1)}%</td>
                </tr>`;
            }).join('');
        }

        function updateHeatmapTab() {
            const sddMonths = [...new Set(filteredData.map(d => d.sddYearMonth).filter(Boolean))].sort();
            const importantCountries = ['Japan', 'South Korea', 'China', 'Taiwan', 'India'];
            const displayNames = { 'Japan': 'ì¼ë³¸', 'South Korea': 'í•œêµ­', 'China': 'ì¤‘êµ­', 'Taiwan': 'ëŒ€ë§Œ', 'India': 'ì¸ë„' };

            const countryMonthData = {};
            filteredData.forEach(d => {
                let country = null;
                if (d.destination === 'Japan') country = 'Japan';
                else if (d.destination === 'South Korea' || d.destination === 'Korea') country = 'South Korea';
                else if (d.destination === 'China') country = 'China';
                else if (d.destination === 'Taiwan') country = 'Taiwan';
                else if (d.destination === 'India') country = 'India';
                if (country && d.sddYearMonth) countryMonthData[`${country}|${d.sddYearMonth}`] = (countryMonthData[`${country}|${d.sddYearMonth}`] || 0) + (d.quantity || 0);
            });

            let html2 = '<table class="text-xs"><thead><tr><th class="px-2 py-1"></th>';
            sddMonths.forEach(m => html2 += `<th class="px-2 py-1 text-center">${m}</th>`);
            html2 += '</tr></thead><tbody>';
            importantCountries.forEach(c => {
                html2 += `<tr><td class="px-2 py-1 font-medium">${IMPORTANT_DESTINATIONS[c]} ${displayNames[c]}</td>`;
                sddMonths.forEach(m => {
                    const val = countryMonthData[`${c}|${m}`] || 0;
                    const intensity = Math.min(val / 50000, 1);
                    const bg = val > 0 ? `rgba(16, 185, 129, ${intensity})` : '#f3f4f6';
                    html2 += `<td class="px-2 py-1 text-center" style="background: ${bg}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                });
                html2 += '</tr>';
            });
            html2 += '</tbody></table>';
            document.getElementById('countryMonthHeatmap').innerHTML = html2;

            // Model Ã— Destination heatmap
            const topModels = [...new Set(filteredData.map(d => d.model))].slice(0, 10);
            const topDests = [...new Set(filteredData.map(d => d.destination))].slice(0, 8);
            const modelDestData = {};
            filteredData.forEach(d => {
                if (!d.model || !d.destination) return;
                const key = `${d.model}|${d.destination}`;
                modelDestData[key] = (modelDestData[key] || 0) + (d.quantity || 0);
            });

            let html1 = '<table class="text-xs"><thead><tr><th class="px-2 py-1"></th>';
            topDests.forEach(d => html1 += `<th class="px-2 py-1 text-center">${d.substring(0, 10)}</th>`);
            html1 += '</tr></thead><tbody>';
            topModels.forEach(m => {
                html1 += `<tr><td class="px-2 py-1 font-medium">${m.substring(0, 20)}</td>`;
                topDests.forEach(d => {
                    const val = modelDestData[`${m}|${d}`] || 0;
                    const intensity = Math.min(val / 10000, 1);
                    const bg = val > 0 ? `rgba(59, 130, 246, ${intensity})` : '#f3f4f6';
                    html1 += `<td class="px-2 py-1 text-center" style="background: ${bg}">${val > 0 ? formatNumber(val) : '-'}</td>`;
                });
                html1 += '</tr>';
            });
            html1 += '</tbody></table>';
            document.getElementById('modelDestHeatmap').innerHTML = html1;
        }

        function updateDataTab() {
            // Sort if needed
            let sortedData = [...filteredData];
            if (sortState.column) {
                sortedData.sort((a, b) => {
                    let aVal, bVal;
                    switch (sortState.column) {
                        case 'factory': aVal = a.factory; bVal = b.factory; break;
                        case 'model': aVal = a.model || ''; bVal = b.model || ''; break;
                        case 'destination': aVal = a.destination || ''; bVal = b.destination || ''; break;
                        case 'quantity': aVal = a.quantity || 0; bVal = b.quantity || 0; break;
                        case 'sdd': aVal = a.sddYearMonth || ''; bVal = b.sddYearMonth || ''; break;
                        default: return 0;
                    }
                    if (typeof aVal === 'number') return sortState.direction === 'asc' ? aVal - bVal : bVal - aVal;
                    return sortState.direction === 'asc' ? aVal.localeCompare(bVal) : bVal.localeCompare(aVal);
                });
            }

            const totalPages = Math.ceil(sortedData.length / pageSize);
            const start = (currentPage - 1) * pageSize;
            const pageData = sortedData.slice(start, start + pageSize);

            document.getElementById('dataCount').textContent = `(${formatNumber(filteredData.length)}ê±´)`;
            document.getElementById('pagination').textContent = `${currentPage} / ${totalPages} í˜ì´ì§€`;
            document.getElementById('prevBtn').disabled = currentPage <= 1;
            document.getElementById('nextBtn').disabled = currentPage >= totalPages;

            const tbody = document.querySelector('#dataTable tbody');
            tbody.innerHTML = pageData.map(d => {
                const getIcon = (status) => status === 'completed' ? 'âœ…' : status === 'partial' ? 'ğŸ”¶' : 'â³';
                const delayed = isDelayed(d);
                const rowClass = delayed ? 'bg-red-50' : '';

                return `<tr class="border-b hover:bg-gray-50 ${rowClass}">
                    <td class="px-2 py-2">${d.factory}</td>
                    <td class="px-2 py-2 text-xs">${d.model?.substring(0, 20) || ''}</td>
                    <td class="px-2 py-2 text-xs">${d.destination || ''}</td>
                    <td class="px-2 py-2 text-xs">${d.outsoleVendor?.substring(0, 12) || '-'}</td>
                    <td class="px-2 py-2 text-right">${formatNumber(d.quantity || 0)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.s_cut?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.sew_bal?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.ass_bal?.status)}</td>
                    <td class="px-2 py-2 text-center">${getIcon(d.production?.wh_out?.status)}</td>
                    <td class="px-2 py-2 text-xs">${d.sddYearMonth || ''}</td>
                    <td class="px-2 py-2 text-center">${delayed ? 'ğŸš¨' : d.production?.wh_out?.status === 'completed' ? 'âœ…' : 'â³'}</td>
                </tr>`;
            }).join('');
        }

        function prevPage() { if (currentPage > 1) { currentPage--; updateDataTab(); } }
        function nextPage() { const totalPages = Math.ceil(filteredData.length / pageSize); if (currentPage < totalPages) { currentPage++; updateDataTab(); } }

        // Modal functions
        function showProcessDetail(processKey) {
            const incompleteOrders = filteredData.filter(d => {
                const p = d.production?.[processKey];
                return p && p.status !== 'completed';
            });
            showOrderListModal(`${PROCESS_NAMES[processKey]} ë¯¸ì™„ë£Œ ì˜¤ë”`, incompleteOrders);
        }

        function showDelayedOrders() {
            const delayed = allData.filter(isDelayed);
            showOrderListModal('ğŸš¨ ì§€ì—° ì˜¤ë”', delayed);
        }

        function showTodayOrders() {
            const today = allData.filter(isToday);
            showOrderListModal('ğŸ“… ì˜¤ëŠ˜ ì¶œê³  ì˜ˆì •', today);
        }

        function showInventoryOrders() {
            const inventory = allData.filter(d => {
                const whIn = d.production?.wh_in?.completed || 0;
                const whOut = d.production?.wh_out?.completed || 0;
                return whIn > whOut;
            });
            showOrderListModal('ğŸ“¦ ì°½ê³  ì¬ê³  ì˜¤ë”', inventory);
        }

        function showVendorDetail(vendor) {
            const orders = filteredData.filter(d => (d.outsoleVendor || '(ë¯¸ì§€ì •)') === vendor);
            showOrderListModal(`${vendor} ìƒì„¸`, orders);
        }

        function showFactoryDetail(factory) { showOrderListModal(`Factory ${factory} ìƒì„¸`, filteredData.filter(d => d.factory === factory)); }
        function showCountryDetail(country) {
            const orders = filteredData.filter(d => {
                if (country === 'South Korea') return d.destination === 'South Korea' || d.destination === 'Korea';
                return d.destination === country;
            });
            showOrderListModal(`${IMPORTANT_DESTINATIONS[country] || ''} ${country} ìƒì„¸`, orders);
        }
        function showModelDetail(model) { showOrderListModal(`${model} ìƒì„¸`, filteredData.filter(d => d.model === model)); }

        function showOrderListModal(title, orders) {
            document.getElementById('modalTitle').textContent = `${title} (${orders.length}ê±´)`;

            const totalQty = orders.reduce((sum, d) => sum + (d.quantity || 0), 0);
            const totalCompleted = orders.reduce((sum, d) => sum + (d.production?.wh_out?.completed || 0), 0);

            let html = `<div class="mb-4 p-3 bg-gray-50 rounded-lg">
                <div class="grid grid-cols-3 gap-4 text-center">
                    <div><div class="text-gray-500 text-xs">ì˜¤ë”</div><div class="font-bold">${formatNumber(orders.length)}ê±´</div></div>
                    <div><div class="text-gray-500 text-xs">ìˆ˜ëŸ‰</div><div class="font-bold">${formatNumber(totalQty)}ì¡±</div></div>
                    <div><div class="text-gray-500 text-xs">ì™„ë£Œ</div><div class="font-bold text-green-600">${formatNumber(totalCompleted)}ì¡±</div></div>
                </div>
            </div>`;

            html += '<div class="overflow-x-auto max-h-[400px]"><table class="w-full text-sm"><thead class="bg-gray-50"><tr><th class="px-2 py-2 text-left">ê³µì¥</th><th class="px-2 py-2 text-left">ëª¨ë¸</th><th class="px-2 py-2 text-left">í–‰ì„ ì§€</th><th class="px-2 py-2 text-left">Vendor</th><th class="px-2 py-2 text-right">ìˆ˜ëŸ‰</th><th class="px-2 py-2 text-center">ì¶œê³ </th></tr></thead><tbody>';
            orders.slice(0, 100).forEach(d => {
                const status = d.production?.wh_out?.status;
                const statusIcon = status === 'completed' ? 'âœ…' : status === 'partial' ? 'ğŸ”¶' : 'â³';
                const delayed = isDelayed(d);
                html += `<tr class="border-b ${delayed ? 'bg-red-50' : ''}"><td class="px-2 py-2">${d.factory}</td><td class="px-2 py-2 text-xs">${d.model?.substring(0, 20)}</td><td class="px-2 py-2 text-xs">${d.destination}</td><td class="px-2 py-2 text-xs">${d.outsoleVendor?.substring(0, 12) || '-'}</td><td class="px-2 py-2 text-right">${formatNumber(d.quantity)}</td><td class="px-2 py-2 text-center">${statusIcon}${delayed ? 'ğŸš¨' : ''}</td></tr>`;
            });
            if (orders.length > 100) html += `<tr><td colspan="6" class="px-2 py-2 text-center text-gray-500">... ì™¸ ${orders.length - 100}ê±´</td></tr>`;
            html += '</tbody></table></div>';

            document.getElementById('modalContent').innerHTML = html;
            document.getElementById('orderDetailModal').classList.remove('hidden');
        }

        function closeOrderModal() { document.getElementById('orderDetailModal').classList.add('hidden'); }

        function exportToExcel() {
            const exportData = filteredData.map(d => ({
                'ê³µì¥': d.factory,
                'ëª¨ë¸': d.model,
                'í–‰ì„ ì§€': d.destination,
                'Vendor': d.outsoleVendor || '',
                'ìˆ˜ëŸ‰': d.quantity,
                'CRDì›”': d.crdYearMonth,
                'SDDì›”': d.sddYearMonth,
                'SDD': d.sddValue,
                'ì¬ë‹¨ì™„ë£Œ': d.production?.s_cut?.completed || 0,
                'ì¬ë´‰ì™„ë£Œ': d.production?.sew_bal?.completed || 0,
                'ì¡°ë¦½ì™„ë£Œ': d.production?.ass_bal?.completed || 0,
                'ì°½ê³ ì…ê³ ': d.production?.wh_in?.completed || 0,
                'ì¶œê³ ì™„ë£Œ': d.production?.wh_out?.completed || 0,
                'ì§€ì—°': isDelayed(d) ? 'Y' : ''
            }));
            const ws = XLSX.utils.json_to_sheet(exportData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, 'Data');
            XLSX.writeFile(wb, `rachgia_dashboard_${new Date().toISOString().slice(0, 10)}.xlsx`);
        }

        function formatNumber(num) { return num.toLocaleString('ko-KR'); }
        function debounce(func, wait) { let timeout; return function(...args) { clearTimeout(timeout); timeout = setTimeout(() => func.apply(this, args), wait); }; }
        document.addEventListener('keydown', (e) => { if (e.key === 'Escape') closeOrderModal(); });
    </script>
</body>
</html>
